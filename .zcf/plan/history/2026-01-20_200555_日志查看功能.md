# 日志查看功能实现计划

## 任务描述

app的debugprint产生的日志保存下来，可以在设置页面查看和复制还有清空

## 需求确认

- **日志保存**: 持久化存储，最多1000条，FIFO自动清理
- **日志格式**: `[时间戳] 日志内容`
- **UI功能**: 设置页面：查看/全选复制/清空
- **日志级别**: 暂不区分
- **持久化**: APP重启后保留

## 技术方案

**方案1**: SharedPreferences + 内存队列（已选择）

### 架构设计

```
debugPrint → LoggerService → 内存队列(1000条) → SharedPreferences持久化
                                      ↓
                            设置页面查看日志
```

## 实施步骤

### 阶段1: 创建LoggerService核心服务

**新建文件**: `lib/services/logger_service.dart`

**类结构**:
```dart
class LoggerService {
  // 单例模式
  static final LoggerService _instance = LoggerService._internal();
  static LoggerService get instance => _instance;

  // 常量
  static const int _maxLogs = 1000;
  static const String _prefsKey = 'app_logs';

  // 状态
  final List<LogEntry> _logs = [];
  bool _initialized = false;

  // 方法
  Future<void> init()              // 初始化
  void log(String message)         // 记录日志
  List<LogEntry> getLogs()         // 获取日志
  Future<void> clearLogs()         // 清空日志
  Future<void> _persistLogs()      // 持久化
  Future<void> _loadLogs()         // 加载日志
}

class LogEntry {
  final DateTime timestamp;
  final String message;

  LogEntry({required this.timestamp, required this.message});

  Map<String, dynamic> toMap() {
    return {'timestamp': timestamp.millisecondsSinceEpoch, 'message': message};
  }

  factory LogEntry.fromMap(Map<String, dynamic> map) {
    return LogEntry(
      timestamp: DateTime.fromMillisecondsSinceEpoch(map['timestamp']),
      message: map['message'],
    );
  }
}
```

**预期结果**: 单例日志服务，支持内存队列管理

---

### 阶段2: 实现日志持久化

**修改文件**: `lib/services/logger_service.dart`

**持久化逻辑**:
```dart
Future<void> _persistLogs() async {
  final prefs = await SharedPreferences.getInstance();
  final logsJson = jsonEncode(_logs.map((e) => e.toMap()).toList());
  await prefs.setString(_prefsKey, logsJson);
}

Future<void> _loadLogs() async {
  final prefs = await SharedPreferences.getInstance();
  final logsJson = prefs.getString(_prefsKey);

  if (logsJson != null) {
    final List<dynamic> decoded = jsonDecode(logsJson);
    _logs.addAll(decoded.map((e) => LogEntry.fromMap(e)));
  }
}
```

**预期结果**: 日志可持久化到SharedPreferences，APP重启后恢复

---

### 阶段3: 创建LogViewerScreen日志查看页面

**新建文件**: `lib/screens/log_viewer_screen.dart`

**UI结构**:
```dart
class LogViewerScreen extends StatefulWidget {
  const LogViewerScreen({super.key});

  @override
  State<LogViewerScreen> createState() => _LogViewerScreenState();
}

class _LogViewerScreenState extends State<LogViewerScreen> {
  late List<LogEntry> _logs;

  @override
  void initState() {
    super.initState();
    _loadLogs();
  }

  void _loadLogs() {
    setState(() {
      _logs = LoggerService.instance.getLogs();
    });
  }

  void _copyAllLogs() async {
    final text = _logs
        .map((log) => '[${_formatTimestamp(log.timestamp)}] ${log.message}')
        .join('\n');

    await Clipboard.setData(ClipboardData(text: text));

    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('已复制 ${_logs.length} 条日志')),
      );
    }
  }

  Future<void> _clearLogs() async {
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('确认清空'),
        content: Text('确定要清空所有日志吗？此操作不可撤销。'),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context, false), child: Text('取消')),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: Text('清空', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );

    if (confirmed == true) {
      await LoggerService.instance.clearLogs();
      _loadLogs();

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('日志已清空')),
        );
      }
    }
  }

  String _formatTimestamp(DateTime dt) {
    return '${dt.year}-${dt.month.toString().padLeft(2, '0')}-${dt.day.toString().padLeft(2, '0')} '
           '${dt.hour.toString().padLeft(2, '0')}:${dt.minute.toString().padLeft(2, '0')}:'
           '${dt.second.toString().padLeft(2, '0')}';
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('应用日志'),
        actions: [
          IconButton(icon: Icon(Icons.copy), onPressed: _copyAllLogs, tooltip: '复制全部'),
          IconButton(icon: Icon(Icons.delete), onPressed: _clearLogs, tooltip: '清空日志'),
        ],
      ),
      body: _logs.isEmpty
          ? Center(child: Text('暂无日志', style: TextStyle(color: Colors.grey)))
          : ListView.builder(
              itemCount: _logs.length,
              reverse: true,  // 最新日志在上
              itemBuilder: (context, index) {
                final log = _logs[_logs.length - 1 - index];
                return ListTile(
                  dense: true,
                  leading: Icon(Icons.bug_report_outlined, size: 16, color: Colors.grey),
                  title: Text(log.message, style: TextStyle(fontSize: 12)),
                  subtitle: Text(_formatTimestamp(log.timestamp), style: TextStyle(fontSize: 10)),
                );
              },
            ),
    );
  }
}
```

**预期结果**: 完整的日志查看页面，支持查看/复制/清空

---

### 阶段4: 在设置页面添加入口

**修改文件**: `lib/screens/settings_screen.dart`

在现有设置项后添加:

```dart
ListTile(
  leading: Icon(Icons.bug_report_outlined),
  title: Text('应用日志'),
  subtitle: Text('查看、复制或清空应用日志'),
  trailing: Icon(Icons.chevron_right),
  onTap: () {
    Navigator.push(
      context,
      MaterialPageRoute(builder: (_) => const LogViewerScreen()),
    );
  },
),
```

**预期结果**: 设置页面可导航到日志查看页面

---

### 阶段5: 编写单元测试

**新建文件**: `test/unit/services/logger_service_test.dart`

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:novel_app/services/logger_service.dart';

void main() {
  group('LoggerService', () {
    setUp(() async {
      // 重置SharedPreferences
      SharedPreferences.setMockInitialValues({});
    });

    test('初始化应从SharedPreferences加载日志', () async {
      final prefs = await SharedPreferences.getInstance();

      // 预设日志数据
      final testData = [
        {'timestamp': 1737371415000, 'message': 'Test message 1'},
        {'timestamp': 1737371416000, 'message': 'Test message 2'},
      ];
      await prefs.setString('app_logs', jsonEncode(testData));

      // 初始化服务
      await LoggerService.instance.init();

      final logs = LoggerService.instance.getLogs();
      expect(logs.length, 2);
      expect(logs[0].message, 'Test message 1');
    });

    test('log()应添加日志到内存队列', () {
      LoggerService.instance.log('New log message');

      final logs = LoggerService.instance.getLogs();
      expect(logs.last.message, 'New log message');
    });

    test('log()超过1000条时应删除最旧的日志', () async {
      // 添加超过1000条日志
      for (int i = 0; i < 1001; i++) {
        LoggerService.instance.log('Log $i');
      }

      final logs = LoggerService.instance.getLogs();
      expect(logs.length, 1000);
      expect(logs.first.message, 'Log 1');  // 第一条被删除
      expect(logs.last.message, 'Log 1000');
    });

    test('clearLogs()应清空所有日志', () async {
      LoggerService.instance.log('Test log');
      await LoggerService.instance.clearLogs();

      final logs = LoggerService.instance.getLogs();
      expect(logs.isEmpty, true);
    });
  });
}
```

**预期结果**: 核心功能有测试覆盖

---

## 文件变更清单

| 操作 | 文件路径 | 说明 |
|------|----------|------|
| **新建** | `lib/services/logger_service.dart` | 日志服务核心 |
| **新建** | `lib/screens/log_viewer_screen.dart` | 日志查看页面 |
| **修改** | `lib/screens/settings_screen.dart` | 添加日志入口 |
| **新建** | `test/unit/services/logger_service_test.dart` | 单元测试 |

---

## 技术细节

**日志格式**:
```
[2025-01-20 14:30:15] DatabaseService: 数据库升级完成
```

**SharedPreferences存储结构**:
```json
[
  {"timestamp": 1737371415000, "message": "DatabaseService: 数据库升级完成"},
  {"timestamp": 1737371416000, "message": "ReaderInteractionController: 获取选中文本 - 50字符"}
]
```

**复制格式**（纯文本）:
```
[2025-01-20 14:30:15] DatabaseService: 数据库升级完成
[2025-01-20 14:30:16] ReaderInteractionController: 获取选中文本 - 50字符
```

---

## 依赖项

无需添加新依赖，使用现有：
- `shared_preferences` - 已在项目中使用
- `flutter/services.dart` (Clipboard) - Flutter内置

---

## 创建时间

2025-01-20
