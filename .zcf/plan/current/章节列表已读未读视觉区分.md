# 章节列表已读/未读视觉区分功能

**任务描述**：章节列表中，已读章节需要和未读章节有视觉区分（字体颜色）

**创建时间**：2026-01-20 10:39:20

---

## 需求确认

- **已读定义**：打开过章节即算已读
- **视觉样式**：仅颜色区分（已读章节使用灰色）
- **历史数据**：全部标记为未读，重新记录

---

## 技术方案

**方案A**：在现有 `novel_chapters` 表中添加 `readAt` 字段（INTEGER，存储阅读时间戳）

### 数据库变更

```sql
-- 在 novel_chapters 表中添加字段
ALTER TABLE novel_chapters ADD COLUMN readAt INTEGER;
```

---

## 执行计划

### 步骤1：修改 Chapter 模型

**文件**：`novel_app/lib/models/chapter.dart`

**操作**：
- 添加 `readAt` 字段（`int?` 类型，可为null表示未读）
- 添加 `isRead` getter（`readAt != null`）
- 更新构造函数、`toMap`、`fromMap`、`copyWith`

**预期结果**：Chapter模型支持已读状态

---

### 步骤2：修改 DatabaseService

**文件**：`novel_app/lib/services/database_service.dart`

**操作**：
1. **添加数据库迁移**（在 `_onUpgrade` 方法中）：
   - 检查版本号，升级到 v11
   - 执行 `ALTER TABLE novel_chapters ADD COLUMN readAt INTEGER`

2. **添加标记已读方法**：
   ```dart
   Future<void> markChapterAsRead(String novelUrl, String chapterUrl)
   ```

3. **添加批量查询已读状态方法**：
   ```dart
   Future<Map<String, int?>> getChaptersReadStatus(String novelUrl, List<String> chapterUrls)
   ```

4. **修改章节查询**：确保 `novel_chapters` 表查询包含 `readAt` 字段

**预期结果**：数据库支持章节已读状态的存储和查询

---

### 步骤3：修改 ChapterTitle 组件

**文件**：`novel_app/lib/widgets/chapter_list/chapter_title.dart`

**操作**：
- 添加 `isRead` 参数
- 修改样式逻辑：已读章节使用 `Colors.grey`，未读章节保持原色

**预期结果**：已读章节标题显示为灰色

---

### 步骤4：修改 ChapterListItem 组件

**文件**：`novel_app/lib/widgets/chapter_list/chapter_list_item.dart`

**操作**：
- 添加 `isRead` 参数
- 将 `isRead` 传递给 `ChapterTitle`

**预期结果**：章节列表项支持显示已读状态

---

### 步骤5：修改 ChapterListScreen

**文件**：`novel_app/lib/screens/chapter_list_screen.dart`

**操作**：
1. 添加状态映射：`final Map<String, bool> _readStatus = {};`

2. 在 `_loadChapters` 完成后调用 `_loadReadStatus()`

3. 添加 `_loadReadStatus()` 方法：
   ```dart
   Future<void> _loadReadStatus() async {
     // 批量查询所有章节的已读状态
     // 更新 _readStatus 映射
   }
   ```

4. 在 `_buildNormalChapterList` 中传入 `isRead` 状态：
   ```dart
   final isRead = _readStatus[chapter.url] ?? false;
   ```

**预期结果**：章节列表加载时获取并显示已读状态

---

### 步骤6：修改 ReaderScreen

**文件**：`novel_app/lib/screens/reader_screen.dart`

**操作**：
1. 在 `initState` 或章节加载完成后调用 `markChapterAsRead`
2. 确保标记操作不会影响阅读性能

**预期结果**：用户打开章节时自动标记为已读

---

## 影响范围

| 文件 | 修改类型 | 说明 |
|------|----------|------|
| `models/chapter.dart` | 修改 | 添加 readAt 字段 |
| `services/database_service.dart` | 修改 | 添加迁移和读写方法 |
| `widgets/chapter_list/chapter_title.dart` | 修改 | 添加已读颜色样式 |
| `widgets/chapter_list/chapter_list_item.dart` | 修改 | 传递 isRead 参数 |
| `screens/chapter_list_screen.dart` | 修改 | 加载并显示已读状态 |
| `screens/reader_screen.dart` | 修改 | 打开章节时标记已读 |

---

## 测试计划

1. **数据库迁移测试**：确保现有数据库平滑升级
2. **UI测试**：已读章节显示为灰色，未读章节保持原色
3. **功能测试**：打开章节后返回列表，确认章节被标记为已读
4. **边界测试**：无历史数据的新用户、大量章节的性能

---

## 完成标准

- ✅ 数据库成功迁移到 v11
- ✅ 打开章节后自动标记为已读
- ✅ 已读章节在列表中显示为灰色
- ✅ 未读章节保持原色
- ✅ 功能正常，无性能问题
