# æ’å›¾æ”¯æŒæ¯å¼ å›¾ç‰‡æ˜¾ç¤ºç‹¬ç«‹æ¨¡å‹æ ‡ç­¾

## ä»»åŠ¡ä¿¡æ¯
- **ä»»åŠ¡åç§°**ï¼šæ’å›¾æ”¯æŒæ¯å¼ å›¾ç‰‡æ˜¾ç¤ºç‹¬ç«‹æ¨¡å‹æ ‡ç­¾
- **åˆ›å»ºæ—¶é—´**ï¼š2026-01-25 13:11:41
- **é€‰æ‹©æ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆA - åœ¨æ˜ å°„è¡¨ä¸­æ·»åŠ model_nameå­—æ®µ
- **çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

## éœ€æ±‚æè¿°
ç”¨æˆ·å¸Œæœ›æ’å›¾ç»„ä»¶èƒ½å¤Ÿæ˜¾ç¤ºæ¯å¼ å›¾ç‰‡ä½¿ç”¨çš„ç”Ÿæˆæ¨¡å‹ã€‚ç‰¹åˆ«æ˜¯åœ¨"å†æ¥å‡ å¼ "åŠŸèƒ½ä¸­ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä¸åŒçš„æ¨¡å‹é‡æ–°ç”Ÿæˆï¼Œå› æ­¤éœ€è¦æ”¯æŒåŒä¸€ç»„å›¾ç‰‡ä¸­ä½¿ç”¨ä¸åŒæ¨¡å‹ã€‚

---

## é—®é¢˜åˆ†æ

### æ ¸å¿ƒé—®é¢˜
ä¹‹å‰çš„æ•°æ®ç»“æ„ä¸­ï¼Œä¸€ä¸ª `task_id` åªèƒ½å…³è”ä¸€ä¸ª `model_name`ï¼Œä½†"å†æ¥å‡ å¼ "åŠŸèƒ½å…è®¸ç”¨æˆ·ä½¿ç”¨ä¸åŒæ¨¡å‹ç”Ÿæˆæ–°å›¾ç‰‡ï¼Œå¯¼è‡´ï¼š

1. **æ•°æ®ä¸¢å¤±**ï¼šæ–°æ¨¡å‹ç”Ÿæˆçš„å›¾ç‰‡æ— æ³•è®°å½•ä½¿ç”¨çš„æ¨¡å‹
2. **æ˜¾ç¤ºé”™è¯¯**ï¼šæ‰€æœ‰å›¾ç‰‡éƒ½æ˜¾ç¤ºåŸå§‹ä»»åŠ¡çš„æ¨¡å‹åç§°

### æ•°æ®ç»“æ„ç¼ºé™·
```
scene_comfyui_tasks è¡¨ï¼ˆæ˜ å°„è¡¨ï¼‰
âŒ ç¼ºå°‘ model_name å­—æ®µ
â”œâ”€â”€ task_id: "12345-678"
â”œâ”€â”€ comfyui_prompt_id: "xyz444"
â””â”€â”€ æ²¡æœ‰è®°å½•ä½¿ç”¨çš„æ˜¯"å†™å®1"æ¨¡å‹

scene_comfyui_images è¡¨ï¼ˆå›¾ç‰‡åˆ—è¡¨ï¼‰
âŒ ç¼ºå°‘ model_name å­—æ®µ
â”œâ”€â”€ comfyui_prompt_id: "xyz444"
â”œâ”€â”€ images: ["img4.jpg"]
â””â”€â”€ æ²¡æœ‰è®°å½•ä½¿ç”¨çš„æ˜¯"å†™å®1"æ¨¡å‹
```

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šåœ¨æ˜ å°„è¡¨æ·»åŠ  model_name å­—æ®µ â­

**ä¼˜åŠ¿**ï¼š
- âœ… æ¯ä¸ª `comfyui_prompt_id` ç‹¬ç«‹è®°å½•æ¨¡å‹
- âœ… æ”¯æŒæ··åˆæ¨¡å‹åœºæ™¯
- âœ… æ•°æ®ç²’åº¦ç»†ï¼ŒæŸ¥è¯¢æ€§èƒ½å¥½

---

## å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ•°æ®åº“æ¨¡å‹ä¿®æ”¹ âœ…

**æ–‡ä»¶**ï¼š`backend/app/models/scene_comfyui_mapping.py`

**å˜æ›´å†…å®¹**ï¼š
1. `SceneComfyUITask` æ·»åŠ  `model_name` å­—æ®µ
2. `SceneComfyUIImages` æ·»åŠ  `model_name` å­—æ®µï¼ˆå†—ä½™ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰

**ä»£ç ä½ç½®**ï¼š
- ç¬¬34-37è¡Œï¼šSceneComfyUITask.model_name
- ç¬¬84-87è¡Œï¼šSceneComfyUIImages.model_name

**æ³¨æ„**ï¼šæ•°æ®åº“è¿ç§»éœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼ˆåç«¯é‡å¯åè‡ªåŠ¨åº”ç”¨ï¼‰

---

### æ­¥éª¤2ï¼šåç«¯Schemaä¿®æ”¹ âœ…

**æ–‡ä»¶**ï¼š`backend/app/schemas.py`

**å˜æ›´å†…å®¹**ï¼š
1. æ·»åŠ æ–°æ¨¡å‹ `ImageWithModel`ï¼ˆurl + model_nameï¼‰
2. ä¿®æ”¹ `SceneGalleryResponse.images` ç±»å‹æ”¹ä¸º `list[ImageWithModel]`

**ä»£ç ä½ç½®**ï¼š
- ç¬¬348-351è¡Œï¼šImageWithModel å®šä¹‰
- ç¬¬354-361è¡Œï¼šSceneGalleryResponse ä¿®æ”¹

---

### æ­¥éª¤3ï¼šåç«¯é€»è¾‘ä¿®æ”¹ âœ…

**æ–‡ä»¶**ï¼š`backend/app/services/scene_illustration_service.py`

#### 3.1 regenerateè®°å½•æ¨¡å‹
**æ–¹æ³•**ï¼š`regenerate_scene_images()`
**ä½ç½®**ï¼šç¬¬764-781è¡Œ

**å˜æ›´**ï¼šåˆ›å»ºæ˜ å°„è®°å½•æ—¶æ·»åŠ  `model_name` å‚æ•°
```python
task_mapping = SceneComfyUITask(
    task_id=request.task_id,
    comfyui_prompt_id=prompt_id,
    model_name=model_name,  # â† æ–°å¢
)

image_record = SceneComfyUIImages(
    comfyui_prompt_id=prompt_id,
    images="[]",
    status_fetched=False,
    model_name=model_name,  # â† æ–°å¢
)
```

#### 3.2 galleryè¿”å›æ¨¡å‹
**æ–¹æ³•**ï¼š`get_scene_gallery()`
**ä½ç½®**ï¼šç¬¬350-467è¡Œ

**å˜æ›´**ï¼š
1. è·å–æ¯å¼ å›¾ç‰‡çš„ `model_name`ï¼ˆç¬¬372-373è¡Œï¼‰
2. åˆ›å»º `ImageWithModel` å¯¹è±¡åˆ—è¡¨ï¼ˆç¬¬390-396è¡Œï¼Œ421-427è¡Œï¼‰
3. è¿”å›å¯¹è±¡åˆ—è¡¨è€Œéå­—ç¬¦ä¸²åˆ—è¡¨

**ä»£ç **ï¼š
```python
# è·å–æ¨¡å‹åç§°
model_name = image_record.model_name

# åˆ›å»ºå¯¹è±¡
all_images.append(
    ImageWithModel(url=img_url, model_name=model_name)
)
```

---

### æ­¥éª¤4ï¼šé‡æ–°ç”ŸæˆFlutter API âœ…

**æ“ä½œ**ï¼š
```bash
# é‡å¯åç«¯
docker-compose restart backend

# é‡æ–°ç”ŸæˆAPI
cd novel_app && dart run tool/generate_api.dart

# å®‰è£…ä¾èµ–
flutter pub get
```

**ç”Ÿæˆç»“æœ**ï¼š
- âœ… `ImageWithModel` æ¨¡å‹å·²ç”Ÿæˆ
- âœ… `SceneGalleryResponse` ç±»å‹å·²æ›´æ–°
- âœ… ä¾èµ–å®‰è£…å®Œæˆ

---

### æ­¥éª¤5ï¼šå‰ç«¯æ¥æ”¶æ¨¡å‹ä¿¡æ¯ âœ…

**æ–‡ä»¶**ï¼š`novel_app/lib/services/api_service_wrapper.dart`
**æ–¹æ³•**ï¼š`_sceneGalleryResponseToMap()`
**ä½ç½®**ï¼šç¬¬720-738è¡Œ

**å˜æ›´**ï¼šè½¬æ¢æ–°çš„æ•°æ®ç»“æ„
```dart
final imagesList = response.images.map((img) {
  return {
    'url': img.url,
    'model_name': img.modelName,
  };
}).toList();

return {
  'task_id': response.taskId,
  'images': imagesList,  // æ”¹ä¸ºå¯¹è±¡åˆ—è¡¨
  // ...
};
```

---

### æ­¥éª¤6ï¼šå‰ç«¯UIæ˜¾ç¤ºæ¨¡å‹æ ‡ç­¾ âœ…

**æ–‡ä»¶**ï¼š`novel_app/lib/widgets/scene_image_preview.dart`

#### 6.1 æ·»åŠ çŠ¶æ€å˜é‡
**ä½ç½®**ï¼šç¬¬37-43è¡Œ

**ä»£ç **ï¼š
```dart
class _SceneImagePreviewState extends State<SceneImagePreview> {
  List<String> _images = [];
  Map<int, String?> _imageModels = {};  // â† ç´¢å¼• -> æ¨¡å‹å
  int _currentIndex = 0;
}
```

#### 6.2 è§£ææ•°æ®
**æ–¹æ³•**ï¼š`_loadIllustrationFromBackend()`
**ä½ç½®**ï¼šç¬¬121-158è¡Œ

**é€»è¾‘**ï¼š
```dart
for (var i = 0; i < rawImages.length; i++) {
  final item = rawImages[i];
  if (item is Map) {
    // æ–°æ ¼å¼ï¼š{'url': 'xxx', 'model_name': 'xxx'}
    images.add(item['url']);
    _imageModels[i] = item['model_name'];
  } else if (item is String) {
    // å…¼å®¹æ—§æ ¼å¼
    images.add(item);
    _imageModels[i] = null;
  }
}
```

#### 6.3 æ˜¾ç¤ºæ ‡ç­¾
**æ–¹æ³•**ï¼š`_buildPageImage()`
**ä½ç½®**ï¼šç¬¬590-610è¡Œ

**UIæ•ˆæœ**ï¼š
- ä½ç½®ï¼šå·¦ä¸Šè§’ï¼ˆä¸å³ä¸Šè§’åˆ é™¤æŒ‰é’®å¯¹ç§°ï¼‰
- æ ·å¼ï¼šåŠé€æ˜é»‘è‰²èƒŒæ™¯ + ç™½è‰²æ–‡å­—
- å†…å®¹ï¼šæ¨¡å‹åç§°ï¼ˆå¦‚"åŠ¨æ¼«é£(ç«–)"ã€"å†™å®1"ï¼‰

**ä»£ç **ï¼š
```dart
if (modelName != null && modelName.isNotEmpty)
  Positioned(
    top: 8,
    left: 8,
    child: Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: Colors.black.withValues(alpha: 0.6),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Text(modelName, style: ...),
    ),
  ),
```

---

## æŠ€æœ¯äº®ç‚¹

### 1. ç±»å‹å®‰å…¨
- åç«¯ä½¿ç”¨ `list[ImageWithModel]` è€Œé `list[dict]`
- é¿å…ä½¿ç”¨ `Any` ç±»å‹ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§

### 2. å‘åå…¼å®¹
- å‰ç«¯åŒæ—¶æ”¯æŒæ–°æ—§ä¸¤ç§æ•°æ®æ ¼å¼
- æ—§å›¾ç‰‡ï¼ˆæ— æ¨¡å‹ä¿¡æ¯ï¼‰ä¸æ˜¾ç¤ºæ ‡ç­¾
- æ–°å›¾ç‰‡æ­£ç¡®æ˜¾ç¤ºæ¨¡å‹æ ‡ç­¾

### 3. æ•°æ®å†—ä½™
- `SceneComfyUIImages` ä¹Ÿå­˜å‚¨ `model_name`
- å‡å°‘ JOIN æ“ä½œï¼Œæå‡æŸ¥è¯¢æ€§èƒ½

---

## æµ‹è¯•åœºæ™¯

### åŠŸèƒ½æµ‹è¯•
1. âœ… åˆ›å»ºæ’å›¾ï¼Œä½¿ç”¨"åŠ¨æ¼«é£"ç”Ÿæˆ3å¼ 
2. âœ… ç‚¹å‡»"å†æ¥å‡ å¼ "ï¼Œé€‰æ‹©"å†™å®1"ç”Ÿæˆ2å¼ 
3. âœ… éªŒè¯ï¼šå‰3å¼ æ˜¾ç¤º"åŠ¨æ¼«é£(ç«–)"ï¼Œå2å¼ æ˜¾ç¤º"å†™å®1"
4. âœ… æ»‘åŠ¨åˆ‡æ¢å›¾ç‰‡ï¼Œæ ‡ç­¾åŠ¨æ€æ›´æ–°

### è¾¹ç•Œæµ‹è¯•
1. âœ… æ—§å›¾ç‰‡ï¼ˆæ— æ¨¡å‹ä¿¡æ¯ï¼‰ä¸æ˜¾ç¤ºæ ‡ç­¾
2. âœ… æ¨¡å‹åç§°ä¸ºç©ºæ—¶ä¸æ˜¾ç¤ºæ ‡ç­¾
3. âœ… å¤šå¼ å›¾ç‰‡ä½¿ç”¨ä¸åŒæ¨¡å‹æ—¶æ­£ç¡®æ˜¾ç¤º
4. âœ… å•å¼ å›¾ç‰‡æ—¶æ ‡ç­¾æ­£ç¡®æ˜¾ç¤º

---

## ä»£ç è´¨é‡æ£€æŸ¥

### åç«¯
```bash
# Pythonç±»å‹æ£€æŸ¥
mypy backend/app/services/scene_illustration_service.py
```
**ç»“æœ**ï¼šâœ… ç±»å‹æ³¨è§£å®Œæ•´ï¼Œæ—  `Any` ç±»å‹

### å‰ç«¯
```bash
flutter analyze lib/widgets/scene_image_preview.dart
```
**ç»“æœ**ï¼šâœ… No issues found!

---

## æ–‡ä»¶å˜æ›´æ¸…å•

| æ–‡ä»¶è·¯å¾„ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `backend/app/models/scene_comfyui_mapping.py` | ä¿®æ”¹ | æ·»åŠ model_nameå­—æ®µåˆ°ä¸¤ä¸ªè¡¨ |
| `backend/app/schemas.py` | ä¿®æ”¹ | æ·»åŠ ImageWithModelæ¨¡å‹ï¼Œä¿®æ”¹SceneGalleryResponse |
| `backend/app/services/scene_illustration_service.py` | ä¿®æ”¹ | regenerateè®°å½•æ¨¡å‹ï¼Œgalleryè¿”å›æ¨¡å‹ |
| `novel_app/generated/api/` | é‡æ–°ç”Ÿæˆ | Flutter APIå®¢æˆ·ç«¯ä»£ç  |
| `novel_app/lib/services/api_service_wrapper.dart` | ä¿®æ”¹ | è½¬æ¢æ–°çš„æ•°æ®ç»“æ„ |
| `novel_app/lib/widgets/scene_image_preview.dart` | ä¿®æ”¹ | æ¥æ”¶å¹¶æ˜¾ç¤ºæ¨¡å‹æ ‡ç­¾ |

---

## UIé¢„è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å›¾ç‰‡å†…å®¹]                 â”‚
â”‚                             â”‚
â”‚  [åŠ¨æ¼«é£(ç«–)]      [ğŸ—‘ï¸]    â”‚
â”‚  â†‘ å·¦ä¸Šè§’         â†‘ å³ä¸Šè§’  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **å·¦ä¸Šè§’**ï¼šåŠé€æ˜é»‘è‰²æ ‡ç­¾ï¼Œæ˜¾ç¤ºæ¨¡å‹åç§°
- **å³ä¸Šè§’**ï¼šåˆ é™¤æŒ‰é’®ï¼ˆä¿æŒåŸæ ·ï¼‰

---

## å®Œæˆæ ‡å‡†

- âœ… æ•°æ®åº“è¡¨ç»“æ„æ›´æ–°ï¼Œæ”¯æŒæ¯å¼ å›¾ç‰‡ç‹¬ç«‹æ¨¡å‹
- âœ… "å†æ¥å‡ å¼ "ä½¿ç”¨æ–°æ¨¡å‹æ—¶æ­£ç¡®è®°å½•
- âœ… APIè¿”å›æ¯å¼ å›¾ç‰‡çš„æ¨¡å‹ä¿¡æ¯
- âœ… å‰ç«¯æ­£ç¡®æ¥æ”¶å’Œè§£ææ•°æ®
- âœ… UIæ˜¾ç¤ºæ¨¡å‹æ ‡ç­¾ï¼Œä½ç½®åœ¨å·¦ä¸Šè§’
- âœ… æ»‘åŠ¨åˆ‡æ¢å›¾ç‰‡æ—¶æ ‡ç­¾åŠ¨æ€æ›´æ–°
- âœ… å‘åå…¼å®¹æ—§å›¾ç‰‡ï¼ˆæ— æ¨¡å‹ä¿¡æ¯ä¸æ˜¾ç¤ºï¼‰
- âœ… ä»£ç é€šè¿‡é™æ€åˆ†ææ£€æŸ¥

---

## åç»­ä¼˜åŒ–å»ºè®®

### å¯é€‰å¢å¼º
1. **æ•°æ®åº“è¿ç§»è„šæœ¬**ï¼šä¸ºæ—§æ•°æ®è‡ªåŠ¨å¡«å……æ¨¡å‹ä¿¡æ¯
2. **æ ‡ç­¾æ ·å¼ä¼˜åŒ–**ï¼šæ”¯æŒä¸åŒæ¨¡å‹ä½¿ç”¨ä¸åŒé¢œè‰²
3. **æ ‡ç­¾ç‚¹å‡»äº¤äº’**ï¼šç‚¹å‡»æ ‡ç­¾æ˜¾ç¤ºæ¨¡å‹è¯¦ç»†ä¿¡æ¯

### æ€§èƒ½ä¼˜åŒ–
1. **ç´¢å¼•ä¼˜åŒ–**ï¼šåœ¨ `model_name` å­—æ®µæ·»åŠ ç´¢å¼•
2. **ç¼“å­˜ç­–ç•¥**ï¼šç¼“å­˜å¸¸ç”¨æ¨¡å‹çš„å·¥ä½œæµé…ç½®

---

## æ€»ç»“

æœ¬æ¬¡å®ç°å½»åº•è§£å†³äº†"å†æ¥å‡ å¼ "åŠŸèƒ½æ¢æ¨¡å‹åå›¾ç‰‡æ ‡ç­¾æ˜¾ç¤ºé”™è¯¯çš„é—®é¢˜ã€‚

**æ ¸å¿ƒæ”¹è¿›**ï¼š
1. âœ… æ•°æ®ç»“æ„å±‚é¢ï¼šæ˜ å°„è¡¨å’Œå›¾ç‰‡è¡¨éƒ½æ·»åŠ  `model_name` å­—æ®µ
2. âœ… åç«¯é€»è¾‘å±‚é¢ï¼šåˆ›å»ºå’ŒæŸ¥è¯¢æ—¶éƒ½è®°å½•æ¨¡å‹ä¿¡æ¯
3. âœ… APIå±‚é¢ï¼šè¿”å›ç»“æ„åŒ–çš„å›¾ç‰‡æ•°æ®ï¼ˆurl + model_nameï¼‰
4. âœ… å‰ç«¯å±•ç¤ºå±‚é¢ï¼šå·¦ä¸Šè§’æ˜¾ç¤ºæ¨¡å‹æ ‡ç­¾

**æŠ€æœ¯äº®ç‚¹**ï¼š
- ç±»å‹å®‰å…¨ï¼Œé¿å…ä½¿ç”¨ `Any`
- å‘åå…¼å®¹ï¼Œå¹³æ»‘å‡çº§
- UIæ¸…æ™°ï¼Œç”¨æˆ·ä½“éªŒå¥½
- ä»£ç è´¨é‡é«˜ï¼Œé€šè¿‡é™æ€åˆ†æ

**ç”¨æˆ·ä»·å€¼**ï¼š
- æ¸…æ™°äº†è§£æ¯å¼ å›¾ç‰‡ä½¿ç”¨çš„ç”Ÿæˆæ¨¡å‹
- æ–¹ä¾¿å¯¹æ¯”ä¸åŒæ¨¡å‹çš„ç”Ÿæˆæ•ˆæœ
- æ”¯æŒ"å†æ¥å‡ å¼ "çµæ´»åˆ‡æ¢æ¨¡å‹
