# 多人对话互动功能 - 实施计划

## 项目概述

**目标**：在现有沉浸式体验功能基础上，实现多人对话互动的沉浸式剧情体验功能。

**核心设计**：
- AI扮演所有角色与用户互动
- 统一聊天流展示（类似微信群聊）
- 用户发送消息，AI决定哪个角色回复
- 剧本确认后自动启动

---

## 实施阶段

### 第一阶段：核心功能（最小可用版本）

**目标**：实现基本的多角色对话功能

#### 任务1：扩展ChatStreamParser
**文件**：`novel_app/lib/utils/chat_stream_parser.dart`

**子任务**：
- [ ] 添加 `parseChunkForMultiRole` 方法
- [ ] 实现 `_extractTag` 辅助方法（提取XML标签）
- [ ] 实现 `_findCharacter` 方法（查找角色）
- [ ] 实现 `_appendToDialogue` 方法（追加对话）
- [ ] 实现 `_appendToNarration` 方法（追加旁白）
- [ ] 添加单元测试

**预计时间**：2-3小时

---

#### 任务2：创建RoleColorManager工具类
**文件**：`novel_app/lib/utils/role_color_manager.dart`（新建）

**子任务**：
- [ ] 定义角色颜色常量列表
- [ ] 实现 `assignColors` 方法（为角色分配颜色）
- [ ] 实现 `getColor` 方法（获取角色颜色）
- [ ] 添加颜色循环复用逻辑

**预计时间**：1小时

---

#### 任务3：创建MultiRoleChatScreen基础框架
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`（新建）

**子任务**：
- [ ] 创建 StatefulWidget 类结构
- [ ] 定义构造函数和参数（characters, play, roleStrategy）
- [ ] 初始化状态变量（_messages, _isGenerating, _chatHistory等）
- [ ] 初始化角色颜色映射
- [ ] 实现 initState 和 dispose
- [ ] 创建基础UI框架（AppBar, Body结构）

**预计时间**：2小时

---

#### 任务4：实现流式解析和消息显示
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`

**子任务**：
- [ ] 实现 `_startInitialChat` 方法
- [ ] 实现 `_formatAllCharacters` 方法（格式化角色信息）
- [ ] 实现 `_handleStreamChunk` 方法（处理流式数据）
- [ ] 实现消息气泡组件：
  - [ ] `_buildMessageBubble`
  - [ ] `_buildNarrationBubble`
  - [ ] `_buildDialogueBubble`
  - [ ] `_buildUserBubble`
- [ ] 实现消息列表展示 `_buildMessageList`
- [ ] 实现空状态 `_buildEmptyState`

**预计时间**：3-4小时

---

#### 任务5：实现用户输入和发送功能
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`

**子任务**：
- [ ] 创建输入区域UI `_buildInputArea`
- [ ] 添加行为输入框（TextField）
- [ ] 添加对话输入框（TextField）
- [ ] 添加发送按钮
- [ ] 实现 `_sendMessage` 方法
- [ ] 实现 `_callDifyStreaming` 方法
- [ ] 实现 `_formatUserInput` 方法
- [ ] 实现 `_formatUserHistory` 方法
- [ ] 实现 `_canSend` 方法（验证输入）
- [ ] 实现滚动控制 `_scrollToBottom`

**预计时间**：2-3小时

---

#### 任务6：实现历史记录管理
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`

**子任务**：
- [ ] 修改 `_handleStreamChunk`：累积原始AI响应到 `_currentAiResponse`
- [ ] 修改 `_startInitialChat.onDone`：添加AI响应到历史（无包裹）
- [ ] 修改 `_callDifyStreaming.onDone`：添加AI响应到历史（无包裹）
- [ ] 修改用户输入逻辑：添加用户输入到历史（带 `<用户>` 标签）
- [ ] 实现历史记录格式化（用 `\n` 连接）
- [ ] 测试历史记录正确传递给Dify

**预计时间**：1-2小时

---

#### 任务7：实现角色头像和颜色显示
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`

**子任务**：
- [ ] 实现 `_buildCharacterAvatar` 方法
- [ ] 实现 `_buildFallbackAvatar` 方法（首字母头像）
- [ ] 集成 `CharacterAvatarService`（获取自定义头像）
- [ ] 在对话气泡中应用角色颜色
- [ ] 在头像边框中应用角色颜色
- [ ] 在气泡边框中应用角色颜色

**预计时间**：2小时

---

#### 任务8：修改ImmersiveInitScreen启动逻辑
**文件**：`novel_app/lib/widgets/immersive/immersive_init_screen.dart`

**子任务**：
- [ ] 导入 `MultiRoleChatScreen`
- [ ] 修改 `_confirmScript` 方法
- [ ] 使用 `Navigator.pushReplacement` 跳转到多人对话
- [ ] 传递必要的参数（characters, play, roleStrategy）
- [ ] 移除或更新原有的占位提示

**预计时间**：30分钟

---

#### 任务9：基础测试和调试
**测试项**：
- [ ] 测试初始聊天是否正常启动
- [ ] 测试流式解析是否正确识别旁白和角色对话
- [ ] 测试多角色颜色是否正确分配
- [ ] 测试用户输入是否正确发送
- [ ] 测试历史记录是否正确管理
- [ ] 测试网络错误处理
- [ ] 测试标签不匹配的边界情况
- [ ] 测试消息数量限制（100条）

**预计时间**：2-3小时

---

### 第一阶段总结

**预计总时间**：15-20小时

**交付物**：
- ✅ 可运行的多角色对话功能
- ✅ 基础UI和交互
- ✅ 流式解析和历史记录管理
- ✅ 错误处理

**里程碑**：用户可以与多个角色进行基础对话

---

### 第二阶段：UI优化和增强功能

**目标**：提升用户体验，增加实用功能

#### 任务1：添加角色策略查看对话框
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`

**子任务**：
- [ ] 在AppBar添加信息按钮
- [ ] 实现 `_showRoleStrategyDialog` 方法
- [ ] 设计策略对话框UI（ListView展示所有角色策略）
- [ ] 显示角色头像和颜色
- [ ] 显示策略文本内容

**预计时间**：1-2小时

---

#### 任务2：优化头像显示
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`

**子任务**：
- [ ] 优化自定义头像加载性能
- [ ] 添加头像加载占位符
- [ ] 添加头像加载失败处理
- [ ] 优化头像缓存逻辑

**预计时间**：1小时

---

#### 任务3：添加消息操作功能
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`

**子任务**：
- [ ] 实现长按消息显示菜单
- [ ] 添加复制消息功能
- [ ] 添加删除消息功能
- [ ] 添加分享消息功能

**预计时间**：2小时

---

#### 任务4：添加滚动优化
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`

**子任务**：
- [ ] 添加"滚动到顶部"悬浮按钮
- [ ] 优化自动滚动逻辑
- [ ] 添加滚动位置保存和恢复
- [ ] 优化滚动性能（使用 ListView.builder）

**预计时间**：1-2小时

---

#### 任务5：优化空状态和加载状态
**文件**：`novel_app/lib/screens/multi_role_chat_screen.dart`

**子任务**：
- [ ] 优化初始加载动画
- [ ] 优化空状态提示文案
- [ ] 添加角色列表预览（空状态时）
- [ ] 添加网络错误重试界面

**预计时间**：1小时

---

### 第二阶段总结

**预计总时间**：6-8小时

**交付物**：
- ✅ 优化的UI体验
- ✅ 角色策略查看功能
- ✅ 消息操作功能
- ✅ 滚动优化

---

### 第三阶段：高级功能

**目标**：增加高级功能，提升竞争力

#### 任务1：对话导出功能
**子任务**：
- [ ] 设计导出格式（Markdown/JSON/TXT）
- [ ] 实现导出逻辑
- [ ] 添加导出按钮和菜单
- [ ] 实现文件保存和分享

**预计时间**：2-3小时

---

#### 任务2：对话书签功能
**子任务**：
- [ ] 设计书签数据结构
- [ ] 实现添加书签功能
- [ ] 实现书签管理界面
- [ ] 实现书签跳转功能

**预计时间**：3-4小时

---

#### 任务3：角色表情和动作提示
**子任务**：
- [ ] 设计表情/动作提示UI
- [ ] 解析AI返回的表情/动作标记
- [ ] 在对话中显示表情图标
- [ ] 添加动画效果

**预计时间**：4-5小时

---

#### 任务4：音效支持
**子任务**：
- [ ] 设计音效方案（角色切换、消息提示）
- [ ] 集成音频播放库
- [ ] 添加音效开关设置
- [ ] 实现音效播放逻辑

**预计时间**：3-4小时

---

#### 任务5：对话回放功能
**子任务**：
- [ ] 设计回放界面
- [ ] 实现回放控制（播放/暂停/速度）
- [ ] 实现回放进度条
- [ ] 优化回放性能

**预计时间**：5-6小时

---

### 第三阶段总结

**预计总时间**：17-22小时

**交付物**：
- ✅ 对话导出功能
- ✅ 书签功能
- ✅ 表情/动作提示
- ✅ 音效支持
- ✅ 对话回放功能

---

## 实施顺序建议

### 最小可用产品（MVP）路径

1. **Week 1**：完成第一阶段（核心功能）
   - 优先级：任务1 → 任务2 → 任务3 → 任务4 → 任务5 → 任务6 → 任务7 → 任务8 → 任务9
   - 目标：让多角色对话跑起来

2. **Week 2**：完成第二阶段（UI优化）
   - 优先级：任务1 → 任务5 → 任务2 → 任务4 → 任务3
   - 目标：提升用户体验

3. **Week 3-4**：选择性完成第三阶段（高级功能）
   - 根据用户反馈决定优先级
   - 目标：增加竞争力

---

## 技术风险和缓解措施

### 风险1：流式解析性能问题

**描述**：逐字符解析可能导致性能问题

**缓解措施**：
- 使用字符串缓冲区减少内存分配
- 限制消息数量（保留最新100条）
- 使用 ListView.builder 优化渲染性能

---

### 风险2：XML标签解析错误

**描述**：Dify返回的标签格式可能不标准

**缓解措施**：
- 添加容错机制（未匹配的标签作为普通文本处理）
- 添加详细的调试日志
- 提供手动重置功能

---

### 风险3：历史记录过长影响性能

**描述**：聊天历史过长可能导致API请求过大

**缓解措施**：
- 限制历史记录条数（如保留最近20轮）
- 实现历史记录压缩
- 添加清理历史记录功能

---

### 风险4：角色颜色冲突

**描述**：角色数量超过预设颜色数量

**缓解措施**：
- 实现颜色循环复用
- 使用颜色生成算法（基于角色名哈希）
- 允许用户自定义颜色

---

## 测试计划

### 单元测试

**文件**：`novel_app/test/utils/chat_stream_parser_test.dart`

**测试用例**：
- [ ] 解析纯文本旁白
- [ ] 解析单个角色对话
- [ ] 解析多个角色对话
- [ ] 解析混合内容（旁白+对话）
- [ ] 处理未闭合的标签
- [ ] 处理未匹配的角色名
- [ ] 处理嵌套标签（如需要）

---

### 集成测试

**测试场景**：
- [ ] 完整的对话流程（初始→用户输入→AI响应）
- [ ] 历史记录正确传递给Dify
- [ ] 网络错误处理和重试
- [ ] 用户输入验证
- [ ] 消息数量限制
- [ ] 角色颜色分配

---

### UI测试

**测试项**：
- [ ] 所有角色颜色正确显示
- [ ] 头像正确加载（自定义和默认）
- [ ] 消息气泡正确渲染
- [ ] 滚动流畅
- [ ] 输入框交互正常
- [ ] 发送按钮状态正确

---

## 完成标准

### 第一阶段完成标准

- ✅ 用户可以与多个角色进行对话
- ✅ 流式解析正确处理旁白和角色对话
- ✅ 历史记录正确管理
- ✅ 基本错误处理到位
- ✅ 通过所有单元测试和集成测试

### 第二阶段完成标准

- ✅ UI体验流畅，无明显卡顿
- ✅ 用户可以查看角色策略
- ✅ 消息操作功能正常
- ✅ 滚动优化到位

### 第三阶段完成标准

- ✅ 至少实现2个高级功能
- ✅ 用户反馈积极
- ✅ 无严重Bug

---

## 后续优化方向

1. **性能优化**：
   - 使用 isolate 进行流式解析
   - 优化消息列表渲染
   - 实现虚拟滚动

2. **功能扩展**：
   - 支持图片和语音消息
   - 支持角色表情包
   - 支持场景切换

3. **数据分析**：
   - 收集用户使用数据
   - 分析对话质量
   - 优化AI策略

---

## 附录

### 相关文件清单

**新建文件**：
- `novel_app/lib/screens/multi_role_chat_screen.dart`
- `novel_app/lib/utils/role_color_manager.dart`
- `novel_app/test/utils/chat_stream_parser_test.dart`

**修改文件**：
- `novel_app/lib/utils/chat_stream_parser.dart`
- `novel_app/lib/widgets/immersive/immersive_init_screen.dart`

### 技术栈

- Flutter 3.0+
- Dart SDK
- Provider（状态管理，如需要）
- Dify Service（AI服务）
- Character Avatar Service（头像服务）

### 参考资料

- 现有 `CharacterChatScreen` 实现
- Dify API 文档
- Flutter 官方文档

---

**文档版本**：1.0
**创建日期**：2025-01-24
**最后更新**：2025-01-24
