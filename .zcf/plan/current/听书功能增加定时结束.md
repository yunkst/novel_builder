# 听书功能增加定时结束

**任务描述**：听书功能增加定时结束，可以指定读多少章内容后停止播放

**创建时间**：2026-01-23 08:50:12

---

## 需求分析

### 功能需求
1. **UI交互**：在播放器界面添加独立的「定时」按钮，点击后弹出设置
2. **停止行为**：达到指定章节数后暂停播放，显示提示对话框，用户可选择继续或关闭
3. **设置持久化**：不保存设置，每次打开播放器重新设置
4. **计数逻辑**：从当前章节开始计数（相对计数）

### 验收标准
1. ✅ 定时按钮显示在AppBar中
2. ✅ 定时激活时显示徽章（橙色背景+白色数字）
3. ✅ 可设置1-99章的定时
4. ✅ 设置时显示预览（当前章节、将读到哪章）
5. ✅ 达到定时后自动暂停播放
6. ✅ 弹出对话框提示已完成X章
7. ✅ 对话框提供"继续朗读"和"关闭"选项
8. ✅ 继续朗读后取消定时设置
9. ✅ 设置不保存，重新打开播放器后清空
10. ✅ 边界情况处理正确（超出总章节数警告等）

---

## 技术方案

### 方案选择
**方案1**：在AppBar添加独立定时按钮

### 技术栈
- Flutter 3.0+
- Provider状态管理
- Material Design 3

---

## 实施步骤

### 步骤1：创建定时配置数据类
**文件**：`lib/models/tts_timer_config.dart`（新建）
**内容**：
- TtsTimerConfig类：管理定时配置
- 字段：enabled, chapterCount, startChapterIndex
- 方法：getCompletedChapters(), isTargetReached()

### 步骤2：修改TtsPlayerService添加定时状态管理
**文件**：`lib/services/tts_player_service.dart`（修改）
**修改点**：
- 添加_timerConfig字段和getter
- 添加setTimer()和cancelTimer()方法
- 修改_onChapterComplete()添加定时检查逻辑
- 添加_onTimerComplete()处理定时完成
- 添加StreamController通知UI

### 步骤3：创建定时设置底部弹窗Widget
**文件**：`lib/widgets/tts_timer_settings_sheet.dart`（新建）
**UI设计**：
- 标题："定时结束设置"
- 章节数选择器：+/- 按钮 + 数字显示
- 预览信息：当前章节、将读到哪章
- 警告提示：超出总章节数
- 确认/取消按钮

### 步骤4：创建定时完成对话框Widget
**文件**：`lib/widgets/tts_timer_complete_dialog.dart`（新建）
**UI设计**：
- 图标：timer_outlined
- 标题："定时朗读完成"
- 内容：已完成章节数、当前章节
- 按钮："继续朗读"、"关闭"

### 步骤5：修改TtsPlayerScreen添加定时按钮和逻辑
**文件**：`lib/screens/tts_player_screen.dart`（修改）
**修改点**：
- 添加状态字段：_timerCompleteSubscription
- 修改AppBar.actions添加定时按钮
- 添加_showTimerSettings()方法
- 在initState中监听定时完成事件
- 添加_showTimerCompleteDialog()方法
- 修改dispose()取消订阅

### 步骤6：测试功能
**测试场景**：
1. 基本功能测试：设置定时、播放、自动暂停
2. 边界情况测试：超出总章节数、最后一章
3. UI交互测试：继续朗读、关闭
4. 状态恢复测试：暂停后恢复

---

## 文件结构

```
novel_app/lib/
├── models/
│   └── tts_timer_config.dart              [新建]
├── services/
│   └── tts_player_service.dart            [修改]
├── screens/
│   └── tts_player_screen.dart             [修改]
└── widgets/
    ├── tts_timer_settings_sheet.dart      [新建]
    └── tts_timer_complete_dialog.dart     [新建]
```

---

## 代码量统计

| 文件 | 类型 | 代码量 |
|------|------|--------|
| tts_timer_config.dart | 新建 | ~40行 |
| tts_player_service.dart | 修改 | +60行 |
| tts_timer_settings_sheet.dart | 新建 | ~120行 |
| tts_timer_complete_dialog.dart | 新建 | ~40行 |
| tts_player_screen.dart | 修改 | +150行 |
| **总计** | - | **约410行** |

---

## 风险评估

- 🟢 低风险：仅新增功能，不影响现有逻辑
- 🟢 易测试：功能独立，场景明确
- 🟢 可回滚：通过feature flag可快速禁用

---

## 执行记录

### 2026-01-23 08:50:12 - 开始执行
- 计划已创建并获得批准
- 开始按步骤执行代码开发

### 2026-01-23 执行完成
- ✅ 步骤1：创建TtsTimerConfig数据类（40行）
- ✅ 步骤2：修改TtsPlayerService添加定时状态管理（+60行）
- ✅ 步骤3：创建定时设置底部弹窗Widget（120行）
- ✅ 步骤4：创建定时完成对话框Widget（40行）
- ✅ 步骤5：修改TtsPlayerScreen添加定时按钮和逻辑（+150行）
- ✅ 代码质量检查：flutter analyze通过，无错误

### 实际代码统计
| 文件 | 类型 | 实际代码量 |
|------|------|-----------|
| tts_timer_config.dart | 新建 | 82行 |
| tts_player_service.dart | 修改 | +55行 |
| tts_timer_settings_sheet.dart | 新建 | 237行 |
| tts_timer_complete_dialog.dart | 新建 | 85行 |
| tts_player_screen.dart | 修改 | +70行 |
| **总计** | - | **约529行** |

### 代码质量
- ✅ Flutter analyze通过，无错误
- ✅ 遵循Material Design 3规范
- ✅ 完整的错误处理和边界检查
- ✅ 清晰的注释和文档
