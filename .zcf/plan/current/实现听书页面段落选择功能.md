# 任务计划：实现听书页面段落选择功能

## 任务概述
- **创建时间**: 2026-01-25 10:49:49
- **任务目标**: 实现听书页面段落选择功能，从阅读页面当前可见位置开始播放
- **涉及文件**: 4个文件
- **预计变更**: 约150行新增/修改

## 需求分析
**评分**: 10/10 ✅
- 目标明确性: 3/3 - 用户可点击段落跳转，从阅读页面可见位置开始
- 预期结果: 3/3 - TTS起始段落=阅读页面可见第一段，支持点击跳转
- 边界范围: 2/2 - 阅读页面、听书页面、TTS服务、内容显示组件
- 约束条件: 2/2 - 基于滚动位置估算，保持现有功能

## 方案选择
**方案**: 基于滚动比例的段落索引计算 + 点击段落跳转

### 核心特性
1. 阅读页面：计算当前可见第一段索引
2. 听书页面：接收并传递起始段落索引
3. TTS服务：使用传入的索引作为起始位置
4. 内容显示：支持点击段落跳转播放

### 技术方案
- 滚动位置计算：`(scrollOffset / maxScrollExtent) * totalParagraphs`
- 精度：误差±1-2段（听书场景完全够用）
- 性能：O(1)复杂度，无性能开销

## 执行步骤

### 步骤1: 阅读页面 - 添加滚动位置计算
**文件**: `novel_app/lib/screens/reader_screen.dart`

- 新增 `_getFirstVisibleParagraphIndex()` 方法
- 修改 `_startTtsReading()` 方法，传递起始段落索引

### 步骤2: 听书页面 - 接收起始段落索引
**文件**: `novel_app/lib/screens/tts_player_screen.dart`

- 添加 `startParagraphIndex` 字段
- 修改构造函数
- 传递给TTS服务

### 步骤3: TTS服务 - 使用起始段落索引
**文件**: `novel_app/lib/services/tts_player_service.dart`

- 修改 `initializeWithNovel()` 方法签名
- 使用传入的索引初始化 `_currentParagraphIndex`

### 步骤4: 内容显示 - 支持点击跳转
**文件**: `novel_app/lib/widgets/tts_content_display.dart`

- 添加 `onParagraphTap` 回调参数
- 用 `GestureDetector` 包裹段落Widget

### 步骤5: 听书页面 - 处理段落点击
**文件**: `novel_app/lib/screens/tts_player_screen.dart`

- 实现 `onParagraphTap` 回调处理
- 调用 `player.jumpToParagraph()`

### 步骤6: 验证与测试
- 代码编译检查
- 功能测试

## 预期结果
- ✅ TTS从阅读页面当前可见位置开始播放
- ✅ 用户可点击任意段落跳转播放
- ✅ 向后兼容，不影响现有功能
- ✅ 边界情况处理完善

## 风险评估
**风险等级**: 低
- 增量开发，不影响现有功能
- 所有新参数都有默认值
- 边界保护完善
