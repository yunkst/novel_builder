# 背景设定总结用户确认功能实施计划

## 任务概述
为背景设定AI总结功能添加用户确认流程，生成总结后通过Tab切换显示原文和总结内容，用户确认后才进行替换。

## 需求确认
- **对比方式**: Tab切换（原文/总结）
- **操作选项**: 确认替换 / 重新生成 / 取消
- **备份机制**: 不需要，直接替换
- **UI方式**: 在当前对话框内完成

## 技术上下文

### 涉及文件
- **主要文件**: `novel_app/lib/widgets/reader/background_summary_dialog.dart`
- **依赖文件**:
  - `novel_app/lib/mixins/dify_streaming_mixin.dart` (已存在)
  - `novel_app/lib/services/database_service.dart` (已存在)
  - `novel_app/lib/models/novel.dart` (已存在)

### 当前实现分析
- 已有 `BackgroundSummaryDialog` 对话框
- 已集成 `DifyStreamingMixin` 流式生成
- 生成完成后直接调用 `_saveSummary()` 保存
- 需要改造为生成完成后先显示对比界面

## 实施步骤

### 步骤1: 状态管理改造

**文件**: `background_summary_dialog.dart` (第28-42行)

**操作**:
1. 添加 `TabController` 状态变量
2. 在 `initState()` 中初始化 TabController（长度为2）
3. 在 `dispose()` 中释放 TabController
4. 添加 `_currentTabIndex` 跟踪当前Tab索引

**新增变量**:
```dart
late TabController _tabController;
int _currentTabIndex = 0;
```

**预期结果**: TabController 管理两个Tab（原文/总结）

---

### 步骤2: UI结构调整 - 总结完成界面

**文件**: `background_summary_dialog.dart` (第266-311行)

**操作**:
1. 修改总结完成后的 `AlertDialog` 结构
2. 添加 `TabBar` 组件（两个Tab: "原文", "总结"）
3. 添加 `TabBarView` 组件包含两个可滚动内容区
4. 调整操作按钮布局

**新UI结构**:
```
AlertDialog
  ├─ title: 总结完成 + [复制]按钮
  ├─ content: Column
  │   ├─ TabBar (原文 | 总结)
  │   └─ TabBarView
  │       ├─ Tab 1: 原文内容 (SingleChildScrollView)
  │       └─ Tab 2: 总结内容 (_summaryResult)
  └─ actions: [取消] [重新生成] [确认替换]
```

**预期结果**: 用户可以在两个Tab之间切换查看内容

---

### 步骤3: 操作按钮逻辑实现

**文件**: `background_summary_dialog.dart` (第296-309行)

**操作**:
1. **取消按钮**: `Navigator.pop(context, false)` - 不保存直接关闭
2. **重新生成按钮**: 调用 `_regenerateSummarize()` - 清空结果重新生成
3. **确认替换按钮**: 调用 `_saveSummary(_summaryResult)` - 保存并关闭

**按钮样式**:
- 取消: `TextButton` (灰色)
- 重新生成: `ElevatedButton` (橙色)
- 确认替换: `ElevatedButton` (绿色，强调操作)

**预期结果**: 三个按钮对应三种操作流程

---

### 步骤4: 移除自动保存逻辑

**文件**: `background_summary_dialog.dart` (第129-134行)

**操作**:
1. 修改 `onComplete` 回调逻辑
2. **不再自动调用** `_saveSummary()`
3. 改为更新UI状态，显示对比界面
4. 设置 `_isStreaming = false` 结束生成状态

**原代码**:
```dart
onComplete: (content) async {
  await _saveSummary(content);  // 自动保存
},
```

**修改为**:
```dart
onComplete: (content) async {
  // 生成完成，UI会自动切换到对比界面
  setState(() {
    _summaryResult = content;
  });
},
```

**预期结果**: 生成完成后停留在对比界面，等待用户操作

---

### 步骤5: Tab切换优化

**文件**: `background_summary_dialog.dart`

**操作**:
1. 添加 `TabBar` 主题样式（Material 3风格）
2. 设置选中Tab颜色为橙色（与应用主题一致）
3. 添加指示器颜色
4. Tab文字大小适配（14-16px）

**样式配置**:
```dart
TabBar(
  controller: _tabController,
  labelColor: Colors.orange,
  unselectedLabelColor: Colors.grey,
  indicatorColor: Colors.orange,
  tabs: [
    Tab(text: '原文'),
    Tab(text: '总结'),
  ],
)
```

**预期结果**: Tab切换视觉效果良好，与应用风格统一

---

### 步骤6: 响应式布局优化

**文件**: `background_summary_dialog.dart` (第280-294行)

**操作**:
1. 调整对话框尺寸：宽度500px → 550px（容纳TabBar）
2. 内容区域高度：400px → 450px（更多可读空间）
3. TabBarView 内部使用 `Expanded` 充分利用空间
4. 添加内容内边距 `padding: EdgeInsets.all(16)`

**预期结果**: 对话框尺寸合理，内容显示充分

---

## 代码变更摘要

### 新增代码
- TabController 初始化和释放逻辑（约10行）
- TabBar + TabBarView UI结构（约30行）
- 三个操作按钮逻辑（约15行）

### 修改代码
- `onComplete` 回调：移除自动保存
- 总结完成界面：替换为对比界面
- 对话框尺寸调整

### 删除代码
- 原有的自动保存调用（1行）

### 总变更量
- 约50-60行代码改动
- 不涉及新依赖
- 不影响其他模块

---

## 测试验证点

### 功能测试
1. ✅ 点击"AI总结"按钮，显示确认对话框
2. ✅ 确认后流式生成总结内容
3. ✅ 生成完成后显示Tab对比界面
4. ✅ 切换Tab可以查看原文和总结
5. ✅ 点击"取消"关闭对话框，不保存
6. ✅ 点击"重新生成"清空结果并重新生成
7. ✅ 点击"确认替换"保存总结并关闭
8. ✅ 返回后背景设定已更新

### UI测试
1. ✅ Tab切换流畅，无卡顿
2. ✅ 内容区域独立滚动正常
3. ✅ 按钮样式和颜色正确
4. ✅ 对话框尺寸适配不同屏幕

### 边界测试
1. ✅ 原文内容为空时的显示
2. ✅ 生成失败时的错误处理
3. ✅ 快速点击按钮的防抖处理
4. ✅ 网络异常时的用户提示

---

## 风险评估

### 低风险
- ✅ 仅修改单一文件
- ✅ 不涉及数据库结构变更
- ✅ 不影响其他功能模块
- ✅ 改动集中在UI层

### 注意事项
- ⚠️ 确保 `onComplete` 中不再自动保存
- ⚠️ TabController 必须正确释放避免内存泄漏
- ⚠️ 保存失败时要有错误提示

---

## 完成标准

1. ✅ 代码编译通过，无语法错误
2. ✅ 功能测试通过（上述8个测试点）
3. ✅ 代码格式符合 Flutter 规范
4. ✅ 无新增警告或错误
5. ✅ 用户体验流畅，无明显卡顿

---

## 执行顺序

1. **步骤1**: 状态管理改造（TabController）
2. **步骤2**: UI结构调整（TabBar + TabBarView）
3. **步骤3**: 操作按钮逻辑实现
4. **步骤4**: 移除自动保存逻辑
5. **步骤5**: Tab切换样式优化
6. **步骤6**: 响应式布局调整
7. **测试验证**: 功能测试 + UI测试
8. **代码审查**: 格式检查 + 警告检查

---

## 时间估算

- 步骤1-2: 30分钟（状态管理 + UI结构）
- 步骤3-4: 20分钟（按钮逻辑 + 移除自动保存）
- 步骤5-6: 15分钟（样式优化 + 布局调整）
- 测试验证: 20分钟
- 代码审查: 10分钟
- **总计**: 约1.5小时

---

## 备注

- 所有修改均在单一文件内完成
- 保持现有 `DifyStreamingMixin` 集成不变
- 不需要修改 `BackgroundSettingScreen`
- 用户操作流程保持简洁直观

---

**创建时间**: 2025-01-27
**状态**: 待用户批准后执行
