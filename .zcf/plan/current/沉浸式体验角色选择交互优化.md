# 优化沉浸式体验角色选择交互

## 任务上下文

**目标**：移除角色选择Chip的删除按钮，改为点击激活/取消的方式，防止用户误删

**当前问题**：
- 使用 `Chip` 组件的 `onDeleted` 属性
- 用户可能误点删除按钮
- 交互不够直观

**技术文件**：
- 文件：`novel_app/lib/widgets/immersive/immersive_setup_dialog.dart`
- UI框架：Flutter Material Design 3
- 状态管理：`setState` + `List<Character> _selectedRoles`

---

## 执行计划

### 步骤1：替换Chip为FilterChip

**文件**：`novel_app/lib/widgets/immersive/immersive_setup_dialog.dart`

**操作**：
1. 找到第298-313行的 `Wrap` 组件中的 `Chip` 代码
2. 将 `Chip` 替换为 `FilterChip`
3. 配置属性：
   - `label`: Text(role.name)
   - `selected`: `_selectedRoles.contains(role)`
   - `onSelected`: (bool selected) => _toggleRole(role)
   - `avatar`: 用户角色时显示 `Icons.person`
   - `selectedColor`: 选中时的背景色
   - `checkmark`: 显示选中标记

**预期结果**：
- 角色标签可以点击切换选中状态
- 选中状态有明显的视觉反馈
- 无删除按钮，防止误删

---

### 步骤2：实现角色切换方法

**文件**：`novel_app/lib/widgets/immersive/immersive_setup_dialog.dart`

**位置**：在第152行 `_removeRole()` 方法之前添加新方法

**操作**：
```dart
/// 切换角色选中状态
void _toggleRole(Character role) {
  setState(() {
    if (_selectedRoles.contains(role)) {
      // 取消选中
      _selectedRoles.remove(role);
      // 如果取消的是用户角色，清空用户角色
      if (_userRole == role.name) {
        _userRole = null;
      }
    } else {
      // 选中角色
      _selectedRoles.add(role);
    }
  });
}
```

**预期结果**：
- 点击未选中角色时添加到列表
- 点击已选中角色时从列表移除
- 自动处理用户角色的清空逻辑

---

### 步骤3：优化视觉样式

**FilterChip样式配置**：

```dart
FilterChip(
  label: Text(role.name),
  selected: _selectedRoles.contains(role),
  onSelected: (_) => _toggleRole(role),
  avatar: _userRole == role.name
      ? const Icon(Icons.person, size: 16)
      : null,
  selectedColor: Colors.purple.withValues(alpha: 0.2),
  backgroundColor: Colors.grey.shade200,
  checkmark: const Icon(Icons.check, size: 18),
  labelStyle: TextStyle(
    color: _selectedRoles.contains(role)
        ? Colors.purple
        : Colors.grey.shade700,
    fontWeight: _selectedRoles.contains(role)
        ? FontWeight.w600
        : FontWeight.normal,
  ),
)
```

**预期结果**：
- 选中状态：紫色背景 + 深色文字 + 对勾图标
- 未选中状态：灰色背景 + 灰色文字
- 用户角色：额外显示人物图标

---

### 步骤4：移除_removeRole方法（可选）

**文件**：`novel_app/lib/widgets/immersive/immersive_setup_dialog.dart`

**操作**：
- 删除第152-161行的 `_removeRole()` 方法
- 或者保留以备其他地方使用

**预期结果**：
- 代码更简洁（如果不删除也无所谓）

---

### 步骤5：测试验证

**测试场景**：
1. ✅ 点击未选中角色 → 角色被添加到已选列表
2. ✅ 点击已选中角色 → 角色从已选列表移除
3. ✅ 取消选中用户角色 → 用户角色下拉框清空
4. ✅ 选中状态视觉反馈清晰
5. ✅ 与角色选择器联动正常

**测试文件**：手动测试 `ImmersiveSetupDialog`

**预期结果**：
- 所有交互正常工作
- 无误删风险
- 用户体验流畅

---

## 成功标准

- ✅ 角色标签可点击切换选中状态
- ✅ 无删除按钮，防止误删
- ✅ 选中状态视觉反馈清晰
- ✅ 用户角色联动逻辑正常
- ✅ 代码简洁易维护

---

## 实施时间估计

- 步骤1：替换组件（5分钟）
- 步骤2：实现切换逻辑（5分钟）
- 步骤3：优化样式（5分钟）
- 步骤4：清理代码（2分钟）
- 步骤5：测试验证（5分钟）

**总计**：约22分钟

---

## 风险与注意事项

1. **状态同步**：确保 `_selectedRoles` 和 `_userRole` 状态同步更新
2. **空列表处理**：当所有角色被取消选中时，显示"未选择角色"提示
3. **角色选择器联动**：确保与 `_showRoleSelector()` 的数据传递正常
4. **视觉一致性**：保持与整体UI风格一致

---

## 完成标志

- ✅ 代码修改完成
- ✅ 功能测试通过
- ✅ 无编译错误和警告
- ✅ 用户体验符合预期
