# å¤šäººå¯¹è¯äº’åŠ¨åŠŸèƒ½ - è¯¦ç»†è®¾è®¡æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

**åŠŸèƒ½åç§°**ï¼šå¤šäººå¯¹è¯äº’åŠ¨çš„æ²‰æµ¸å¼å‰§æƒ…ä½“éªŒ

**æ ¸å¿ƒè®¾è®¡**ï¼šAIæ‰®æ¼”æ‰€æœ‰è§’è‰²ä¸ç”¨æˆ·è¿›è¡Œäº’åŠ¨ï¼Œé€šè¿‡ç»Ÿä¸€èŠå¤©æµå±•ç¤ºæ—ç™½å’Œå¤šè§’è‰²å¯¹è¯ã€‚

**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-24
**ç‰ˆæœ¬**ï¼š1.0

---

## ç›®å½•

1. [æ ¸å¿ƒé€»è¾‘ä¸æ•°æ®æµ](#1-æ ¸å¿ƒé€»è¾‘ä¸æ•°æ®æµ)
2. [æ•°æ®æ¨¡å‹è®¾è®¡](#2-æ•°æ®æ¨¡å‹è®¾è®¡)
3. [æµå¼è§£æå™¨è®¾è®¡](#3-æµå¼è§£æå™¨è®¾è®¡)
4. [UIè®¾è®¡](#4-uiè®¾è®¡)
5. [çŠ¶æ€ç®¡ç†](#5-çŠ¶æ€ç®¡ç†)
6. [é›†æˆç‚¹ä¸å¯åŠ¨æµç¨‹](#6-é›†æˆç‚¹ä¸å¯åŠ¨æµç¨‹)
7. [é”™è¯¯å¤„ç†](#7-é”™è¯¯å¤„ç†)
8. [æµ‹è¯•ç­–ç•¥](#8-æµ‹è¯•ç­–ç•¥)

---

## 1. æ ¸å¿ƒé€»è¾‘ä¸æ•°æ®æµ

### 1.1 ç³»ç»Ÿæ¶æ„ç†è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AIæ‰®æ¼”æ‰€æœ‰è§’è‰²çš„æ²‰æµ¸å¼å¯¹è¯ç³»ç»Ÿ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¾“å…¥ â†’ AIå“åº” â†’ è§£ææ˜¾ç¤º â†’ ç´¯ç§¯å†å² â†’ ä¸‹ä¸€è½®
   â†“          â†“         â†“          â†“          â†“
 è¡Œä¸º/å¯¹è¯  å¤šè§’è‰²+æ—ç™½  èŠå¤©æ°”æ³¡   åŸå§‹æ–‡æœ¬   AIæ¨ç†
```

**æ ¸å¿ƒç†è§£**ï¼š
- ä¸æ˜¯çœŸæ­£çš„å¤šè§’è‰²ç³»ç»Ÿï¼Œè€Œæ˜¯ä¸€ä¸ªAIç»Ÿä¸€ç®¡ç†æ‰€æœ‰è§’è‰²
- æ¯ä¸ªå›åˆï¼šç”¨æˆ·å‘é€è¡Œä¸º/å¯¹è¯ â†’ AIè¿”å›å®Œæ•´å“åº”ï¼ˆåŒ…å«æ—ç™½+å¤šè§’è‰²å¯¹è¯ï¼‰
- å†å²è®°å½•ç”¨äºAIæ¨ç†ä¸Šä¸‹æ–‡

### 1.2 Difyè¿”å›æ ¼å¼ç¤ºä¾‹

```
ä»Šå¤©çš„è®¨è®ºå¾ˆæœ‰æ„ä¹‰<è§’è‰²A>

åŒæ„ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥æ¢è®¨<è§’è‰²B>

è®©æˆ‘å†æƒ³æƒ³<è§’è‰²C>

</è§’è‰²C>

è¿™ä¸ªé—®é¢˜å¾ˆå¤æ‚<è§’è‰²A>

å¤§å®¶éƒ½è¯´å¾—å¾ˆæœ‰é“ç†<è§’è‰²B>
```

**è§£æè§„åˆ™**ï¼š
- çº¯æ–‡æœ¬ â†’ æ—ç™½æ¶ˆæ¯ï¼ˆç°è‰²æ–œä½“æ˜¾ç¤ºï¼‰
- `<è§’è‰²å>` â†’ å¼€å§‹è§’è‰²å¯¹è¯
- `</è§’è‰²å>` â†’ ç»“æŸè§’è‰²å¯¹è¯
- `<ç”¨æˆ·>` â†’ ç”¨æˆ·æ¶ˆæ¯ï¼ˆä»…ç”¨äºå†å²è®°å½•ï¼Œä¸åœ¨AIå“åº”ä¸­å‡ºç°ï¼‰

### 1.3 å†å²è®°å½•ç®¡ç†

```dart
// æ•°æ®ç»“æ„
final List<String> _chatHistory = [];

// AIå“åº”å®Œæˆæ—¶
void _onAiResponseComplete() {
  // _currentAiResponse æ˜¯ç´¯ç§¯çš„åŸå§‹æ–‡æœ¬ï¼ˆåŒ…å«<è§’è‰²å>æ ‡ç­¾ï¼‰
  _chatHistory.add(_currentAiResponse);
  _currentAiResponse = '';
}

// ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶
void _onUserSend(String action, String speech) {
  final userInput = '<ç”¨æˆ·>è¡Œä¸º:$action\nå¯¹è¯:$speech</ç”¨æˆ·>';
  _chatHistory.add(userInput);
}

// å‘é€ç»™Difyæ—¶ç”¨æ¢è¡Œç¬¦è¿æ¥
final chatHistoryString = _chatHistory.join('\n');
```

**å†å²è®°å½•ç¤ºä¾‹**ï¼š

```dart
_chatHistory = [
  // ç¬¬1å›åˆï¼šAIçš„å®Œæ•´å“åº”ï¼ˆåŸå§‹æ–‡æœ¬ï¼‰
  'å¤§å®¶ä»Šå¤©éƒ½æ¥å¾—çœŸæ—©å•Š<è§’è‰²A>æ˜¯çš„ï¼Œæˆ‘æ€»æ˜¯ç¬¬ä¸€ä¸ªåˆ°<è§’è‰²A>ï¼Œè¿™æ˜¯ä»Šå¤©çš„è®®é¢˜<è§’è‰²C>æ¬¢è¿åŠ å…¥æˆ‘ä»¬çš„è®¨è®º<è§’è‰²B>ä»Šå¤©å¤©æ°”çœŸä¸é”™</è§’è‰²B></è§’è‰²B></è§’è‰²A></è§’è‰²C>å¾ˆé«˜å…´è§åˆ°å¤§å®¶<è§’è‰²A>',

  // ç¬¬2å›åˆï¼šç”¨æˆ·çš„è¾“å…¥
  '<ç”¨æˆ·>è¡Œä¸º:ç¯é¡¾å››å‘¨\nå¯¹è¯:è¿™é‡Œçš„ç¯å¢ƒçœŸä¸é”™</ç”¨æˆ·>',

  // ç¬¬3å›åˆï¼šAIçš„å®Œæ•´å“åº”
  'é˜³å…‰é€è¿‡æ ‘å¶æ´’åœ¨åœ°é¢ä¸Š<è§’è‰²A>æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„é¢†åœ°</è§’è‰²A><è§’è‰²B>è¯·é—®ä½ éœ€è¦ä»€ä¹ˆå¸®åŠ©å—ï¼Ÿ</è§’è‰²B><è§’è‰²C>å¾ˆé«˜å…´è§åˆ°ä½ </è§’è‰²C>',

  // ç¬¬4å›åˆï¼šç”¨æˆ·çš„è¾“å…¥
  '<ç”¨æˆ·>è¡Œä¸º:ç‚¹å¤´\nå¯¹è¯:è°¢è°¢</ç”¨æˆ·>',
]
```

### 1.4 æ•°æ®æµå›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant M as MultiRoleChatScreen
    participant P as ChatStreamParser
    participant D as DifyService

    U->>M: åˆå§‹å¯åŠ¨
    M->>D: runWorkflowStreaming<br/>(cmd: 'èŠå¤©', scene: play)
    D-->>M: æµå¼è¿”å›åŸå§‹æ–‡æœ¬
    M->>P: parseChunkForMultiRole(chunk)
    P-->>M: ParseResult(messages, inDialogue)
    M->>U: å®æ—¶æ˜¾ç¤ºæ¶ˆæ¯æ°”æ³¡

    U->>M: è¾“å…¥è¡Œä¸º/å¯¹è¯
    M->>M: æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    M->>M: _chatHistory.add(userInput)
    M->>D: runWorkflowStreaming<br/>(user_input, chat_history)
    D-->>M: æµå¼è¿”å›åŸå§‹æ–‡æœ¬
    M->>P: parseChunkForMultiRole(chunk)
    P-->>M: ParseResult(messages, inDialogue)
    M->>U: å®æ—¶æ˜¾ç¤ºæ¶ˆæ¯æ°”æ³¡
    M->>M: _chatHistory.add(aiResponse)
```

---

## 2. æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 ChatMessageï¼ˆå·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰

```dart
class ChatMessage {
  final String type;           // 'narration' | 'dialogue' | 'user_action' | 'user_speech'
  final String content;
  final Character? character;  // å¯¹è¯ç±»å‹æ—¶å…³è”çš„è§’è‰²
  final bool isUser;           // æ˜¯å¦ä¸ºç”¨æˆ·æ¶ˆæ¯

  ChatMessage.narration(this.content)
      : type = 'narration',
        character = null,
        isUser = false;

  ChatMessage.dialogue(this.content, this.character)
      : type = 'dialogue',
        isUser = false;

  ChatMessage.userAction(this.content)
      : type = 'user_action',
        character = null,
        isUser = true;

  ChatMessage.userSpeech(this.content)
      : type = 'user_speech',
        character = null,
        isUser = true;

  ChatMessage copyWith({String? content}) {
    return ChatMessage(
      type: type,
      content: content ?? this.content,
      character: character,
      isUser: isUser,
    );
  }
}
```

### 2.2 Characterï¼ˆå·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰

```dart
class Character {
  final String? id;
  final String novelUrl;
  final String name;
  final String? gender;
  final int? age;
  final String? occupation;
  final String? personality;
  final String? bodyType;
  final String? clothingStyle;
  final String? appearanceFeatures;
  final String? backgroundStory;
  final String? cachedImageUrl;
}
```

---

## 3. æµå¼è§£æå™¨è®¾è®¡

### 3.1 ChatStreamParseræ‰©å±•

åœ¨ `lib/utils/chat_stream_parser.dart` ä¸­æ·»åŠ æ–°æ–¹æ³•ï¼š

```dart
/// è§£æå¤šè§’è‰²æµå¼æ–‡æœ¬
///
/// å‚æ•°ï¼š
/// - [chunk] æ–°æ¥æ”¶çš„æ–‡æœ¬å—
/// - [currentMessages] å½“å‰æ¶ˆæ¯åˆ—è¡¨
/// - [allCharacters] æ‰€æœ‰è§’è‰²åˆ—è¡¨
/// - [inDialogue] å½“å‰æ˜¯å¦åœ¨å¯¹è¯æ¨¡å¼ä¸­
///
/// è¿”å›ï¼šæ›´æ–°åçš„æ¶ˆæ¯åˆ—è¡¨å’Œæ–°çš„å¯¹è¯çŠ¶æ€
static ParseResult parseChunkForMultiRole(
  String chunk,
  List<ChatMessage> currentMessages,
  List<Character> allCharacters,
  bool inDialogue,
) {
  List<ChatMessage> messages = List.from(currentMessages);
  Character? currentCharacter;

  // å¦‚æœå·²ç»åœ¨å¯¹è¯ä¸­ï¼Œæ‰¾åˆ°å½“å‰è§’è‰²
  if (inDialogue && messages.isNotEmpty && messages.last.type == 'dialogue') {
    currentCharacter = messages.last.character;
  }

  // é€å­—ç¬¦è§£æ
  for (int i = 0; i < chunk.length; i++) {
    final char = chunk[i];

    if (char == '<') {
      // æ£€æµ‹æ ‡ç­¾
      final tagContent = _extractTag(chunk, i);
      if (tagContent != null) {
        final tagLength = tagContent.length + 2; // åŒ…æ‹¬ < å’Œ >
        i += tagLength - 1; // è·³è¿‡æ ‡ç­¾ï¼ˆå¾ªç¯ä¼š+1ï¼‰

        if (tagContent.startsWith('/')) {
          // é—­åˆæ ‡ç­¾ </è§’è‰²å>
          final tagName = tagContent.substring(1);
          if (currentCharacter?.name == tagName) {
            currentCharacter = null; // ç»“æŸå¯¹è¯
          }
        } else {
          // å¼€æ”¾æ ‡ç­¾ <è§’è‰²å>
          final character = _findCharacter(tagContent, allCharacters);
          if (character != null) {
            currentCharacter = character;
            messages.add(ChatMessage.dialogue('', character));
          }
        }
        continue;
      }
    }

    // å¤„ç†æ™®é€šå­—ç¬¦
    if (currentCharacter != null) {
      // è§’è‰²å¯¹è¯æ¨¡å¼
      _appendToDialogue(messages, char, currentCharacter);
    } else {
      // æ—ç™½æ¨¡å¼
      _appendToNarration(messages, char);
    }
  }

  return ParseResult(
    messages: messages,
    inDialogue: currentCharacter != null,
  );
}

/// æå–æ ‡ç­¾å†…å®¹
/// è¿”å›: æ ‡ç­¾åï¼ˆä¸åŒ…å« < å’Œ >ï¼‰ï¼Œå¦‚æœä¸æ˜¯æœ‰æ•ˆæ ‡ç­¾è¿”å› null
static String? _extractTag(String chunk, int startIndex) {
  if (startIndex >= chunk.length || chunk[startIndex] != '<') return null;

  final endIndex = chunk.indexOf('>', startIndex);
  if (endIndex == -1) return null;

  return chunk.substring(startIndex + 1, endIndex);
}

/// æŸ¥æ‰¾è§’è‰²
static Character? _findCharacter(String name, List<Character> characters) {
  try {
    return characters.firstWhere((c) => c.name == name);
  } catch (e) {
    debugPrint('âš ï¸ æœªæ‰¾åˆ°è§’è‰²: $name');
    return null;
  }
}

/// è¿½åŠ åˆ°å¯¹è¯
static void _appendToDialogue(
  List<ChatMessage> messages,
  String char,
  Character character,
) {
  if (messages.isEmpty ||
      messages.last.type != 'dialogue' ||
      messages.last.character != character) {
    messages.add(ChatMessage.dialogue(char, character));
  } else {
    final lastMessage = messages.last;
    messages[messages.length - 1] = ChatMessage.dialogue(
      lastMessage.content + char,
      character,
    );
  }
}

/// è¿½åŠ åˆ°æ—ç™½
static void _appendToNarration(List<ChatMessage> messages, String char) {
  if (messages.isEmpty || messages.last.type != 'narration') {
    messages.add(ChatMessage.narration(char));
  } else {
    final lastMessage = messages.last;
    messages[messages.length - 1] = ChatMessage.narration(
      lastMessage.content + char,
    );
  }
}
```

### 3.2 è§£æé€»è¾‘è¯´æ˜

**é€å­—ç¬¦è§£æçš„ä¼˜åŠ¿**ï¼š
- æ”¯æŒæµå¼æ›´æ–°ï¼Œå®æ—¶æ˜¾ç¤º
- å‡†ç¡®è¯†åˆ«æ ‡ç­¾è¾¹ç•Œ
- æ˜“äºè°ƒè¯•å’Œç»´æŠ¤

**çŠ¶æ€æœº**ï¼š
```
åˆå§‹çŠ¶æ€ (inDialogue=false)
    â†“
æ”¶åˆ° '<è§’è‰²å>'
    â†“
å¯¹è¯çŠ¶æ€ (inDialogue=true, currentCharacter=è§’è‰²)
    â†“
æ”¶åˆ° '</è§’è‰²å>'
    â†“
å›åˆ°æ—ç™½çŠ¶æ€ (inDialogue=false, currentCharacter=null)
```

---

## 4. UIè®¾è®¡

### 4.1 RoleColorManagerå·¥å…·ç±»

æ–°å»º `lib/utils/role_color_manager.dart`ï¼š

```dart
import 'package:flutter/material.dart';
import '../models/character.dart';

class RoleColorManager {
  static const List<Color> _roleColors = [
    Color(0xFF1E3A5F), // æ·±è“è‰²
    Color(0xFF1F3D2F), // æ·±ç»¿è‰²
    Color(0xFF3D1E5F), // æ·±ç´«è‰²
    Color(0xFF5F3D1E), // æ·±æ£•è‰²
    Color(0xFF5F1E3D), // æ·±çº¢è‰²
    Color(0xFF1E5F3D), // é’ç»¿è‰²
    Color(0xFF5F5F1E), // æ·±é»„è‰²
    Color(0xFF3D3D3D), // æ·±ç°è‰²
  ];

  /// ä¸ºè§’è‰²åˆ†é…é¢œè‰²
  static Map<String, Color> assignColors(List<Character> characters) {
    final Map<String, Color> colorMap = {};

    for (int i = 0; i < characters.length; i++) {
      final colorIndex = i % _roleColors.length;
      colorMap[characters[i].name] = _roleColors[colorIndex];
    }

    return colorMap;
  }

  /// è·å–è§’è‰²é¢œè‰²
  static Color getColor(String characterName, Map<String, Color> colorMap) {
    return colorMap[characterName] ?? _roleColors.first;
  }
}
```

### 4.2 MultiRoleChatScreen UIç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AppBar: æ²‰æµ¸å¼å¯¹è¯                               â”‚
â”‚        è§’è‰²ï¼šè§’è‰²Aã€è§’è‰²Bã€è§’è‰²C          [info] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ [è§’è‰²Aå¤´åƒ]  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚ â”‚  ğŸŸ¡è“è‰²      â”‚ è§’è‰²Açš„å¯¹è¯å†…å®¹      â”‚     â”‚  â”‚
â”‚ â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚     *æ—ç™½å†…å®¹æ˜¾ç¤ºä¸ºæ–œä½“ç°è‰²æ–‡æœ¬*                â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ [è§’è‰²Bå¤´åƒ]  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚ â”‚  ğŸŸ¢ç»¿è‰²      â”‚ è§’è‰²Bçš„å¯¹è¯å†…å®¹      â”‚     â”‚  â”‚
â”‚ â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                        â”‚ç”¨æˆ·æ¶ˆæ¯   â”‚           â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ‘¥ æ­£åœ¨ä¸ è§’è‰²Aã€è§’è‰²Bã€è§’è‰²C å¯¹è¯]           â”‚
â”‚                                                â”‚
â”‚ è¡Œä¸º (å¯é€‰): [___________________]             â”‚
â”‚                                                â”‚
â”‚ å¯¹è¯ (å¯é€‰): [___________________]             â”‚
â”‚              [___________________]             â”‚
â”‚                                                â”‚
â”‚              [  å‘é€æ¶ˆæ¯  ]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ¶ˆæ¯æ°”æ³¡è®¾è®¡

#### æ—ç™½æ°”æ³¡
```dart
Widget _buildNarrationBubble(ChatMessage message) {
  return Container(
    margin: const EdgeInsets.symmetric(vertical: 8),
    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
    child: Text(
      message.content,
      style: TextStyle(
        color: _DarkThemeColors.hintText,
        fontStyle: FontStyle.italic,
        fontSize: 14,
        height: 1.5,
      ),
    ),
  );
}
```

#### è§’è‰²å¯¹è¯æ°”æ³¡
```dart
Widget _buildDialogueBubble(ChatMessage message) {
  final character = message.character!;
  final color = _roleColors[character.name] ?? _DarkThemeColors.roleBubbleBackground;

  return Container(
    margin: const EdgeInsets.symmetric(vertical: 8),
    child: Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // è§’è‰²å¤´åƒ
        _buildCharacterAvatar(character, color),
        const SizedBox(width: 8),

        // å¯¹è¯æ°”æ³¡
        Expanded(
          child: Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: color.withOpacity(0.2),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: color, width: 2),
            ),
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  child: Text(
                    message.content,
                    style: const TextStyle(
                      fontSize: 15,
                      height: 1.5,
                      color: _DarkThemeColors.primaryText,
                    ),
                  ),
                ),
                // æµå¼è¾“å‡ºæŒ‡ç¤ºå™¨
                if (_isGenerating && message == _messages.last)
                  _buildTypingIndicator(),
              ],
            ),
          ),
        ),
      ],
    ),
  );
}
```

#### ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡
```dart
Widget _buildUserBubble(ChatMessage message) {
  return Container(
    margin: const EdgeInsets.symmetric(vertical: 8),
    child: Align(
      alignment: Alignment.centerRight,
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: _DarkThemeColors.userBubbleBackground,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: _DarkThemeColors.userBubbleBorder,
            width: 2,
          ),
        ),
        child: Text(
          message.content,
          style: const TextStyle(
            fontSize: 15,
            height: 1.5,
            color: _DarkThemeColors.primaryText,
          ),
        ),
      ),
    ),
  );
}
```

### 4.4 è§’è‰²å¤´åƒè®¾è®¡

```dart
Widget _buildCharacterAvatar(Character character, Color color) {
  return FutureBuilder<String?>(
    future: character.id != null
        ? _avatarService.getCharacterAvatarPath(character.id!)
        : Future.value(null),
    builder: (context, snapshot) {
      final avatarPath = snapshot.data;

      if (avatarPath != null && File(avatarPath).existsSync()) {
        return Container(
          width: 40,
          height: 40,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            border: Border.all(color: color, width: 2),
          ),
          child: ClipOval(
            child: Image.file(
              File(avatarPath),
              fit: BoxFit.cover,
              errorBuilder: (context, error, stackTrace) {
                return _buildFallbackAvatar(character, color);
              },
            ),
          ),
        );
      }

      return _buildFallbackAvatar(character, color);
    },
  );
}

Widget _buildFallbackAvatar(Character character, Color color) {
  return Container(
    width: 40,
    height: 40,
    decoration: BoxDecoration(
      color: color.withOpacity(0.3),
      shape: BoxShape.circle,
      border: Border.all(color: color, width: 2),
    ),
    child: Center(
      child: Text(
        character.name.isNotEmpty ? character.name[0].toUpperCase() : '?',
        style: TextStyle(
          fontSize: 18,
          fontWeight: FontWeight.bold,
          color: color,
        ),
      ),
    ),
  );
}
```

---

## 5. çŠ¶æ€ç®¡ç†

### 5.1 çŠ¶æ€å˜é‡

```dart
class _MultiRoleChatScreenState extends State<MultiRoleChatScreen> {
  // æ¶ˆæ¯åˆ—è¡¨
  List<ChatMessage> _messages = [];

  // ç”ŸæˆçŠ¶æ€
  bool _isGenerating = false;

  // è§£æçŠ¶æ€
  bool _inDialogue = false;  // æ˜¯å¦åœ¨è§’è‰²å¯¹è¯ä¸­

  // AIå“åº”ç´¯ç§¯ï¼ˆç”¨äºå†å²è®°å½•ï¼‰
  String _currentAiResponse = '';

  // èŠå¤©å†å²
  final List<String> _chatHistory = [];

  // æ§åˆ¶å™¨
  final TextEditingController _actionController = TextEditingController();
  final TextEditingController _speechController = TextEditingController();
  final ScrollController _scrollController = ScrollController();

  // æœåŠ¡
  final DifyService _difyService = DifyService();
  final CharacterAvatarService _avatarService = CharacterAvatarService();

  // è§’è‰²é¢œè‰²æ˜ å°„
  late Map<String, Color> _roleColors;
}
```

### 5.2 çŠ¶æ€è½¬æ¢

```mermaid
stateDiagram-v2
    [*] --> Idle: åˆå§‹åŒ–
    Idle --> Generating: å¼€å§‹åˆå§‹èŠå¤©
    Generating --> Idle: èŠå¤©å®Œæˆ
    Idle --> Generating: ç”¨æˆ·å‘é€æ¶ˆæ¯

    note right of Generating
        _isGenerating = true
        æ¥æ”¶æµå¼æ•°æ®
        æ›´æ–° _messages
        ç´¯ç§¯ _currentAiResponse
    end note

    note right of Idle
        _isGenerating = false
        ç­‰å¾…ç”¨æˆ·è¾“å…¥
    end note
```

---

## 6. é›†æˆç‚¹ä¸å¯åŠ¨æµç¨‹

### 6.1 ä¿®æ”¹ImmersiveInitScreen

åœ¨ `lib/widgets/immersive/immersive_init_screen.dart` ä¸­ï¼š

```dart
/// ç¡®è®¤å‰§æœ¬ï¼ˆå¯åŠ¨å¤šäººå¯¹è¯ï¼‰
void _confirmScript() {
  Navigator.pushReplacement(
    context,
    MaterialPageRoute(
      builder: (context) => MultiRoleChatScreen(
        characters: widget.config.characters,
        play: _play!,
        roleStrategy: _roleStrategy!,
      ),
    ),
  );
}
```

### 6.2 å¯åŠ¨æµç¨‹

```mermaid
graph TB
    A[ç”¨æˆ·é˜…è¯»ç« èŠ‚] --> B[ç‚¹å‡»æ²‰æµ¸ä½“éªŒ]
    B --> C[ImmersiveInitScreen<br/>ç”Ÿæˆå‰§æœ¬å’Œè§’è‰²ç­–ç•¥]
    C --> D[ç”¨æˆ·ç¡®è®¤å‰§æœ¬]
    D --> E[MultiRoleChatScreen<br/>å¯åŠ¨å¤šäººå¯¹è¯]
    E --> F[åˆå§‹AIå“åº”<br/>å¤šè§’è‰²+æ—ç™½]
    F --> G[ç”¨æˆ·è¾“å…¥è¡Œä¸º/å¯¹è¯]
    G --> H[AIå“åº”<br/>å¤šè§’è‰²+æ—ç™½]
    H --> G

    style E fill:#e1f5ff
    style F fill:#fff4e1
    style H fill:#fff4e1
```

---

## 7. é”™è¯¯å¤„ç†

### 7.1 ç½‘ç»œé”™è¯¯

```dart
try {
  await _difyService.runWorkflowStreaming(...);
} catch (e) {
  setState(() {
    _isGenerating = false;
  });

  _showErrorSnackBar('ç½‘ç»œé”™è¯¯ï¼š$e');
  _showRetryDialog();
}

void _showRetryDialog() {
  showDialog(
    context: context,
    builder: (context) => AlertDialog(
      title: const Text('è¿æ¥å¤±è´¥'),
      content: const Text('æ˜¯å¦é‡è¯•ï¼Ÿ'),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text('å–æ¶ˆ'),
        ),
        ElevatedButton(
          onPressed: () {
            Navigator.pop(context);
            _retryLastRequest();
          },
          child: const Text('é‡è¯•'),
        ),
      ],
    ),
  );
}
```

### 7.2 è§’è‰²æœªåŒ¹é…

```dart
static Character? _findCharacter(String name, List<Character> characters) {
  try {
    return characters.firstWhere((c) => c.name == name);
  } catch (e) {
    debugPrint('âš ï¸ æœªæ‰¾åˆ°è§’è‰²: $name');
    return null;
  }
}

// åœ¨è§£ææ—¶å¤„ç†
if (character != null) {
  messages.add(ChatMessage.dialogue('', character));
} else {
  debugPrint('âš ï¸ æœªçŸ¥è§’è‰²æ ‡ç­¾: $tagContent');
  // ä½œä¸ºæ—ç™½å¤„ç†
  _appendToNarration(messages, '<$tagContent>');
}
```

### 7.3 æ ‡ç­¾ä¸åŒ¹é…

```dart
if (tagContent.startsWith('/')) {
  final tagName = tagContent.substring(1);
  if (currentCharacter == null) {
    debugPrint('âš ï¸ å¤šä½™çš„é—­åˆæ ‡ç­¾: </$tagName>');
    // ä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†
    _appendToNarration(messages, '</$tagName>');
  } else if (currentCharacter.name != tagName) {
    debugPrint('âš ï¸ æ ‡ç­¾ä¸åŒ¹é…: æœŸæœ›</${currentCharacter.name}>, å®é™…</$tagName>');
    // ä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†
    _appendToNarration(messages, '</$tagName>');
  } else {
    currentCharacter = null;
  }
}
```

### 7.4 æ¶ˆæ¯æ•°é‡é™åˆ¶

```dart
setState(() {
  // ä¿ç•™æœ€æ–°100æ¡æ¶ˆæ¯
  _messages = result.messages.length > 100
      ? result.messages.sublist(result.messages.length - 100)
      : result.messages;
});
```

---

## 8. æµ‹è¯•ç­–ç•¥

### 8.1 å•å…ƒæµ‹è¯•

æ–‡ä»¶ï¼š`test/utils/chat_stream_parser_test.dart`

```dart
void main() {
  group('ChatStreamParser.parseChunkForMultiRole', () {
    final characters = [
      Character(novelUrl: '', name: 'è§’è‰²A'),
      Character(novelUrl: '', name: 'è§’è‰²B'),
    ];

    test('åº”è¯¥è§£ææ—ç™½', () {
      final result = ChatStreamParser.parseChunkForMultiRole(
        'è¿™æ˜¯æ—ç™½å†…å®¹',
        [],
        characters,
        false,
      );

      expect(result.messages.length, 1);
      expect(result.messages.first.type, 'narration');
      expect(result.messages.first.content, 'è¿™æ˜¯æ—ç™½å†…å®¹');
      expect(result.inDialogue, false);
    });

    test('åº”è¯¥è§£æè§’è‰²å¯¹è¯', () {
      final result = ChatStreamParser.parseChunkForMultiRole(
        '<è§’è‰²A>ä½ å¥½</è§’è‰²A>',
        [],
        characters,
        false,
      );

      expect(result.messages.length, 1);
      expect(result.messages.first.type, 'dialogue');
      expect(result.messages.first.character?.name, 'è§’è‰²A');
      expect(result.messages.first.content, 'ä½ å¥½');
      expect(result.inDialogue, false);
    });

    test('åº”è¯¥è§£æå¤šè§’è‰²å¯¹è¯', () {
      final result = ChatStreamParser.parseChunkForMultiRole(
        'æ—ç™½<è§’è‰²A>ä½ å¥½</è§’è‰²A>æ—ç™½<è§’è‰²B>ä½ å¥½</è§’è‰²B>',
        [],
        characters,
        false,
      );

      expect(result.messages.length, 5);
      expect(result.messages[0].type, 'narration');
      expect(result.messages[1].type, 'dialogue');
      expect(result.messages[1].character?.name, 'è§’è‰²A');
      expect(result.messages[2].type, 'narration');
      expect(result.messages[3].type, 'dialogue');
      expect(result.messages[3].character?.name, 'è§’è‰²B');
      expect(result.messages[4].type, 'narration');
    });

    test('åº”è¯¥å¤„ç†æµå¼æ›´æ–°', () {
      // ç¬¬ä¸€æ¬¡æ¥æ”¶
      var result = ChatStreamParser.parseChunkForMultiRole(
        '<è§’è‰²A>ä½ ',
        [],
        characters,
        false,
      );

      expect(result.messages.length, 1);
      expect(result.messages.first.content, 'ä½ ');
      expect(result.inDialogue, true);

      // ç¬¬äºŒæ¬¡æ¥æ”¶
      result = ChatStreamParser.parseChunkForMultiRole(
        'å¥½',
        result.messages,
        characters,
        result.inDialogue,
      );

      expect(result.messages.length, 1);
      expect(result.messages.first.content, 'ä½ å¥½');
      expect(result.inDialogue, true);

      // ç¬¬ä¸‰æ¬¡æ¥æ”¶
      result = ChatStreamParser.parseChunkForMultiRole(
        '</è§’è‰²A>',
        result.messages,
        characters,
        result.inDialogue,
      );

      expect(result.messages.length, 1);
      expect(result.messages.first.content, 'ä½ å¥½');
      expect(result.inDialogue, false);
    });
  });
}
```

### 8.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š

1. **å®Œæ•´çš„å¯¹è¯æµç¨‹**
   - åˆå§‹èŠå¤© â†’ ç”¨æˆ·è¾“å…¥ â†’ AIå“åº” â†’ ç”¨æˆ·è¾“å…¥ â†’ AIå“åº”
   - éªŒè¯å†å²è®°å½•æ­£ç¡®ç´¯ç§¯
   - éªŒè¯UIæ­£ç¡®æ›´æ–°

2. **å†å²è®°å½•ä¼ é€’**
   - éªŒè¯ `_chatHistory` æ­£ç¡®ä¼ é€’ç»™Dify
   - éªŒè¯ç”¨æˆ·è¾“å…¥ç”¨ `<ç”¨æˆ·>` åŒ…è£¹
   - éªŒè¯AIå“åº”æ— åŒ…è£¹æ ‡ç­¾

3. **ç½‘ç»œé”™è¯¯å¤„ç†**
   - æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
   - éªŒè¯é”™è¯¯æç¤ºæ˜¾ç¤º
   - éªŒè¯é‡è¯•åŠŸèƒ½

4. **è¾¹ç•Œæƒ…å†µ**
   - æ¶ˆæ¯æ•°é‡è¶…è¿‡100æ¡
   - è§’è‰²åä¸åŒ¹é…
   - æ ‡ç­¾æœªé—­åˆ
   - ç©ºæ¶ˆæ¯

### 8.3 UIæµ‹è¯•

**æµ‹è¯•é¡¹**ï¼š

1. **è§’è‰²é¢œè‰²åˆ†é…**
   - å¤šä¸ªè§’è‰²é¢œè‰²ä¸åŒ
   - é¢œè‰²å¾ªç¯å¤ç”¨

2. **å¤´åƒæ˜¾ç¤º**
   - è‡ªå®šä¹‰å¤´åƒåŠ è½½
   - é»˜è®¤å¤´åƒæ˜¾ç¤º
   - å¤´åƒåŠ è½½å¤±è´¥å¤„ç†

3. **æ¶ˆæ¯æ°”æ³¡**
   - æ—ç™½æ­£ç¡®æ˜¾ç¤ºï¼ˆç°è‰²æ–œä½“ï¼‰
   - å¯¹è¯æ­£ç¡®æ˜¾ç¤ºï¼ˆæ°”æ³¡+å¤´åƒï¼‰
   - ç”¨æˆ·æ¶ˆæ¯æ­£ç¡®æ˜¾ç¤ºï¼ˆå³ä¾§æ°”æ³¡ï¼‰

4. **æ»šåŠ¨æ€§èƒ½**
   - è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
   - æ»šåŠ¨æµç•…åº¦
   - é•¿æ¶ˆæ¯åˆ—è¡¨æ€§èƒ½

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

**æ–°å»ºæ–‡ä»¶**ï¼š
- `novel_app/lib/screens/multi_role_chat_screen.dart`
- `novel_app/lib/utils/role_color_manager.dart`
- `novel_app/test/utils/chat_stream_parser_test.dart`

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `novel_app/lib/utils/chat_stream_parser.dart`
- `novel_app/lib/widgets/immersive/immersive_init_screen.dart`

### B. æŠ€æœ¯æ ˆ

- Flutter 3.0+
- Dart SDK
- Dify Serviceï¼ˆAIæœåŠ¡ï¼‰
- Character Avatar Serviceï¼ˆå¤´åƒæœåŠ¡ï¼‰

### C. å‚è€ƒèµ„æ–™

- ç°æœ‰ `CharacterChatScreen` å®ç°
- Dify API æ–‡æ¡£
- Flutter å®˜æ–¹æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-24
**æœ€åæ›´æ–°**ï¼š2025-01-24
**ä½œè€…**ï¼šClaude Code
