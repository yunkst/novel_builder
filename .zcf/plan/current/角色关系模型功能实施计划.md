# 角色关系模型功能实施计划

**任务描述**：在角色管理模块新增关系模型，支持用户创建人物之间的关系（如A是B的徒弟），提供关系列表查看、创建/编辑关系、关系图可视化功能。

**创建时间**：2026-01-25 14:16:27
**完成时间**：2026-01-25 14:32:25
**方案选择**：方案1 - 独立关系表 + 关系列表页面
**关系图需求**：点击人物节点时高亮相关关系
**实施状态**：✅ 已完成

---

## 一、上下文信息

### 技术栈
- **框架**：Flutter 3.0+
- **本地存储**：SQLite (sqflite)
- **UI组件**：Material Design 3
- **关系图库**：`flutter_graph` 或 `custom_paint` (待确定)

### 现有代码结构
- **角色模型**：`lib/models/character.dart`
- **角色管理页面**：`lib/screens/character_management_screen.dart`
- **数据库服务**：`lib/services/database_service.dart` (当前版本12)
- **角色编辑页面**：`lib/screens/character_edit_screen.dart`

### 数据库设计原则
- 使用SQLite本地存储
- 数据库版本升级迁移（当前v12 → v13）
- 外键约束确保数据完整性
- 索引优化查询性能

---

## 二、数据模型设计

### 2.1 关系模型 (`lib/models/character_relationship.dart`)

```dart
class CharacterRelationship {
  final int? id;
  final int sourceCharacterId;  // 关系发起者ID
  final int targetCharacterId;  // 关系目标者ID
  final String relationshipType; // 关系类型（用户自定义，如"师父"、"徒弟"）
  final String? description;     // 关系详细描述
  final DateTime createdAt;
  final DateTime? updatedAt;

  // 辅助方法：toMap, fromMap, copyWith
}
```

**设计要点：**
- 有向关系图：source → target
- 支持反向关系：A是B的师父，B是A的徒弟（两条记录）
- relationshipType完全自定义，无预设列表

### 2.2 数据库表结构

**表名**：`character_relationships`

```sql
CREATE TABLE character_relationships (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  source_character_id INTEGER NOT NULL,
  target_character_id INTEGER NOT NULL,
  relationship_type TEXT NOT NULL,
  description TEXT,
  created_at INTEGER NOT NULL,
  updated_at INTEGER,
  FOREIGN KEY (source_character_id) REFERENCES characters(id) ON DELETE CASCADE,
  FOREIGN KEY (target_character_id) REFERENCES characters(id) ON DELETE CASCADE,
  UNIQUE(source_character_id, target_character_id, relationship_type)
);

-- 索引优化
CREATE INDEX idx_relationships_source ON character_relationships(source_character_id);
CREATE INDEX idx_relationships_target ON character_relationships(target_character_id);
```

**约束说明：**
- `ON DELETE CASCADE`：删除角色时自动删除相关关系
- `UNIQUE`约束：同一对角色之间不允许重复的关系类型
- 双向索引：优化查询某个角色的所有关系（入度+出度）

---

## 三、UI界面设计

### 3.1 关系列表页面 (`lib/screens/character_relationship_screen.dart`)

**路由参数**：
- `required Character character`：当前查看关系的角色

**布局结构**：
```
AppBar: "角色名 - 人物关系"
  - 操作按钮：添加关系

TabBar:
  - Tab 1: 全部关系 (出度 + 入度)
  - Tab 2: Ta的关系 (出度：Ta → 其他人)
  - Tab 3: 关系Ta的人 (入度：其他人 → Ta)

TabView:
  - ListView展示关系卡片
```

**关系卡片设计**：
```
Card:
  leading: 目标角色头像
  title: "关系类型" (e.g., "师父")
  subtitle: "目标角色名 · 描述"
  trailing: [编辑按钮, 删除按钮]
```

### 3.2 关系编辑对话框 (`lib/widgets/relationship_edit_dialog.dart`)

**两种使用场景**：
1. **新建关系**：从关系列表页面点击"添加"
2. **编辑关系**：点击关系卡片的编辑按钮

**表单字段**：
- `targetCharacter`：下拉选择器（排除自己和已有关关系的角色）
- `relationshipType`：文本输入框 + 历史记录提示
- `description`：多行文本输入框（可选）

**交互逻辑**：
- 保存时验证：不能重复创建相同的关系
- 删除时二次确认

### 3.3 关系图可视化页面 (`lib/screens/character_relationship_graph_screen.dart`)

**功能特性**：
1. **基础绘图**：使用 `CustomPainter` 绘制节点和边
2. **节点设计**：
   - 圆形节点显示角色头像
   - 节点下方显示角色名称
   - 选中节点高亮（外圈光环）
3. **边设计**：
   - 有向箭头：source → target
   - 箭头旁显示关系类型文字
   - 高亮路径：选中节点及其所有关系边高亮
4. **交互功能**：
   - 点击节点：高亮该节点的所有关系
   - 拖拽节点：重新布局位置（可选，V2实现）
   - 双击节点：跳转到角色编辑页面
5. **布局算法**：
   - 力导向布局（force-directed）或
   - 层次布局（hierarchical layout）
   - 初始：简单圆形布局

---

## 四、数据库服务扩展

### 4.1 新增方法 (`lib/services/database_service.dart`)

```dart
// 关系CRUD操作
Future<int> createRelationship(CharacterRelationship relationship);
Future<List<CharacterRelationship>> getRelationships(int characterId);
Future<List<CharacterRelationship>> getOutgoingRelationships(int characterId);
Future<List<CharacterRelationship>> getIncomingRelationships(int characterId);
Future<void> updateRelationship(CharacterRelationship relationship);
Future<void> deleteRelationship(int relationshipId);

// 关系查询辅助
Future<bool> relationshipExists(int sourceId, int targetId, String type);
Future<List<Character>> getRelatedCharacters(int characterId);

// 数据库迁移
void _onUpgrade(Database db, int oldVersion, int newVersion) {
  if (oldVersion < 13) {
    // 创建关系表
  }
}
```

### 4.2 数据库版本升级

**当前版本**：12
**目标版本**：13

**迁移脚本**：
```sql
-- 创建关系表
CREATE TABLE character_relationships (...);
CREATE INDEX idx_relationships_source ...;
CREATE INDEX idx_relationships_target ...;
```

---

## 五、角色管理页面集成

### 5.1 角色管理页面修改点

**文件**：`lib/screens/character_management_screen.dart`

**修改内容**：
1. **角色卡片添加关系标识**：
   - 在角色卡片右上角显示关系数量徽章
   - 例如：Badge显示"3"表示该角色有3个关系

2. **长按菜单新增选项**：
   - 现有选项：编辑、删除
   - 新增选项："查看关系"

3. **点击卡片跳转逻辑**：
   - 如果点击"查看关系"：导航到 `CharacterRelationshipScreen`
   - 传递当前角色对象

---

## 六、实施步骤清单

### 阶段1：数据模型与数据库（核心）

- [ ] **Step 1.1**：创建 `CharacterRelationship` 模型类
  - 文件：`lib/models/character_relationship.dart`
  - 实现：`toMap()`, `fromMap()`, `copyWith()`
  - 预期结果：可序列化的数据模型

- [ ] **Step 1.2**：数据库迁移脚本
  - 文件：`lib/services/database_service.dart`
  - 方法：`_onUpgrade()` 添加版本13迁移
  - 预期结果：升级后自动创建 `character_relationships` 表

- [ ] **Step 1.3**：数据库服务方法实现
  - 文件：`lib/services/database_service.dart`
  - 方法：CRUD操作（6个方法）
  - 预期结果：可完整管理关系数据

### 阶段2：关系列表功能（基础UI）

- [ ] **Step 2.1**：创建关系列表页面UI框架
  - 文件：`lib/screens/character_relationship_screen.dart`
  - 实现：AppBar、TabBar、TabView基础结构
  - 预期结果：可导航到的空白页面

- [ ] **Step 2.2**：实现关系卡片组件
  - 文件：`lib/screens/character_relationship_screen.dart`
  - 组件：`_buildRelationshipCard()`
  - 预期结果：展示单个关系信息

- [ ] **Step 2.3**：实现关系列表加载逻辑
  - 文件：`lib/screens/character_relationship_screen.dart`
  - 方法：`_loadRelationships()`
  - 预期结果：按Tab分类显示关系

### 阶段3：关系编辑功能（交互）

- [ ] **Step 3.1**：创建关系编辑对话框
  - 文件：`lib/widgets/relationship_edit_dialog.dart`
  - 实现：表单字段（目标角色、关系类型、描述）
  - 预期结果：弹出对话框，可输入关系信息

- [ ] **Step 3.2**：实现新建关系逻辑
  - 文件：`lib/widgets/relationship_edit_dialog.dart`
  - 方法：调用 `DatabaseService.createRelationship()`
  - 预期结果：保存成功后刷新列表

- [ ] **Step 3.3**：实现编辑关系逻辑
  - 文件：`lib/widgets/relationship_edit_dialog.dart`
  - 方法：调用 `DatabaseService.updateRelationship()`
  - 预期结果：更新关系后刷新列表

- [ ] **Step 3.4**：实现删除关系逻辑
  - 文件：`lib/screens/character_relationship_screen.dart`
  - 方法：`_deleteRelationship()`
  - 预期结果：二次确认后删除关系

### 阶段4：角色管理页面集成（入口）

- [ ] **Step 4.1**：角色卡片添加关系徽章
  - 文件：`lib/screens/character_management_screen.dart`
  - 组件：`_buildCharacterCard()` 添加Badge
  - 预期结果：显示关系数量

- [ ] **Step 4.2**：实现关系数量查询
  - 文件：`lib/services/database_service.dart`
  - 方法：`Future<int> getRelationshipCount(int characterId)`
  - 预期结果：返回某角色的关系总数

- [ ] **Step 4.3**：添加长按菜单选项
  - 文件：`lib/screens/character_management_screen.dart`
  - 方法：`_showCharacterOptions()`
  - 预期结果：长按显示"查看关系"选项

- [ ] **Step 4.4**：实现页面跳转
  - 文件：`lib/screens/character_management_screen.dart`
  - 方法：`Navigator.push` 到 `CharacterRelationshipScreen`
  - 预期结果：打开关系列表页面

### 阶段5：关系图可视化（高级功能）

- [ ] **Step 5.1**：调研关系图库
  - 任务：评估 `flutter_graph`、`graphview`、`custom_paint`
  - 决策：选择最合适的绘图方案
  - 预期结果：确定技术方案

- [ ] **Step 5.2**：创建关系图页面框架
  - 文件：`lib/screens/character_relationship_graph_screen.dart`
  - 实现：基础Canvas绘制
  - 预期结果：显示节点和边

- [ ] **Step 5.3**：实现节点绘制逻辑
  - 文件：`lib/screens/character_relationship_graph_screen.dart`
  - 方法：`_drawNodes()`
  - 预期结果：显示角色头像节点

- [ ] **Step 5.4**：实现边绘制逻辑
  - 文件：`lib/screens/character_relationship_graph_screen.dart`
  - 方法：`_drawEdges()`
  - 预期结果：显示有向箭头和关系类型

- [ ] **Step 5.5**：实现点击高亮交互
  - 文件：`lib/screens/character_relationship_graph_screen.dart`
  - 方法：`_handleNodeTap()`
  - 预期结果：点击节点高亮相关关系

- [ ] **Step 5.6**：实现布局算法
  - 文件：`lib/screens/character_relationship_graph_screen.dart`
  - 方法：`_calculateLayout()`
  - 预期结果：节点分布合理，无重叠

### 阶段6：测试与优化（质量保证）

- [ ] **Step 6.1**：单元测试
  - 文件：`test/unit/models/character_relationship_test.dart`
  - 测试：模型序列化、反序列化
  - 预期结果：所有测试通过

- [ ] **Step 6.2**：集成测试
  - 文件：`test/integration/relationship_crud_test.dart`
  - 测试：完整的关系CRUD流程
  - 预期结果：功能正常无Bug

- [ ] **Step 6.3**：UI交互测试
  - 任务：手动测试所有交互流程
  - 检查：空状态、错误处理、加载状态
  - 预期结果：用户体验流畅

- [ ] **Step 6.4**：性能优化
  - 任务：检查数据库查询性能
  - 优化：添加必要索引、减少N+1查询
  - 预期结果：无明显卡顿

---

## 七、技术风险与应对

### 风险1：关系图库选择困难
**应对**：
- 先实现基础 `CustomPainter` 版本
- 评估 `graphview` 包是否满足需求
- 必要时降级到静态图展示

### 风险2：数据库迁移失败
**应对**：
- 迁移前备份数据库
- 使用事务确保原子性
- 提供回滚机制

### 风险3：大量角色时性能问题
**应对**：
- 初始版本限制关系图显示数量（如最多20个节点）
- 添加分页或虚拟滚动
- 后期版本考虑懒加载

---

## 八、验收标准

### 功能完整性
- ✅ 可创建角色关系（完全自定义类型）
- ✅ 可查看某角色的所有关系（分类Tab）
- ✅ 可编辑/删除关系
- ✅ 可在关系图中可视化关系网络
- ✅ 点击节点高亮相关关系

### 数据完整性
- ✅ 删除角色时级联删除关系
- ✅ 不允许重复创建相同关系
- ✅ 数据库事务正常回滚

### 用户体验
- ✅ UI风格与现有页面一致
- ✅ 交互响应及时（< 100ms）
- ✅ 错误提示友好清晰
- ✅ 空状态引导明确

---

## 九、后续优化方向（V2）

1. **关系图高级交互**：拖拽节点、缩放画布、导出图片
2. **关系类型智能推荐**：基于历史输入自动补全
3. **关系路径查询**：查找两个角色之间的最短路径
4. **关系群组分析**：自动识别角色社群
5. **关系时间轴**：展示关系随时间的变化

---

## 十、注意事项

1. **代码规范**：
   - 遵循现有Flutter项目代码风格
   - 使用 `final` 声明不可变变量
   - 添加必要的注释和文档

2. **数据库版本管理**：
   - 严格遵循迁移脚本规范
   - 测试升级和降级场景
   - 记录每次版本变更内容

3. **UI一致性**：
   - 复用现有UI组件（如头像加载器）
   - 遵循Material Design 3设计语言
   - 保持与角色管理页面视觉一致

4. **错误处理**：
   - 所有数据库操作包含try-catch
   - 用户友好的错误提示
   - 关键操作添加二次确认

---

**计划状态**：待批准
**下一步**：等待用户确认计划，开始执行
