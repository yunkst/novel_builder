# 角色别名列表功能 - 执行计划

## 任务上下文

**目标**: 为角色模型增加别名列表功能，在角色匹配时如果别名列表中的名字出现也认为匹配到该角色

**用户选择**:
- 编辑方式: 标签式输入，每个别名单独添加/删除
- 匹配优先级: 报告冲突让用户选择
- 数量限制: 上限10个别名

**技术方案**: 方案2 - JSON字段存储
- 在 `characters` 表添加 `aliases TEXT` 字段，存储JSON数组 `["小李","阿明"]`

## 涉及文件

### 需要修改的文件
1. `novel_app/lib/models/character.dart` - Character 模型
2. `novel_app/lib/services/database_service.dart` - 数据库服务和迁移
3. `novel_app/lib/utils/character_matcher.dart` - 角色匹配工具
4. `novel_app/lib/screens/character_edit_screen.dart` - 角色编辑界面

### 需要更新的测试文件
1. `test/unit/controllers/*_test.mocks.dart` - Mock文件

---

## 执行步骤

### 步骤1: 修改 Character 模型

**文件**: `novel_app/lib/models/character.dart`

**操作**:
1. 添加 `aliases` 字段：`final List<String>? aliases;`
2. 更新构造函数参数
3. 更新 `toMap()` 方法：将 `aliases` 转为JSON字符串存储
4. 更新 `fromMap()` 方法：将JSON字符串解析为 `List<String>`
5. 更新 `copyWith()` 方法

**预期结果**: Character 模型支持别名列表

---

### 步骤2: 数据库迁移

**文件**: `novel_app/lib/services/database_service.dart`

**操作**:
1. 更新数据库版本: `version: 11` → `version: 12`
2. 在 `_onUpgrade()` 中添加版本 12 的迁移逻辑:
   ```sql
   ALTER TABLE characters ADD COLUMN aliases TEXT DEFAULT '[]'
   ```
3. 更新 `createCharacter()` 方法：将 `aliases` 序列化为JSON
4. 更新 `updateCharacter()` 方法：将 `aliases` 序列化为JSON
5. 更新 `getCharacters()` 的 `Character.fromMap()` 解析

**预期结果**: 数据库支持存储别名，迁移从v11到v12

---

### 步骤3: 修改 CharacterMatcher 匹配逻辑

**文件**: `novel_app/lib/utils/character_matcher.dart`

**操作**:
1. 修改 `extractCharactersFromChapter()` 方法：
   - 检查角色名称或别名是否在章节内容中出现
   - 收集所有匹配的角色及其匹配方式（正式名称/别名）
2. 修改 `isCharacterInChapter()` 方法：
   - 检查角色名称或别名是否出现
3. 修改 `countCharacterOccurrences()` 方法：
   - 统计角色名称+所有别名的出现次数
4. 新增 `_checkAliasConflict()` 方法：
   - 检测别名冲突：别名A是否也是角色B的正式名称
   - 返回冲突信息让用户选择

**预期结果**: 角色匹配支持别名，并检测冲突

---

### 步骤4: 角色编辑界面 - 别名编辑UI

**文件**: `novel_app/lib/screens/character_edit_screen.dart`

**操作**:
1. 添加状态变量: `List<String> _aliases = []`
2. 在 `_initializeData()` 中加载别名: `character.aliases ?? []`
3. 在基本信息区域添加别名编辑组件:
   - 显示已添加的别名标签（可删除）
   - 输入框 + 添加按钮
   - 限制最多10个
   - 验证别名不为空、不重复
4. 在 `_saveCharacter()` 中保存别名
5. 在 `_refreshCharacterData()` 中刷新别名

**UI组件设计**:
```
┌─────────────────────────────────────┐
│ 别名 (最多10个)                      │
│ ┌─────┐ ┌─────┐ ┌─────┐              │
│ │小李 │ │阿明 │ │  X  │ [添加别名]    │
│ └─────┘ └─────┘ └─────┘              │
│ 输入新别名: [________] [添加]         │
└─────────────────────────────────────┘
```

**预期结果**: 用户可以在编辑界面添加/删除别名

---

### 步骤5: 别名冲突处理

**文件**: `novel_app/lib/screens/character_edit_screen.dart`

**操作**:
1. 添加 `_checkAliasConflict()` 方法
2. 在添加别名时调用检测：
   - 查询所有角色的正式名称
   - 检查新别名是否与某个角色的正式名称冲突
   - 如果冲突，显示对话框让用户选择：
     - 取消添加
     - 仍要添加（可能导致匹配问题）
3. 在保存前再次检测现有别名冲突

**对话框设计**:
```
┌─────────────────────────────────────┐
│ 检测到别名冲突                       │
│                                      │
│ 别名 "张三" 与角色 "李四" 的正式名称  │
│ 完全相同，可能导致匹配混乱。          │
│                                      │
│        [取消]  [仍要添加]            │
└─────────────────────────────────────┘
```

**预期结果**: 用户在添加冲突别名时会收到警告

---

### 步骤6: 更新相关服务层代码

**文件**: 多个使用 Character 的地方

**操作**:
1. 检查 `Character.formatForAI()` 是否需要包含别名信息
2. 检查 `Character.toRoleInfoList()` 是否需要传递别名（后端可能需要支持）

**预期结果**: 相关服务正确处理别名

---

### 步骤7: 测试功能

**测试用例**:
1. 创建角色，添加多个别名，保存成功
2. 编辑现有角色，添加/删除别名
3. 别名数量限制测试（超过10个提示）
4. 别名重复检测
5. 别名冲突检测和警告
6. 角色匹配：章节内容中出现别名时正确匹配
7. 数据库迁移：从v11升级到v12，别名字段默认为空数组

**预期结果**: 所有功能正常工作

---

## 数据模型变更

### Character 模型新增字段

```dart
final List<String>? aliases;  // 别名列表，上限10个
```

### 数据库表结构变更

```sql
-- 版本 12
ALTER TABLE characters ADD COLUMN aliases TEXT DEFAULT '[]';
```

---

## 注意事项

1. **JSON序列化**: 使用 `jsonEncode()` 和 `jsonDecode()` 处理别名列表
2. **空值处理**: `aliases` 为 null 时等同于空列表 `[]`
3. **性能考虑**: 每次匹配需要遍历所有角色的所有别名，但角色数量通常较少
4. **兼容性**: 已有角色默认 `aliases = []`，不影响现有功能
