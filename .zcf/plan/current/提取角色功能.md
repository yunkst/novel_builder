# 提取角色功能 - 执行计划

## 任务上下文

**目标**: 在角色管理页面的 "AI创建角色" 对话框中新增 "提取角色" 功能

**用户确认**:
- 上下文长度默认值：500字
- 上下文长度上限：10万字
- 提取结果格式：与 AI 生成角色相同，自动填充到角色编辑表单
- 章节排序：按故事发展时间线（从旧到新）

## 涉及文件

### 需要修改的文件
1. `lib/widgets/character_input_dialog.dart` - 添加提取角色UI
2. `lib/services/dify_service.dart` - 添加 `extractCharacter` 方法
3. `lib/services/database_service.dart` - 添加章节搜索方法（可能已有）

### 需要新建的文件
1. `lib/services/character_extraction_service.dart` - 角色提取服务

---

## 执行步骤

### 步骤1: 创建角色提取服务

**文件**: `lib/services/character_extraction_service.dart`

**操作**:
1. 创建 `CharacterExtractionService` 类
2. 实现 `searchChaptersByName()` 方法：
   - 输入：`novelUrl`, `names`（正式名+别名列表）
   - 输出：匹配的章节列表（包含匹配次数）
   - 逻辑：在 `chapter_cache` 表中搜索包含名字的章节
3. 实现 `extractContextAroundMatches()` 方法：
   - 输入：`content`, `names`, `contextLength`, `useFullChapter`
   - 输出：提取的上下文片段列表
   - 逻辑：
     - `useFullChapter=true`: 返回整章
     - `useFullChapter=false`: 在名字前后各取 `contextLength/2` 字
4. 实现 `mergeAndDeduplicateContexts()` 方法：
   - 输入：上下文片段列表
   - 输出：合并去重后的字符串
   - 逻辑：相邻/重叠的段落合并

**预期结果**: 角色提取服务核心功能

---

### 步骤2: 修改 CharacterInputDialog UI

**文件**: `lib/widgets/character_input_dialog.dart`

**操作**:
1. 添加模式选择：三个单选按钮
   - "AI描述创建"
   - "从大纲生成"
   - "提取角色"（新增）
2. 根据模式显示不同输入区域：
   - 提取角色模式显示：
     - 角色正式名称输入框
     - 别名输入框（逗号分隔）
     - 上下文长度滑块（500-100000）
     - 提取模式单选：上下文/整章
     - 搜索按钮
     - 章节列表（可多选）
     - 预计内容长度提示
3. 添加 `_mode` 状态变量（create/outline/extract）
4. 添加提取相关状态变量：
   - `_nameController`
   - `_aliasesController`
   - `_contextLength` (默认500)
   - `_extractFullChapter` (默认false)
   - `_matchedChapters` (搜索结果)
   - `_selectedChapterIds` (选中的章节)

**预期结果**: UI 支持三种模式切换

---

### 步骤3: 实现章节搜索功能

**文件**: `lib/widgets/character_input_dialog.dart`

**操作**:
1. 实现 `_searchChapters()` 方法：
   - 解析别名输入
   - 调用 `CharacterExtractionService.searchChaptersByName()`
   - 更新 `_matchedChapters` 状态
   - 按章节索引排序（从旧到新）
2. 实现章节列表UI：
   - 显示章节标题、匹配次数
   - 支持全选/取消全选
   - 实时更新预计内容长度

**预期结果**: 用户可搜索并选择章节

---

### 步骤4: 实现上下文提取和合并

**文件**: `lib/widgets/character_input_dialog.dart`

**操作**:
1. 实现 `_extractAndMergeContent()` 方法：
   - 获取选中章节的完整内容
   - 调用 `CharacterExtractionService.extractContextAroundMatches()`
   - 调用 `CharacterExtractionService.mergeAndDeduplicateContexts()`
   - 计算最终内容长度
2. 在确认按钮点击时调用此方法

**预期结果**: 获得合并去重后的内容

---

### 步骤5: 添加 Dify extractCharacter 方法

**文件**: `lib/services/dify_service.dart`

**操作**:
1. 添加 `extractCharacter()` 方法：
   ```dart
   Future<List<Character>> extractCharacter({
     required String chapterContent,
     required String roles,
     required String novelUrl,
   }) async {
     final inputs = {
       'chapter_content': chapterContent,
       'roles': roles,
       'cmd': '提取角色',
     };
     // 复用 generateCharacters 的返回值处理逻辑
   }
   ```

**预期结果**: Dify 服务支持提取角色

---

### 步骤6: 集成到角色管理页面

**文件**: `lib/screens/character_management_screen.dart`

**操作**:
1. 修改 `_aiCreateCharacter()` 方法：
   - 检查返回的 `mode` 字段
   - 如果是 `extract`，调用 `DifyService.extractCharacter()`
   - 处理返回的角色列表（与现有逻辑相同）

**预期结果**: 提取角色功能完整可用

---

### 步骤7: 测试

**测试用例**:
1. 输入角色名和别名，搜索章节成功
2. 上下文长度滑块限制有效
3. 整章模式正确提取完整内容
4. 上下文模式正确截取片段
5. 相邻段落去重生效
6. Dify 返回结果正确填充到角色编辑表单
7. 内容长度超过10万时提示用户

**预期结果**: 所有功能正常工作

---

## Dify API 参数

```json
{
  "inputs": {
    "chapter_content": "搜索并组合的章节内容",
    "roles": "角色名、别名1、别名2",
    "cmd": "提取角色"
  },
  "response_mode": "blocking",
  "user": "novel-builder-app"
}
```

---

## 数据流

```
用户输入角色名/别名
    ↓
搜索本地数据库匹配的章节
    ↓
用户选择章节和提取模式
    ↓
提取上下文 → 去重合并
    ↓
发送给 Dify (cmd=提取角色)
    ↓
Dify 返回角色列表
    ↓
填充到角色编辑表单
```

---

## 注意事项

1. **内容长度限制**: 提取内容超过10万字时需要警告用户
2. **章节排序**: 必须按章节索引升序排列（故事发展时间线）
3. **别名解析**: 支持逗号、分号、空格分隔
4. **性能考虑**: 搜索可能较慢，显示加载提示
