# 执行计划：删除死代码并重构细纲生成

## 上下文

项目中存在未使用的死代码和两套流式生成实现：
- **UnifiedStreamManager**: 仅被 OutlineDraftController 使用，有15秒超时限制
- **DifyStreamingMixin**: 被6个功能使用，无超时限制

**问题**: 细纲生成使用 UnifiedStreamManager，导致15秒超时卡住

## 解决方案

采用方案1（渐进式迁移）：
1. 删除所有死代码
2. 重构细纲生成使用 DifyStreamingMixin
3. 统一流式生成架构

## 执行步骤

### ✅ 步骤 1：扫描死代码
确认以下文件可安全删除：
- `lib/controllers/paragraph_rewrite_controller.dart` - 完全未使用
- `lib/controllers/summarize_controller.dart` - 无导入
- `lib/services/unified_stream_manager.dart` - 仅被上述文件使用
- `lib/models/stream_config.dart` - 仅被上述文件使用
- `lib/widgets/stream_content_widget.dart` - 无导入
- `lib/controllers/outline_draft_controller.dart` - 将被重构

### ✅ 步骤 2-3：重构 OutlineDraftController
**决策**: 不使用单独的 Controller，直接在 Screen State 中使用 DifyStreamingMixin

**原因**: DifyStreamingMixin 只能用于 `State<StatefulWidget>`，不能用于普通 ChangeNotifier

**修改**: `lib/screens/insert_chapter_screen.dart`
1. 添加 `import '../mixins/dify_streaming_mixin.dart';`
2. 删除 `import '../controllers/outline_draft_controller.dart';`
3. State 类添加 `with DifyStreamingMixin`
4. 删除 `_draftController` 字段
5. 修改 `_generateOutlineDraft()` 方法使用 `callDifyStreaming()`
6. 修改 `_regenerateDraft()` 方法使用 `callDifyStreaming()`
7. 替换所有 `_draftController.isLoading` 为 `isStreaming`
8. 替换所有 `_draftController.streamedContent` 为 `_draftEditingController.text`

### ✅ 步骤 4-5：删除死代码
删除以下文件：
```bash
rm lib/controllers/paragraph_rewrite_controller.dart
rm lib/controllers/summarize_controller.dart
rm lib/services/unified_stream_manager.dart
rm lib/models/stream_config.dart
rm lib/widgets/stream_content_widget.dart
rm lib/controllers/outline_draft_controller.dart
```

### ✅ 步骤 6：验证
- ✅ `flutter analyze` 无错误
- ✅ 只有2个已存在的 info 级别警告（与本次修改无关）

## 核心变更

### 细纲生成流式调用（新实现）

```dart
// 在 _InsertChapterScreenState 中（with DifyStreamingMixin）
await callDifyStreaming(
  inputs: {
    'cmd': '生成细纲',
    'outline': _outline!.content,
    'history_chapters_content': _cachedPreviousChapters!.join('\n\n'),
    'outline_item': '',  // 或 existingDraft
    'user_input': userInput,
  },
  onChunk: (chunk) {
    _draftEditingController.text += chunk;
    _draftEditingController.selection = TextSelection.fromPosition(
      TextPosition(offset: _draftEditingController.text.length),
    );
  },
  startMessage: 'AI正在生成章节细纲...',
  completeMessage: '细纲生成完成',
  errorMessagePrefix: '细纲生成失败',
);
```

### 关键优势

1. **无超时限制**: 解决15秒超时卡住问题
2. **统一架构**: 所有AI生成都使用 DifyStreamingMixin
3. **代码简化**: 删除 UnifiedStreamManager 和相关配置
4. **减少文件**: 删除6个死代码文件

## 测试建议

1. 打开插入章节页面
2. 选择大纲模式
3. 点击"生成细纲"
4. 验证流式显示正常
5. 验证可以重新生成
6. 验证取消功能
7. 验证错误处理

## 文件变更汇总

### 修改的文件
- ✏️ `lib/screens/insert_chapter_screen.dart` - 使用 DifyStreamingMixin

### 删除的文件（6个）
- ❌ `lib/controllers/paragraph_rewrite_controller.dart`
- ❌ `lib/controllers/summarize_controller.dart`
- ❌ `lib/controllers/outline_draft_controller.dart`
- ❌ `lib/services/unified_stream_manager.dart`
- ❌ `lib/models/stream_config.dart`
- ❌ `lib/widgets/stream_content_widget.dart`

## 成功标准

✅ 所有死代码已删除
✅ 细纲生成使用 DifyStreamingMixin
✅ `flutter analyze` 无错误
✅ 无超时限制问题
✅ 代码符合项目规范

## 执行时间

- 开始时间: 2025-01-06
- 完成时间: 2025-01-06
- 总耗时: 约20分钟

## 备注

- DifyStreamingMixin 底层调用 DifyService.runWorkflowStreaming()
- 不再使用 UnifiedStreamManager 和 StreamConfig
- 保持了原有的功能和用户体验
