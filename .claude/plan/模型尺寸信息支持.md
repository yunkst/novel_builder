# 模型尺寸信息支持功能 - 执行计划

## 任务上下文

在后端生图模型选择时，提供图片的尺寸信息。图片尺寸信息通过配置文件获取，APP选择框默认选择配置文件中设置的默认模型，在展示图片的插图组件中，插图组件的高度受到尺寸比例的影响。生成视频逻辑不需要变化。

## 执行时间

- 开始时间：2026-01-04
- 状态：已完成实施

## 实施方案

### 方案选择
采用 **配置文件驱动** 方案：
- 在 `workflows.yaml` 中手动添加 `width/height` 字段
- 扩展后端API返回尺寸和默认标志信息
- 前端组件显示尺寸并自动选中默认模型
- 插图组件根据图片比例计算高度

## 实施步骤

### 1. ✅ 更新 workflows.yaml 配置文件
**文件**：`backend/workflows.yaml`

**变更**：为 T2I 工作流添加尺寸字段
```yaml
t2i:
  - title: "动漫风"
    path: "./comfyui_json/text2img/t2i_704x1408.json"
    description: "用于生成角色卡的标准文生图工作流"
    width: 704
    height: 1280
```

### 2. ✅ 扩展后端数据模型
**文件**：
- `backend/app/workflow_config/models.py`
- `backend/app/workflow_config/workflow_config.py`
- `backend/app/schemas.py`

**变更**：
- `WorkflowInfo` 添加 `width`, `height`, `is_default` 字段
- `WorkflowResponse` 添加 `width`, `height` 字段

### 3. ✅ 更新后端 API
**文件**：`backend/app/main.py`

**变更**：
- 修改 `/api/models` 接口，返回尺寸和默认标志
- 获取默认T2I模型并在列表中标记 `is_default=true`

### 4. ✅ 修改前端 ModelSelector 组件
**文件**：`novel_app/lib/widgets/model_selector.dart`

**变更**：
- 改为加载完整的 `WorkflowInfo` 对象而非仅标题
- 显示尺寸信息：`704 × 1280`
- 显示默认标签：蓝色"默认"徽章
- 自动选中 `is_default=true` 的模型

### 5. ✅ 增强插图组件
**文件**：`novel_app/lib/widgets/scene_illustration_image_widget.dart`

**变更**：
- 添加 `imageWidth` 和 `imageHeight` 参数
- 实现 `_calculateHeight()` 方法：
  - 优先使用显式设置的 height
  - 根据 width 和宽高比计算 height
  - 返回 null 让组件自适应

### 6. ✅ 重新生成API客户端
**命令**：`dart run tool/generate_api.dart`

**结果**：生成的 `WorkflowInfo` 模型包含 `width`, `height`, `isDefault` 字段

## 代码变更统计

### 后端文件（4个）
- `backend/workflows.yaml` - 添加尺寸配置
- `backend/app/workflow_config/models.py` - 扩展响应模型
- `backend/app/workflow_config/workflow_config.py` - 更新配置管理
- `backend/app/schemas.py` - 扩展API模式
- `backend/app/main.py` - 更新API返回逻辑

### 前端文件（2个）
- `novel_app/lib/widgets/model_selector.dart` - 完全重写
- `novel_app/lib/widgets/scene_illustration_image_widget.dart` - 添加比例计算

### 生成文件
- `novel_app/generated/api/lib/src/model/workflow_info.dart` - 更新模型

## 功能特性

1. **后端配置**：
   - ✅ T2I工作流包含width/height字段
   - ✅ I2V工作流保持不变
   - ✅ API返回包含尺寸和默认标志

2. **前端显示**：
   - ✅ 下拉菜单显示模型标题
   - ✅ 显示尺寸信息（如：704 × 1280）
   - ✅ 默认模型显示蓝色"默认"徽章
   - ✅ 自动选中默认模型

3. **插图适配**：
   - ✅ 根据图片尺寸比例自动计算高度
   - ✅ 支持显式高度覆盖
   - ✅ 保持原有功能不变

## 待测试

- [ ] 启动后端服务验证API返回
- [ ] 启动Flutter应用验证UI显示
- [ ] 验证默认模型自动选中
- [ ] 验证插图高度自适应
- [ ] 确认I2V模型不受影响

## 设计决策

1. **为什么不在API中单独添加默认模型接口？**
   - 用户建议：在模型列表中添加 `is_default` 标志更简洁
   - 采用方案：在 `/api/models` 响应中标记默认模型

2. **为什么使用配置文件而非自动解析JSON？**
   - 配置清晰明确，易于维护
   - 支持不同模型的尺寸差异
   - 前后端解耦

3. **插图高度计算优先级**：
   - 显式设置的 height > 根据比例计算 > null（自适应）

## 注意事项

1. API客户端已重新生成，需要运行 `flutter pub get`
2. 插图组件需要传入 `imageWidth` 和 `imageHeight` 才能启用比例计算
3. 默认模型通过 `workflows.yaml` 中的 `default_t2i_model` 配置
