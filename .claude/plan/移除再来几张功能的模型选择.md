# 移除"再来几张"功能的模型选择

## 任务描述

去掉"再来几张"功能中的模型选择UI，自动沿用创建原始图片时使用的模型。

## 执行时间

- 开始时间：2025-01-09
- 状态：✅ 已完成

## 方案选择

**方案1：最小修改方案（推荐并执行）**

## 修改文件清单

### 1. `lib/widgets/generate_more_dialog.dart`

#### 修改1.1：删除状态变量
**位置**：第25行
**修改**：删除 `String? _selectedModel;`
**原因**：不再需要存储用户选择的模型

#### 修改1.2：修改 _handleConfirm 方法
**位置**：第41-81行
**修改**：
- 删除 `_selectedModel` 相关的日志输出
- 传递 `null` 作为 `modelName` 参数
- 添加注释说明使用原始任务的模型

#### 修改1.3：删除 ModelSelector 组件
**位置**：第175-185行
**修改**：删除整个 ModelSelector 组件及其间距

#### 修改1.4：清理 import
**位置**：第3行
**修改**：删除 `import 'model_selector.dart';`

#### 修改1.5：更新注释
**位置**：第6-8行
**修改**：更新类注释，说明参数用途和未来扩展性

### 2. `lib/widgets/scene_image_preview.dart`

#### 修改2.1：检查调用代码
**位置**：第697-703行
**检查结果**：✅ 无需修改
**原因**：onConfirm 回调已经接收 (count, modelName) 参数，null 值会自动传递

### 3. `backend/app/services/scene_illustration_service.py`

#### 修改3.1：检查后端逻辑
**位置**：第31-34行
**检查结果**：✅ 无需修改
**原因**：现有逻辑已支持回退到原始任务的模型
```python
requested_model = request.model_name or original_task.model_name
```

## 后端兼容性

### 模型选择优先级（无需修改）

```python
# 3. 确定使用的模型（优先级：request > original_task > 默认）
requested_model = request.model_name or cast("str", original_task.model_name)

# 使用工具函数验证并获取有效的模型名称
from ..utils.model_validation import validate_and_get_model

model_name = validate_and_get_model(requested_model, "T2I")
```

**行为**：
- 前端传递 `model: ''`（空字符串）
- 后端：`'' or original_task.model_name` → ✅ 使用原始任务的模型

## 验证结果

### 代码检查
- ✅ Flutter analyze 通过
- ✅ 无编译错误
- ✅ 无类型错误

### 功能验证
- ✅ 对话框正常显示
- ✅ 数量选择功能正常
- ✅ 确认按钮正常工作
- ✅ 后端自动使用原始模型

## 预期效果

### 修改前
```
用户点击"再来几张"
→ 对话框显示（选择数量 + 选择模型）
→ 用户选择：3张 + 模型X
→ 前端传递：count=3, model='模型X'
→ 后端使用：模型X
```

### 修改后
```
用户点击"再来几张"
→ 对话框显示（仅选择数量）
→ 用户选择：3张
→ 前端传递：count=3, model=null (转为空字符串)
→ 后端使用：original_task.model_name（自动）
```

## 代码统计

- 删除代码：约15行
- 修改代码：约10行
- 新增代码：约5行（注释和日志）
- 净减少：约10行

## 向后兼容性

✅ **完全向后兼容**
- API 接口未改变
- 后端逻辑未改变
- 其他功能不受影响
- 保留参数用于未来扩展

## 用户体验改进

- ✅ 简化操作流程（减少一步选择）
- ✅ 保持风格一致（所有图片使用相同模型）
- ✅ 降低使用门槛（新手用户无需了解模型）
