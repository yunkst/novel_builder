# 生图宽高信息记录与展示

## 任务概述

在生成图片任务时，记录模型的宽度和高度信息，在生图调试页面和文章阅读页面都能正确设置图片的宽高比。

**核心方案**：后端在 `SceneGalleryResponse` API 中返回模型信息，前端实时获取并使用，不保存到本地数据库。

## 技术上下文

### 当前数据流
```
用户选择模型 (ModelSelector)
    ↓
WorkflowInfo 包含 width, height
    ↓
创建生图任务 (model_name)
    ↓
后端 SceneIllustrationTask 存储了 model_name
    ↓
前端获取 SceneGalleryResponse (只有 task_id 和 images)
    ↓
❌ 缺少宽高信息
```

### 目标数据流
```
用户选择模型 (ModelSelector)
    ↓
WorkflowInfo 包含 width, height
    ↓
创建生图任务 (model_name)
    ↓
后端 SceneIllustrationTask 存储了 model_name
    ↓
前端获取 SceneGalleryResponse (包含 task_id, images, model_name, model_width, model_height)
    ↓
✅ SceneImagePreview 使用正确的宽高比
```

## 执行计划

### 后端改动

#### 1. 修改 SceneGalleryResponse Schema
**文件**: `backend/app/schemas.py`

**位置**: 第 348 行附近

**改动**:
```python
class SceneGalleryResponse(BaseModel):
    """场面图片列表响应模式."""

    task_id: str = Field(..., description="场面绘制任务ID")
    images: list[str] = Field(..., description="图片文件名列表")
    # 新增字段
    model_name: str | None = Field(None, description="使用的模型名称")
    model_width: int | None = Field(None, description="模型宽度")
    model_height: int | None = Field(None, description="模型高度")
```

**预期结果**: Schema 定义包含模型信息字段

---

#### 2. 创建模型配置映射
**文件**: `backend/app/config/models.py` (新建)

**内容**:
```python
"""模型配置映射"""

MODEL_DIMENSIONS = {
    # 文生图模型 (text2img)
    "text2img_704x1280": {"width": 704, "height": 1280},
    "text2img_768x1280": {"width": 768, "height": 1280},
    "text2img_512x512": {"width": 512, "height": 512},
    # ... 根据实际模型列表添加

    # 图生视频模型 (img2video)
    "img2video_704x1280": {"width": 704, "height": 1280},
    # ... 根据实际模型列表添加
}

def get_model_dimensions(model_name: str) -> tuple[int, int] | None:
    """获取模型的宽高信息

    Args:
        model_name: 模型名称

    Returns:
        (width, height) 元组，如果未找到则返回 None
    """
    dimensions = MODEL_DIMENSIONS.get(model_name)
    if dimensions:
        return (dimensions["width"], dimensions["height"])
    return None
```

**预期结果**: 配置文件包含所有模型的宽高映射

---

#### 3. 修改 get_scene_gallery 方法
**文件**: `backend/app/services/scene_illustration_service.py`

**位置**: 第 237-348 行 `get_scene_gallery` 方法

**改动逻辑**:
1. 在返回 SceneGalleryResponse 之前，查询 SceneIllustrationTask 获取 model_name
2. 如果 model_name 存在，从模型配置中查找对应的宽高信息
3. 在返回的响应中包含这些信息

**伪代码**:
```python
# 导入配置
from app.config.models import get_model_dimensions

# 第 348 行之前添加
task_record = db.query(SceneIllustrationTask).filter(
    SceneIllustrationTask.task_id == task_id
).first()

model_name = task_record.model_name if task_record else None
model_width = None
model_height = None

if model_name:
    dimensions = get_model_dimensions(model_name)
    if dimensions:
        model_width, model_height = dimensions

# 修改返回语句（第 348 行）
return SceneGalleryResponse(
    task_id=task_id,
    images=all_images,
    model_name=model_name,
    model_width=model_width,
    model_height=model_height
)
```

**预期结果**: API 响应包含完整的模型信息

---

### 前端改动

#### 3. 重新生成 API 代码
**命令**: 重新运行 API 代码生成工具

**预期结果**: `SceneGalleryResponse` Dart 模型包含新字段

---

#### 4. 修改 _sceneGalleryResponseToMap 方法
**文件**: `novel_app/lib/services/api_service_wrapper.dart`

**位置**: 第 706-712 行

**改动**:
```dart
Map<String, dynamic> _sceneGalleryResponseToMap(
    SceneGalleryResponse response) {
  return {
    'task_id': response.taskId,
    'images': response.images.toList(),
    'model_name': response.modelName,
    'model_width': response.modelWidth,
    'model_height': response.modelHeight,
  };
}
```

**预期结果**: Map 包含模型信息字段

---

#### 5. 修改 SceneImagePreview 组件
**文件**: `novel_app/lib/widgets/scene_image_preview.dart`

**位置**: `_loadIllustrationFromBackend` 方法（第 91-124 行）

**改动逻辑**:
1. 修改组件状态，添加 `modelWidth` 和 `modelHeight` 字段
2. 从 API 响应中解析宽高信息
3. 将宽高信息传递给图片展示组件

**关键代码**:
```dart
class _SceneImagePreviewState extends State<SceneImagePreview> {
  // 添加状态
  int? _modelWidth;
  int? _modelHeight;

  Future<void> _loadIllustrationFromBackend() async {
    // ...
    final galleryData = await apiService.getSceneIllustrationGallery(widget.taskId!);

    if (mounted) {
      setState(() {
        _images = List<String>.from(galleryData['images'] ?? []);
        _modelWidth = galleryData['model_width'];
        _modelHeight = galleryData['model_height'];
        _isLoading = false;
      });
    }
  }

  // 在 _calculateAspectRatio 中使用 _modelWidth 和 _modelHeight
  double _calculateAspectRatio() {
    if (_modelWidth != null && _modelHeight != null &&
        _modelWidth! > 0 && _modelHeight! > 0) {
      return _modelWidth! / _modelHeight!;
    }
    return 0.5; // 默认 1:2 竖屏
  }
}
```

**预期结果**: 组件使用 API 返回的宽高信息

---

#### 6. 修改 IllustrationDebugScreen
**文件**: `novel_app/lib/screens/illustration_debug_screen.dart`

**位置**: 第 226 行，`SceneImagePreview` 组件调用

**改动**: 无需改动，因为 SceneImagePreview 已经内部处理宽高

**预期结果**: 自动使用正确的宽高比

---

#### 7. 修改 ReaderScreen
**文件**: `novel_app/lib/screens/reader_screen.dart`

**位置**: SceneImagePreview 组件调用位置

**改动**: 同样无需改动，SceneImagePreview 内部处理

**预期结果**: 自动使用正确的宽高比

---

## 测试计划

### 测试场景 1: 生图调试页面
1. 创建新的生图任务，选择特定模型（如 512x512）
2. 等待图片生成完成
3. 在生图调试页面查看图片
4. **预期**: 图片以 1:1 的宽高比显示

### 测试场景 2: 文章阅读页面
1. 在文章阅读页面生成插图
2. 选择不同模型（如 704x1280 竖屏、768x1280 竖屏）
3. **预期**: 插图以正确的宽高比显示

### 测试场景 3: 历史数据兼容性
1. 查看之前生成的图片（无模型信息）
2. **预期**: 使用默认的 1:2 竖屏比例

---

## 待解决问题

### 后端模型配置来源
**问题**: 在 `get_scene_gallery` 方法中，如何根据 `model_name` 获取对应的宽高信息？

**可能的方案**:
1. **方案 A**: 从后端配置文件中维护模型名称到宽高的映射
2. **方案 B**: 调用模型列表 API（`/models`）动态获取
3. **方案 C**: 在 `SceneIllustrationTask` 表中直接存储宽高信息（推荐）

**推荐方案 C 的理由**:
- 创建任务时就已知模型宽高，直接存储最简单
- 避免运行时查询，性能最佳
- 数据完整性最好

---

## 实施顺序

1. ✅ **用户确认计划**
2. ⏳ **后端改动**（步骤 1-2）
3. ⏳ **前端 API 代码更新**（步骤 3-4）
4. ⏳ **前端组件修改**（步骤 5-7）
5. ⏳ **测试验证**（测试场景 1-3）

---

## 备注

- 前端不保存宽高信息到 SQLite，每次从后端 API 获取
- 历史数据（无模型信息）使用默认 1:2 竖屏比例
- 新数据自动使用正确的宽高比
