# 长按段落弹框交互优化 - 执行计划

## 项目上下文

### 任务描述
优化Flutter小说阅读应用中长按段落弹出的插图创建弹框交互逻辑：
- **当前行为**：长按段落 → 弹框自动请求Dify AI生成场景描述
- **目标行为**：长按段落 → 弹框显示但不自动请求Dify → 用户点击"AI生成画面"按钮 → 请求Dify

### 技术背景
- **项目**：Novel Builder - 全栈小说阅读平台
- **模块**：novel_app (Flutter移动应用)
- **主要文件**：`lib/widgets/scene_illustration_dialog.dart`
- **依赖技术**：Flutter 3.0+, Dify AI工作流, SQLite

### 实施方案
采用**混合增强方案**，平衡开发成本、风险控制和用户体验。

## 详细执行步骤

### 步骤1：修改初始化逻辑
**文件**：`scene_illustration_dialog.dart`
**函数**：`initState()` (第60-72行)
**操作**：移除自动AI调用

```dart
// 删除或注释掉这部分代码：
// Future.delayed(const Duration(milliseconds: 500), () {
//   if (mounted) {
//     _startSceneDescriptionGeneration();
//   }
// });
```

### 步骤2：设计AI生成按钮UI
**文件**：`scene_illustration_dialog.dart`
**位置**：场景描述输入框下方
**新增组件**：AI生成画面按钮

```dart
ElevatedButton.icon(
  onPressed: _isSceneGenerating ? null : _startSceneDescriptionGeneration,
  icon: _isSceneGenerating
    ? SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2))
    : Icon(Icons.auto_awesome),
  label: Text(_isSceneGenerating ? 'AI生成中...' : 'AI生成画面'),
  style: ElevatedButton.styleFrom(
    backgroundColor: Colors.blue,
    foregroundColor: Colors.white,
    minimumSize: Size(double.infinity, 48),
  ),
)
```

### 步骤3：优化输入框提示
**文件**：`scene_illustration_dialog.dart`
**组件**：TextField的decoration (第463-468行)
**操作**：添加引导性提示文字

```dart
decoration: InputDecoration(
  border: InputBorder.none,
  contentPadding: EdgeInsets.all(12),
  filled: true,
  fillColor: Colors.black,
  hintText: '请输入场景描述，或点击下方"AI生成画面"按钮自动生成',
  hintStyle: TextStyle(color: Colors.grey.shade400),
)
```

### 步骤4：移除冗余的重新生成按钮
**文件**：`scene_illustration_dialog.dart`
**位置**：第473-484行
**操作**：删除现有的"重新生成场景描写"按钮区域

### 步骤5：调整状态管理逻辑
**文件**：`scene_illustration_dialog.dart`
**函数**：`_startSceneDescriptionGeneration()` (第161行开始)
**操作**：优化生成前状态处理

```dart
Future<void> _startSceneDescriptionGeneration() async {
  if (_isSceneGenerating) return; // 防止重复调用

  // 清空现有内容
  setState(() {
    _contentController.text = '';
    _isSceneGenerating = true;
    _sceneGenerationError = null;
  });

  // 继续原有逻辑...
}
```

### 步骤6：优化错误处理和用户反馈
**文件**：`scene_illustration_dialog.dart`
**操作**：改进错误提示和状态反馈
- 在AI生成按钮下方显示错误信息
- 优化加载状态的视觉反馈
- 添加成功提示

### 步骤7：UI布局调整
**文件**：`scene_illustration_dialog.dart`
**区域**：场景描述部分 (第442-509行)
**重新排列顺序**：
1. 标题"场景描述"
2. 输入框（含提示文字）
3. AI生成按钮
4. 错误提示区域（条件显示）

## 预期结果

### 用户体验改进
1. **明确控制**：用户主动决定是否使用AI生成
2. **清晰引导**：通过按钮文字和提示文字引导用户操作
3. **减少困惑**：避免意外的AI调用和内容替换
4. **保持灵活**：支持手动输入和AI生成两种方式

### 技术效果
1. **性能优化**：减少不必要的AI API调用
2. **错误减少**：降低因自动调用导致的错误率
3. **维护性**：代码逻辑更清晰，状态管理更简单

### 兼容性保证
1. **向后兼容**：现有功能保持不变
2. **数据一致**：不涉及数据结构变更
3. **API接口**：不修改任何外部接口

## 质量保证计划

### 测试清单
- [ ] 弹框正常打开，不自动调用AI
- [ ] 输入框显示正确提示文字
- [ ] AI生成按钮初始状态正常
- [ ] 点击AI生成按钮后正确调用Dify
- [ ] 生成过程中按钮状态正确更新
- [ ] 错误情况处理正确
- [ ] 生成成功后内容正确显示
- [ ] 手动输入功能仍然正常
- [ ] 其他功能（角色选择、模型选择等）不受影响

### 回归测试
- 验证长按段落功能正常
- 验证插图创建流程完整
- 验证取消操作正常
- 验证生成的插图正确插入章节

## 实施时间表

| 步骤 | 预计时间 | 状态 |
|------|----------|------|
| 步骤1：修改初始化逻辑 | 5分钟 | 待执行 |
| 步骤2：设计AI生成按钮UI | 10分钟 | 待执行 |
| 步骤3：优化输入框提示 | 5分钟 | 待执行 |
| 步骤4：移除冗余按钮 | 5分钟 | 待执行 |
| 步骤5：调整状态管理 | 10分钟 | 待执行 |
| 步骤6：优化错误处理 | 10分钟 | 待执行 |
| 步骤7：UI布局调整 | 15分钟 | 待执行 |

**总计预计时间**：60分钟

## 风险控制

### 低风险项
- 移除自动AI调用逻辑
- 调整UI组件布局
- 修改提示文字

### 中风险项
- 状态管理逻辑调整
- 错误处理优化

### 应急预案
- 保留原始代码备份
- 分步骤提交，便于回滚
- 充分测试每个步骤

---

**创建时间**：2025-12-18
**执行状态**：等待用户批准
**负责人**：Claude Code Assistant