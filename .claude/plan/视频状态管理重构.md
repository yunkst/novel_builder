# 视频状态管理重构执行计划

## 背景与问题

原有视频状态管理存在以下问题：
- 视频状态与图片类型紧耦合，只有角色卡图片支持视频生成
- 双重状态系统导致数据不一致
- 查询逻辑复杂，需要先确定图片来源类型
- 状态更新分散，维护困难

## 解决方案

采用完全独立的视频状态模型，创建`ImageVideoStatus`表：
- 与图片来源完全解耦，基于`img_name`统一管理
- 单一状态来源，消除数据不一致问题
- 查询逻辑简化，直接查询状态表
- 支持任意类型图片的视频生成

## 执行步骤

### 已完成步骤

1. ✅ **创建独立视频状态模型** - `backend/app/models/video_status.py`
2. ✅ **更新Alembic配置** - `backend/alembic/env.py` 添加新模型导入
3. ✅ **更新模型包导入** - `backend/app/models/__init__.py`
4. ✅ **生成数据库迁移** - 创建新的独立状态表
5. ✅ **执行数据库迁移** - 在PostgreSQL中创建新表
6. ✅ **重构视频生成服务** - 完全重写核心逻辑使用新模型
7. ✅ **清理原有字段** - 移除`RoleImageGallery`中的video相关字段
8. ✅ **创建清理迁移** - 移除原有表中的video字段
9. ✅ **执行清理迁移** - 完成数据库结构清理
10. ✅ **测试验证** - 通过功能测试验证新逻辑正常

### 核心变更

#### 新增模型
- `ImageVideoStatus` - 独立的图片视频状态表
- 字段：`img_name`, `has_video`, `video_status`, `video_filename`等
- 索引：`img_name`唯一索引，状态查询索引

#### 重构服务方法
- `create_video_generation_task()` - 创建任务时同步创建状态记录
- `get_video_status()` - 简化为单表查询
- `_process_video_generation_async()` - 使用独立状态表管理生命周期

#### API接口兼容性
- `VideoStatusResponse`保持不变，向后兼容
- `has_video`接口逻辑大幅简化

## 技术优势

### 架构清晰
- 职责分离：图片表专注图片元数据，状态表专注视频管理
- 解耦设计：视频生成与图片来源类型无关
- 统一接口：所有图片类型使用相同的视频状态管理

### 数据一致性
- 单一状态源：避免双重状态系统的不一致问题
- 完整状态追踪：从请求到完成的全生命周期管理
- 事务安全：状态更新在同一事务中完成

### 性能优化
- 查询简化：`has_video`接口从双表查询简化为单表查询
- 索引优化：针对查询模式设计的复合索引
- 维护成本低：状态管理集中，易于调试

## 数据库变更

### 新增表
```sql
CREATE TABLE image_video_status (
    id SERIAL PRIMARY KEY,
    img_name VARCHAR(500) UNIQUE NOT NULL,
    has_video BOOLEAN DEFAULT FALSE NOT NULL,
    video_status VARCHAR(20) DEFAULT 'none' NOT NULL,
    video_filename VARCHAR(500),
    source_type VARCHAR(20) NOT NULL,
    -- 其他字段...
);
```

### 删除字段
- `role_image_gallery.video_status`
- `role_image_gallery.video_filename`
- `role_image_gallery.video_prompt`
- `role_image_gallery.video_created_at`

## 迁移策略

- 不保留现有数据，重新开始
- 接受短暂停机进行破坏性变更
- 使用Alembic进行数据库结构管理

## 验证结果

- ✅ 新模型创建成功
- ✅ 数据库迁移完成
- ✅ 服务逻辑重构完成
- ✅ 功能测试通过
- ✅ API接口兼容

## 后续建议

1. 监控新状态表的性能表现
2. 考虑添加状态变更的历史记录表
3. 为场面绘制图片添加视频生成支持
4. 优化查询索引根据实际使用情况调整

---

*执行时间：2025-12-16*
*执行状态：完成*