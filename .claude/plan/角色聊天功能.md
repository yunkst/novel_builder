# 角色聊天功能实现

## 任务上下文

**目标：** 在角色详情页增加聊天功能，用户可以设定场景与AI角色进行实时对话。

**核心需求：**
- 从角色详情页进入聊天界面
- 用户可设定聊天场景
- 流式输出AI回复
- 解析【】符号区分角色对话和旁白
- 用户可输入行为/对话继续聊天

**技术方案：** 方案1 - 创建独立聊天屏幕 + 增强角色详情页

## 选定方案

**方案1：** 创建独立聊天屏幕 + 在角色详情页添加入口 ✅

通过创建新的 `CharacterChatScreen` 页面实现完整的聊天功能，包括流式输出、实时解析、用户交互等。

## 执行步骤

### 1. 创建聊天消息数据模型 ✅

**文件：** `novel_app/lib/models/chat_message.dart`

**内容：**
- 定义 `ChatMessage` 类
- 支持四种消息类型：narration（旁白）、dialogue（角色对话）、user_action（用户行为）、user_speech（用户对话）
- 提供工厂方法创建不同类型的消息
- 支持 `copyWith` 方法用于不可变更新

**关键代码：**
```dart
class ChatMessage {
  final String type;
  final String content;
  final Character? character;
  final bool isUser;
  final DateTime timestamp;

  factory ChatMessage.narration(String content)
  factory ChatMessage.dialogue(String content, Character character)
  factory ChatMessage.userAction(String content)
  factory ChatMessage.userSpeech(String content)
}
```

---

### 2. 创建场景输入对话框组件 ✅

**文件：** `novel_app/lib/widgets/chat_scene_input_dialog.dart`

**内容：**
- 用户输入场景描述
- 提供预设场景快捷选择（宫廷宴会、战场之上等）
- 返回场景字符串

**UI组件：**
- TextField 输入场景
- Wrap 包含 ActionChip 预设选项
- 确认/取消按钮

---

### 3. 创建流式文本解析器 ✅

**文件：** `novel_app/lib/utils/chat_stream_parser.dart`

**核心功能：**
- 解析流式文本块中的【】符号
- 实时更新消息列表
- 状态机：normal（旁白模式） ↔ inDialogue（对话模式）

**解析逻辑：**
```dart
static List<ChatMessage> parseChunk(
  String chunk,
  List<ChatMessage> currentMessages,
  Character character,
) {
  // 1. 推导当前状态
  _ParserState state = _deduceStateFromMessages(currentMessages);

  // 2. 遍历字符
  for (char in chunk) {
    if (char == '【') {
      // 切换到对话模式，创建新对话消息
      messages.add(ChatMessage.dialogue('', character));
    } else if (char == '】') {
      // 切换到旁白模式
    } else {
      // 追加字符到当前消息
      messages.last.content += char;
    }
  }

  return messages;
}
```

**辅助方法：**
- `formatChatHistory`: 格式化聊天历史为字符串
- `formatRoleInfo`: 格式化角色信息为自然语言（非JSON）

---

### 4. 创建角色聊天屏幕页面 ✅

**文件：** `novel_app/lib/screens/character_chat_screen.dart`

**核心功能：**

#### 4.1 状态管理
```dart
class _CharacterChatScreenState extends State<CharacterChatScreen> {
  List<ChatMessage> _messages = [];
  bool _isGenerating = false;
  String _scene;
  TextEditingController _actionController;
  TextEditingController _speechController;
  ScrollController _scrollController;
  DifyService _difyService;
  CharacterAvatarService _avatarService;
}
```

#### 4.2 初始化流程
```dart
@override
void initState() {
  super.initState();
  _scene = widget.initialScene;
  _startInitialChat(); // 自动发起初始对话
}
```

#### 4.3 UI布局
- AppBar：显示角色名和场景
- ListView：显示消息列表（reverse: true，最新在底部）
- 输入区域：行为输入框 + 对话输入框 + 发送按钮

#### 4.4 消息渲染
- **旁白消息**：灰色斜体文本，独立容器
- **角色对话**：头像 + 蓝色气泡，支持流式打字动画
- **用户消息**：右对齐绿色气泡

#### 4.5 流式输出处理
```dart
await _difyService.runWorkflowStreaming(
  inputs: {
    'cmd': '聊天',
    'roles': ChatStreamParser.formatRoleInfo(widget.character),
    'scene': _scene,
    'chat_history': chatHistory,
  },
  onData: (chunk) {
    final newMessages = ChatStreamParser.parseChunk(
      chunk,
      _messages,
      widget.character,
    );
    setState(() {
      _messages.clear();
      _messages.addAll(newMessages);
    });
    _scrollToBottom(); // 自动滚动
  },
);
```

#### 4.6 用户输入发送
```dart
Future<void> _sendMessage() async {
  // 1. 添加用户消息
  if (action.isNotEmpty) {
    _messages.add(ChatMessage.userAction(action));
  }
  if (speech.isNotEmpty) {
    _messages.add(ChatMessage.userSpeech(speech));
  }

  // 2. 清空输入框
  _actionController.clear();
  _speechController.clear();

  // 3. 调用Dify继续生成
  await _callDifyStreaming();
}
```

---

### 5. 修改角色详情页添加聊天入口 ✅

**文件：** `novel_app/lib/screens/character_edit_screen.dart`

**变更内容：**

#### 5.1 导入新文件
```dart
import '../screens/character_chat_screen.dart';
import '../widgets/chat_scene_input_dialog.dart';
```

#### 5.2 在AppBar添加聊天按钮
```dart
actions: [
  // 仅在编辑模式显示
  if (isEditing && widget.character != null)
    IconButton(
      onPressed: _startChat,
      icon: Icon(Icons.chat_outlined),
      tooltip: '与TA聊天',
    ),
  // 保存按钮...
],
```

#### 5.3 实现_startChat方法
```dart
Future<void> _startChat() async {
  // 1. 显示场景输入对话框
  final scene = await ChatSceneInputDialog.show(context);

  if (scene == null || scene.trim().isEmpty) return;

  // 2. 导航到聊天屏幕
  await Navigator.push(
    context,
    MaterialPageRoute(
      builder: (context) => CharacterChatScreen(
        character: widget.character!,
        initialScene: scene,
      ),
    ),
  );
}
```

---

## 代码变更摘要

| 操作 | 文件 | 行数 | 状态 |
|------|------|------|------|
| 新建 | `lib/models/chat_message.dart` | ~100 | ✅ |
| 新建 | `lib/widgets/chat_scene_input_dialog.dart` | ~130 | ✅ |
| 新建 | `lib/utils/chat_stream_parser.dart` | ~150 | ✅ |
| 新建 | `lib/screens/character_chat_screen.dart` | ~580 | ✅ |
| 修改 | `lib/screens/character_edit_screen.dart` | +35 | ✅ |
| **总计** | | **~995行** | |

---

## 技术要点

### 1. 流式解析状态机
```
normal状态 → 遇到【 → inDialogue状态
inDialogue状态 → 遇到】 → normal状态
```

### 2. 消息列表不可变更新
```dart
// ❌ 错误：直接修改
messages.last.content += char;

// ✅ 正确：创建新对象
messages[lastIndex] = messages.last.copyWith(
  content: messages.last.content + char,
);
```

### 3. 聊天历史格式
```
用户[行为]: 举起酒杯
用户[对话]: 你好，最近怎么样？
角色[对话]: 很好，谢谢关心
```

### 4. Dify参数格式
```dart
{
  'cmd': '聊天',
  'roles': '角色名：张三\n性别：男\n...', // 自然语言，非JSON
  'scene': '宫廷宴会',
  'chat_history': '用户[对话]: 你好\n角色[对话]: ...',
}
```

---

## 成功标准

- ✅ 角色详情页显示聊天入口（仅编辑模式）
- ✅ 输入场景后进入聊天界面
- ✅ 自动发起初始对话，流式输出
- ✅ 正确解析【】符号，区分对话和旁白
- ✅ 角色对话显示头像和气泡
- ✅ 旁白显示为灰色斜体
- ✅ 用户可输入行为/对话继续聊天
- ✅ 聊天历史正确传递给Dify
- ✅ 代码通过 Flutter analyze

---

## 测试场景

### 场景1：启动聊天
1. 打开角色详情页
2. 点击"与TA聊天"按钮
3. 输入场景："宫廷宴会"
4. 进入聊天界面
5. 验证：自动发起初始对话

### 场景2：流式输出解析
1. 等待AI回复
2. 观察【】符号解析
3. 验证：对话显示为蓝色气泡
4. 验证：旁白显示为灰色斜体
5. 验证：头像正确显示

### 场景3：用户交互
1. 输入行为："举起酒杯"
2. 输入对话："你好"
3. 点击发送
4. 验证：用户消息显示（右对齐绿色）
5. 验证：AI继续流式回复

---

## 相关文件

- `novel_app/lib/models/chat_message.dart` - 聊天消息数据模型
- `novel_app/lib/widgets/chat_scene_input_dialog.dart` - 场景输入对话框
- `novel_app/lib/utils/chat_stream_parser.dart` - 流式解析器
- `novel_app/lib/screens/character_chat_screen.dart` - 聊天屏幕
- `novel_app/lib/screens/character_edit_screen.dart` - 角色详情页（已修改）
- `novel_app/lib/services/dify_service.dart` - Dify服务（复用）
- `novel_app/lib/services/character_avatar_service.dart` - 头像服务（复用）

---

## 完成状态

- [x] 步骤1：创建聊天消息数据模型
- [x] 步骤2：创建场景输入对话框组件
- [x] 步骤3：创建流式文本解析器
- [x] 步骤4：创建角色聊天屏幕页面
- [x] 步骤5：修改角色详情页添加聊天入口
- [ ] 步骤6：测试聊天功能完整流程

---

## 注意事项

1. **头像显示**：复用 `CharacterAvatarService`，需确保服务已初始化
2. **流式解析**：状态机正确处理边界情况（连续【】符号等）
3. **聊天历史**：只保存用户和角色对话，不保存旁白
4. **错误处理**：网络错误、Dify错误的友好提示
5. **性能优化**：ListView使用builder模式，避免大量消息时卡顿
6. **滚动优化**：每次收到chunk后自动滚动到底部
7. **输入校验**：行为和对话至少填一个才能发送
