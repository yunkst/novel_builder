# 插图弹窗展示原始提示词功能

## 任务概述

在插图组件点击后的弹窗中,增加展示生成该图片时用户写的原始提示词,并支持快速复制。

## 实施日期

2026-01-09

## 需求评分

**总分: 10/10** ✅ 需求完整

- 目标明确性: 3/3 (明确是 IllustrationActionDialog 组件)
- 预期结果: 3/3 (展示prompts字段并支持复制)
- 边界范围: 2/2 (单组件功能增强,范围清晰)
- 约束条件: 2/2 (直接展示,无特殊布局要求)

## 选定方案

**方案1: 直接扩展 IllustrationActionDialog** ⭐ (推荐)

- 代码改动最小,仅修改1个主要文件
- 不影响现有调用链
- UI集中在弹窗内部,维护性好
- 符合单一职责原则

## 数据来源分析

### 数据存储
- **位置**: 本地SQLite数据库
- **表名**: `scene_illustrations`
- **字段**: `prompts` (String?, 可空)
- **模型**: `SceneIllustration.prompts`

### 数据获取方式
```dart
DatabaseService.getSceneIllustrationsByChapter(novelUrl, chapterId)
→ 获取 SceneIllustration 对象
→ 读取 illustration.prompts 字段
```

## 实施步骤

### 步骤1: 修改 IllustrationActionDialog 组件 ✅

**文件**: `lib/widgets/illustration_action_dialog.dart`

**改动内容**:
1. 添加 `import 'package:flutter/services.dart';` (剪贴板服务)
2. 添加 `final String? prompts` 参数
3. 修改 `show()` 方法签名,接受 `prompts` 参数
4. 在build()方法中添加提示词展示区域
5. 创建 `_PromptsDisplayCard` 组件

**新增UI**:
- 提示词标题和图标 (灯泡图标 + "原始提示词" 文字)
- 提示词内容展示 (SelectableText, 支持选择文本)
- 复制按钮 (TextButton.icon, 复制到剪贴板)
- 复制成功提示 (SnackBar, 绿色)
- 复制失败提示 (SnackBar, 红色)

**UI样式**:
- 背景色: 琥珀色 (Amber) 半透明
- 边框: 琥珀色 1.5px
- 圆角: 12px
- 内边距: 12px

### 步骤2: 修改 IllustrationHandlerMixin 查询数据 ✅

**文件**: `lib/mixins/reader/illustration_handler_mixin.dart`

**改动位置**: `handleImageTap()` 方法 (第133行)

**改动内容**:
```dart
// 在显示Dialog之前查询数据库
String? prompts;
try {
  final illustrations = await databaseService.getSceneIllustrationsByChapter(
    novel.url,
    currentChapter.url,
  );
  final illustration = illustrations.firstWhere(
    (ill) => ill.taskId == taskId,
    orElse: () => throw Exception('插图不存在'),
  );
  prompts = illustration.prompts;
} catch (e) {
  debugPrint('获取提示词失败: $e');
  prompts = null;
}

// 传递prompts给Dialog
final action = await IllustrationActionDialog.show(
  context,
  prompts: prompts,
);
```

**错误处理**:
- 查询失败时不影响原有功能
- prompts为null时不显示提示词区域
- 使用try-catch捕获异常

### 步骤3: 代码质量检查 ✅

运行 `flutter analyze --no-fatal-infos`

**结果**: ✅ No issues found!

## 文件清单

| 序号 | 文件路径 | 改动类型 | 改动行数 |
|------|---------|---------|---------|
| 1 | `lib/widgets/illustration_action_dialog.dart` | 修改 | +103行 |
| 2 | `lib/mixins/reader/illustration_handler_mixin.dart` | 修改 | +18行 |
| **总计** | **2个文件** | - | **~121行** |

## 技术细节

### 1. 提示词展示组件

```dart
class _PromptsDisplayCard extends StatelessWidget {
  final String prompts;

  // UI特点:
  // - 琥珀色主题
  // - SelectableText 支持文本选择
  // - 一键复制到剪贴板
  // - SnackBar 反馈
}
```

### 2. 兼容性保证

- **向后兼容**: prompts参数可空,不影响现有调用
- **渐进增强**: 有prompts就显示,没有就保持原样
- **可选功能**: 提示词展示不影响核心功能

### 3. 错误处理策略

- 数据库查询失败 → 记录日志,继续执行
- prompts为空 → 不显示提示词区域
- 复制失败 → 显示错误提示

## UI设计

```
┌─────────────────────────────────┐
│ 📱 请选择操作                    │
├─────────────────────────────────┤
│ 💡 原始提示词                   │
│ ┌─────────────────────────────┐ │
│ │ 精致的古代庭院,樱花飞舞...   │ │
│ │ (SelectableText - 可选择)    │ │
│ │                     [复制]   │ │
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│ ➕ 再来几张  基于当前内容生成... │
│ 🎬 生成视频  将图片转换为动态... │
├─────────────────────────────────┤
│           [取消]                │
└─────────────────────────────────┘
```

## 测试场景

1. **有提示词**: 点击有prompts的插图 → 显示提示词区域
2. **无提示词**: 点击无prompts的插图 → 不显示提示词区域
3. **复制功能**: 点击复制按钮 → 提示词复制到剪贴板
4. **长提示词**: 多行显示 → 正常展示不溢出
5. **错误处理**: 查询失败 → 不显示提示词,不影响其他功能

## 预期成果

✅ 功能: 插图弹窗中展示原始提示词
✅ 交互: 一键复制提示词到剪贴板
✅ UI: 美观的卡片式展示区域
✅ 兼容: 不影响现有功能
✅ 健壮: 完善的错误处理
✅ 代码: 通过 Flutter analyze 检查

## 关键代码片段

### IllustrationActionDialog.show() 调用
```dart
final action = await IllustrationActionDialog.show(
  context,
  prompts: prompts, // 新增参数
);
```

### 复制功能实现
```dart
await Clipboard.setData(ClipboardData(text: text));
ScaffoldMessenger.of(context).showSnackBar(
  const SnackBar(content: Text('提示词已复制到剪贴板')),
);
```

## 代码质量

- ✅ Flutter analyze: No issues found
- ✅ 遵循 Material Design 3 规范
- ✅ 使用可空类型保证兼容性
- ✅ 完善的错误处理
- ✅ 用户友好的反馈提示

## 后续优化建议

1. **可选**: 添加提示词编辑功能 (允许用户修改后重新生成)
2. **可选**: 支持提示词历史记录 (查看该图片的生成历史)
3. **可选**: 添加提示词标签分类 (如"风景"、"人物"等)

## 相关文档

- 项目架构: `CLAUDE.md`
- Flutter模块: `novel_app/CLAUDE.md`
- 数据模型: `lib/models/scene_illustration.dart`
- 数据库服务: `lib/services/database_service.dart`

---

**执行状态**: ✅ 已完成
**代码质量**: ✅ 通过分析
**待用户测试**: 等待反馈
