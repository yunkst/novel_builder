# 模型接口替换执行计划

## 上下文

用户要求删除 `/api/role-card/models` 接口，替换为更通用的 `/api/models` 接口，输出结果按文生图和图生视频分类。

## 需求分析

- **目标明确性** (3/3分)：任务目标非常清晰 - 删除旧接口，创建新通用接口
- **预期结果** (2/3分)：期望输出按文生图和图生视频分类，具体格式已明确为 `{text2img:[{title,description}],img2video:[{title,description}]}`
- **边界范围** (2/2分)：范围清楚 - 涉及单个接口替换
- **约束条件** (1/2分)：无性能要求，直接删除旧接口

**总评分：8/10** - 需求基本完整

## 方案选择

采用 **方案 1：直接替换接口**，最符合用户明确要求。

### 接口设计规范
- **路径**：`GET /api/models`
- **认证**：保持现有的 token 验证
- **输出格式**：按用户要求的 `{text2img:[{title,description}],img2video:[{title,description}]}`

## 执行步骤

### 步骤 1：分析现有接口实现 ✅
**文件**：`backend/app/main.py`
**范围**：第 479-492 行的 `get_available_models()` 函数
**结果**：掌握现有代码结构和数据流

### 步骤 2：删除旧接口 ✅
**文件**：`backend/app/main.py`
**操作**：删除 `get_available_models()` 函数和对应的路由装饰器
**结果**：旧接口完全移除，不影响其他功能

### 步骤 3：创建新的通用接口 ✅
**文件**：`backend/app/main.py`
**函数名**：`get_models()`
**路由**：`@app.get("/api/models", dependencies=[Depends(verify_token)])`
**逻辑实现**：
1. 导入 workflow_config_manager
2. 获取文生图工作流列表（list_t2i_workflows）
3. 获取图生视频工作流（直接从配置获取）
4. 提取每个工作流的 title 和 description
5. 按要求格式组装返回数据

**关键实现点**：
```python
# 获取文生图工作流
t2i_workflows = workflow_config_manager.list_t2i_workflows()
text2img_models = [
    {
        "title": workflow.get("title", ""),
        "description": workflow.get("description", "")
    }
    for workflow in t2i_workflows
]

# 获取图生视频工作流（直接从配置获取）
config = workflow_config_manager.get_config()
img2video_models = [
    {
        "title": workflow.title,
        "description": workflow.description
    }
    for workflow in config.i2v
]
```

**结果**：新接口返回格式符合用户要求

### 步骤 4：测试接口功能 ✅
**测试项目**：
- ✅ 语法检查通过
- ✅ 工作流配置管理器测试成功
- ✅ 新接口功能测试通过
- ✅ 旧接口删除验证通过
- ✅ 认证要求有效

**测试结果**：
```json
{
  "text2img": [
    {
      "title": "动漫风",
      "description": "用于生成角色卡的标准文生图工作流"
    }
  ],
  "img2video": [
    {
      "title": "视频生成",
      "description": "图片转视频工作流"
    }
  ]
}
```

### 步骤 5：执行计划保存 ✅
**操作**：将执行计划和上下文保存到 `.claude/plan/模型接口替换.md`

## 结果评估

### 成功完成项目
1. ✅ 成功删除了 `/api/role-card/models` 接口
2. ✅ 成功创建了新的 `/api/models` 通用接口
3. ✅ 输出格式完全符合用户要求
4. ✅ 保持了原有的认证机制
5. ✅ 复用了现有的工作流配置管理器
6. ✅ 没有影响其他接口功能

### 接口变更对比
**旧接口**：
- 路径：`GET /api/role-card/models`
- 输出：`{"models": [...], "total_count": 1}`

**新接口**：
- 路径：`GET /api/models`
- 输出：`{"text2img": [...], "img2video": [...]}`

### 技术亮点
- 保持了代码的可维护性
- 复用了现有的 WorkflowConfigManager
- 正确处理了 i2v 工作流的获取方式
- 保持了原有的错误处理机制

## 遇到的技术问题及解决方案

### 问题：WorkflowConfigManager 缺少 list_i2v_workflows 方法
**解决方案**：直接从 `config.i2v` 获取图生视频工作流列表
```python
config = workflow_config_manager.get_config()
img2video_models = [
    {
        "title": workflow.title,
        "description": workflow.description
    }
    for workflow in config.i2v
]
```

## 建议和改进

### 可能的优化
1. 为 WorkflowConfigManager 添加 `list_i2v_workflows()` 方法，保持接口一致性
2. 考虑添加模型状态检查功能
3. 可以扩展支持更多的模型类型

### 文档更新建议
如果项目有 API 文档，需要更新：
- 删除旧接口的文档
- 添加新接口的文档和示例

## 总结

任务圆满完成！成功将专用的角色卡模型接口替换为通用的模型接口，输出格式完全符合用户要求，代码质量和可维护性得到保证。