# 沉浸式体验功能 - 执行计划

## 任务上下文

在小说阅读应用中添加沉浸体验功能，让用户可以基于章节内容和角色生成沉浸式剧本。

### 用户需求

1. **功能入口**：在阅读界面右上角添加"沉浸体验"按钮
2. **配置对话框**：
   - 用户输入沉浸体验要求
   - 选择参与角色（智能默认选择：自动勾选在章节中出现的角色）
   - 选择用户扮演的角色（必须在参与角色中）
3. **初始化页面**：
   - 显示加载动画（呼吸效果 + 轮播提示）
   - 调用Dify生成剧本
   - 使用TabBar展示剧本和角色策略
   - 支持修改意见重新生成
   - 错误处理和重试机制

### 技术栈

- **Flutter 3.0+**: UI框架
- **Dify API**: AI剧本生成
- **Provider**: 状态管理
- **Material Design 3**: 设计规范

---

## 实施计划

### 步骤1：创建沉浸体验配置对话框 ✅

**文件**: `novel_app/lib/widgets/immersive/immersive_setup_dialog.dart`

**功能清单**：
1. AlertDialog对话框UI
2. 用户要求输入框（TextField，maxLines: 3-5）
3. 角色选择按钮（显示已选数量）
4. 已选角色标签展示（Wrap + Chip）
5. 用户角色下拉选择（DropdownButtonFormField）
6. 智能默认选择：自动勾选在章节内容中出现的角色
7. 表单验证（要求不能为空、至少选择一个角色、必须选择用户角色）

**智能角色匹配逻辑**：
```dart
bool _isRoleInChapter(Character role, String chapterContent) {
  return chapterContent.contains(role.name);
}
```

**预期输出**：
```dart
class ImmersiveConfig {
  final String userRequirement;
  final List<String> roleNames;
  final String userRole;
}
```

---

### 步骤2：创建角色选择页面 ✅

**文件**: `novel_app/lib/widgets/immersive/immersive_role_selector.dart`

**功能清单**：
1. 全屏页面（AppBar + GridView）
2. 响应式网格布局（2-4列，根据屏幕宽度）
3. 角色卡片（头像 + 名称 + 简介 + 选中标记）
4. 全选/取消全选功能
5. 浮动确认按钮
6. 支持头像显示（从CharacterAvatarService加载）

**UI设计**：
- 使用GridView.builder实现响应式布局
- 大屏幕（>900px）：4列
- 中等屏幕（>600px）：3列
- 小屏幕（<=600px）：2列

---

### 步骤3：创建沉浸体验初始化页面 ✅

**文件**: `novel_app/lib/widgets/immersive/immersive_init_screen.dart`

**功能清单**：

#### 页面状态枚举
```dart
enum ImmersiveStatus {
  initializing, // 初始化
  loading,      // 加载中
  success,      // 成功
  error,        // 错误
}
```

#### 加载状态
- AnimationController控制的呼吸动画
- 图标：Icons.theater_comedy（紫色）
- 文字提示轮播：
  - "🎭 正在准备沉浸体验..."
  - "⏳ 剧本生成中..."
  - "📝 角色策略制定中..."
  - "✨ 精彩内容即将呈现..."
- CircularProgressIndicator

#### 成功状态（TabBar）
- TabBar（剧本 / 角色策略）
- TabBarView（两个可滚动视图）
- 底部操作栏（重新生成 / 确认）

#### 剧本Tab
- Card容器
- SelectableText（支持复制）
- 字体大小：16sp

#### 角色策略Tab
- ListView.builder
- 每个策略一个Card
- 显示策略内容

#### 错误状态
- 错误图标和消息
- 重试按钮
- 返回按钮

---

### 步骤4：在DifyService添加生成方法 ✅

**文件**: `novel_app/lib/services/dify_service.dart`

**新增方法**：
```dart
Future<Map<String, dynamic>?> generateImmersiveScript({
  required String chapterContent,
  required dynamic roles, // List<String> or String
  required String userInput,
  required String userChoiceRole,
  String? existingPlay,           // 用于重新生成
  List<String>? existingRoleStrategy, // 用于重新生成
}) async
```

**请求参数**：
```dart
{
  'cmd': '生成剧本',
  'chapter_content': chapterContent,
  'roles': '角色1,角色2,角色3',  // 逗号分隔
  'user_input': userInput,
  'user_choice_role': userRole,
  // 重新生成时添加：
  'play': existingPlay,
  'role_strategy': existingRoleStrategy,  // List<String>
}
```

**响应格式**：
```dart
{
  'play': '剧本内容',
  'role_strategy': ['策略1', '策略2', '策略3']  // List<String>
}
```

---

### 步骤5：在阅读界面添加沉浸体验入口 ✅

**文件**: `novel_app/lib/screens/reader_screen.dart`

**修改位置**：AppBar actions区域（line 879）

**新增代码**：
```dart
// 沉浸体验按钮
if (!editModeProvider.isEditMode)
  IconButton(
    onPressed: _showImmersiveSetup,
    tooltip: '沉浸体验',
    icon: const Icon(Icons.theater_comedy_outlined),
    color: Colors.purple,
  ),
```

**新增方法**：
```dart
Future<void> _showImmersiveSetup() async {
  final allCharacters = await _databaseService.getCharacters(widget.novel.url);
  final config = await ImmersiveSetupDialog.show(
    context,
    chapterContent: _content,
    allCharacters: allCharacters,
  );
  if (config == null) return;

  await Navigator.push(
    context,
    MaterialPageRoute(
      builder: (context) => ImmersiveInitScreen(
        novel: widget.novel,
        chapter: _currentChapter,
        chapterContent: _content,
        config: config,
      ),
    ),
  );
}
```

---

## 文件结构

```
novel_app/
├── lib/
│   ├── services/
│   │   └── dify_service.dart                    [修改] 新增generateImmersiveScript方法
│   ├── screens/
│   │   └── reader_screen.dart                   [修改] 添加沉浸体验入口
│   └── widgets/
│       └── immersive/                           [新建目录]
│           ├── immersive_setup_dialog.dart      [新建] 配置对话框
│           ├── immersive_role_selector.dart     [新建] 角色选择页面
│           └── immersive_init_screen.dart       [新建] 初始化页面
└── .claude/
    └── plan/
        └── 沉浸式体验功能.md                    [本文件]
```

---

## 代码质量检查 ✅

```bash
flutter analyze lib/widgets/immersive/ lib/screens/reader_screen.dart lib/services/dify_service.dart
```

**结果**：No issues found!

**修复的问题**：
1. ✅ 移除未使用的导入（character.dart）
2. ✅ 修复类型错误（Map<String, dynamic>明确类型）
3. ✅ 修复child参数顺序（按Flutter规范调整）
4. ✅ 修复deprecated的value参数（改用initialValue）
5. ✅ 移除未使用的字段（_avatarBorderRadius, _nameBottomPadding）
6. ✅ 修复头像加载逻辑（使用FutureBuilder + getCharacterAvatarPath）

---

## 功能流程

```
用户点击沉浸体验按钮
        ↓
显示配置对话框
        ↓
用户输入要求，选择角色（自动勾选出现在章节中的角色）
        ↓
点击"开始生成"
        ↓
导航到初始化页面
        ↓
显示加载动画（呼吸效果 + 轮播提示）
        ↓
调用Dify API生成剧本
        ↓
显示结果（TabBar：剧本 / 角色策略）
        ↓
用户可选项：
  - 提出修改意见 → 重新生成
  - 确认 → 退出（为后续聊天室功能预留）
        ↓
返回阅读界面
```

---

## 后续扩展（聊天室功能）

当前实现为聊天室功能预留了接口：

1. **ImmersiveConfig**：包含所有配置信息，可传递给聊天室页面
2. **_confirmScript()**：确认剧本后可导航到聊天室
3. **数据复用**：play和role_strategy可直接用于聊天室初始化

**建议实现**：
- 创建`ImmersiveChatScreen`页面
- 使用WebSocket或轮询实现实时通信
- 集成语音合成（TTS）增强体验

---

## 测试要点

### 单元测试
- [ ] 智能角色匹配逻辑（`_isRoleInChapter`）
- [ ] 表单验证（空输入、未选择角色等）

### 集成测试
- [ ] 对话框显示和交互
- [ ] 角色选择器多选功能
- [ ] 默认角色自动勾选
- [ ] Dify请求成功流程
- [ ] Dify请求失败重试

### UI测试
- [ ] 加载动画流畅性
- [ ] TabBar切换效果
- [ ] 错误提示友好性

### 边界测试
- [ ] 无角色时的处理
- [ ] 网络超时（10分钟）
- [ ] Dify返回格式异常

---

## 成功标准

✅ 完成后，用户可以：
1. 在阅读界面点击沉浸体验按钮
2. 输入体验要求，系统自动勾选出现在章节中的角色
3. 查看生成过程的加载动画和提示
4. 在TabBar中查看剧本和角色策略
5. 提出修改意见并重新生成
6. 确认后退出（为后续聊天室功能预留接口）

---

## 技术亮点

✅ **智能默认选择**：根据角色名称在章节内容中的匹配自动勾选
✅ **复用现有UI**：角色选择页面复用GridView布局
✅ **状态管理清晰**：使用enum管理页面状态
✅ **动画流畅**：AnimationController实现呼吸效果
✅ **错误处理完善**：友好的错误提示和重试机制
✅ **扩展性强**：为后续聊天室功能预留接口
✅ **代码质量高**：通过Flutter analyze无警告

---

## 实施日期

**开始时间**: 2025-01-06
**完成时间**: 2025-01-06
**耗时**: 约2小时

---

## 总结

成功实现了沉浸体验功能的完整流程，包括：
- ✅ 智能角色默认选择
- ✅ 响应式角色选择页面
- ✅ 流畅的加载动画
- ✅ TabBar结果展示
- ✅ 修改意见重新生成
- ✅ 完善的错误处理

代码质量通过Flutter analyze检查，无任何警告或错误。为后续聊天室功能预留了清晰的扩展接口。
