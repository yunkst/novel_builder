# 点击图片生成视频功能实现

## 任务概述
实现点击哪张图片就为哪张图片创建视频的功能，支持生成状态检查和显示。

## 实施计划

### 阶段1：修改 SceneImagePreview 组件回调接口 ✅
- **文件**: `lib/widgets/scene_image_preview.dart`
- **修改内容**:
  - 将 `onImageTap: VoidCallback?` 改为 `Function(String taskId, String imageUrl, int imageIndex)?`
  - 修改点击处理逻辑，传递当前图片的 taskId、imageUrl 和索引
- **预期结果**: 回调能正确传递当前点击图片的信息

### 阶段2：添加视频生成状态管理功能 ✅
- **文件**:
  - `lib/utils/video_generation_state_manager.dart` (新建)
  - `lib/widgets/scene_image_preview.dart` (修改)
- **实现内容**:
  - 创建独立的视频生成状态管理器
  - 添加生成状态检查和UI覆盖层显示
  - 实现状态变化的监听和通知机制
- **预期结果**: 能够跟踪和显示图片的生成状态

### 阶段3：更新 reader_screen.dart 中的回调处理逻辑 ✅
- **文件**: `lib/screens/reader_screen.dart`
- **修改内容**:
  - 修改 `_buildIllustrationParagraph` 中的 `onImageTap` 回调
  - 更新回调参数处理
- **预期结果**: 能够接收和处理特定图片的点击事件

### 阶段4：实现新的视频生成方法 ✅
- **文件**: `lib/screens/reader_screen.dart`
- **新增内容**:
  - `_generateVideoFromSpecificImage(String taskId, String imageUrl, int imageIndex)` 方法
  - 生成状态检查逻辑
  - 从指定图片URL提取文件名
  - API调用（使用空字符串作为 modelName）
- **预期结果**: 支持为指定图片创建视频

### 阶段5：实现状态同步管理机制 ✅
- **文件**:
  - `lib/utils/video_generation_state_manager.dart`
  - `lib/widgets/scene_image_preview.dart`
  - `lib/screens/reader_screen.dart`
- **实现内容**:
  - 全局状态管理器
  - 状态变化监听机制
  - 多组件间状态同步
- **预期结果**: 生成状态在组件间正确同步

### 阶段6：功能测试和验证 ✅
- **测试范围**:
  - 代码语法检查
  - 静态分析
  - 接口调用验证
- **预期结果**: 代码质量良好，无语法错误

## 技术实现要点

### 回调接口设计
```dart
// 新的回调接口
onImageTap: (String taskId, String imageUrl, int imageIndex) {
  // 处理特定图片的视频生成
}
```

### 状态管理机制
```dart
// 使用独立的状态管理器
VideoGenerationStateManager.isImageGenerating(imageUrl)
VideoGenerationStateManager.setImageGenerating(imageUrl, true/false)
```

### API调用参数
```dart
final response = await _apiService.generateVideoFromImage(
  imgName: fileName,        // 从imageUrl提取的文件名
  userInput: userInput,     // 用户输入描述
  modelName: '',           // 空字符串
);
```

## 成功标准实现

1. ✅ 点击当前展示图片能正确获取其文件名
2. ✅ 生成中的图片显示"正在生成中"状态
3. ✅ 重复点击生成中的图片给出友好提示
4. ✅ 多张图片之间状态独立管理
5. ✅ API调用使用正确的参数（modelName为空字符串）

## 涉及文件清单

1. `lib/utils/video_generation_state_manager.dart` - 新建状态管理器
2. `lib/widgets/scene_image_preview.dart` - 主要修改
3. `lib/screens/reader_screen.dart` - 主要修改

## 代码质量

- **分析结果**: 1个未使用方法警告（正常）
- **错误数量**: 0
- **主要功能**: 全部实现

## 总结

功能已成功实现，包括：
- 点击图片时传递正确的图片信息
- 生成状态的全局管理和同步
- 生成中的状态显示和重复点击保护
- 正确的API参数调用（modelName为空字符串）

代码架构清晰，使用了独立的状态管理器，便于维护和扩展。