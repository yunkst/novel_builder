# 实现插配图对话框Dify流式场景描写生成 - 执行计划

## 任务背景
在插入配图对话框中集成Dify流式AI生成功能，自动为用户生成高质量的场景描写文本，提升创建插图的效率和质量。

## 技术方案
采用基于现有Dify服务扩展方案，复用现有的流式响应处理机制，添加场景描写专用的生成方法。

## 核心目标
- 利用章节内容和角色信息自动生成场景描写
- 实时显示AI生成过程的流式响应
- 在生成完成后允许用户编辑内容
- 保持与现有功能的兼容性

## 实施步骤

### 步骤1：分析现有Dify服务
- 目标：了解现有Dify服务的实现结构
- 文件：lib/services/dify_service.dart
- 需要了解：流式接口、参数格式、错误处理

### 步骤2：设计参数格式化策略
- 新增：_formatSceneDescriptionInput方法
- 功能：将章节内容和角色转换为AI友好的提示文本
- 包含：详细的生成要求、格式规范、约束条件

### 步骤3：实现流式状态管理
- 新增：SceneGenerationState枚举
- 功能：管理生成流程的不同状态（空闲、生成中、完成、错误）
- 状态：用于控制用户界面的交互行为

### 步骤4：扩展DifyService
- 新增：generateSceneDescriptionStream方法
- 功能：专门用于场景描写的流式生成接口
- 参数：章节内容、角色列表、流式回调、完成回调

### 步骤5：修改SceneIllustrationDialog
- 修改：initState方法，添加自动生成逻辑
- 新增：_generateSceneDescription方法
- 集成：角色预选、章节内容获取、流式响应处理

### 步骤6：实现用户界面控制
- 生成状态指示器：显示当前生成状态
- 文本框状态控制：生成时只读，完成后可编辑
- 实时内容更新：显示流式生成过程

### 步骤7：错误处理和优化
- Dify服务异常处理
- 网络连接错误恢复
- 流式响应中断处理
- 生成质量验证

## 技术实现要点

### 参数格式化
- 章节内容：从段落开始到当前位置的全部文本
- 角色信息：角色名称、特征描述
- 生成要求：视觉环境、位置动作、细节氛围、语言风格
- 命令格式：cmd: scene_description

### 状态管理
```dart
enum SceneGenerationState {
  idle,      // 空闲状态
  generating, // 生成中
  completed, // 已完成
  error      // 生成错误
}
```

### 流式处理
- 实时更新文本内容
- 保持光标位置
- 防止用户编辑干扰
- 完成后启用编辑功能

### 用户交互控制
- 生成中：文本框只读，显示加载指示器
- 完成后：切换为可编辑状态
- 支持用户手动修改内容
- 提供重新生成选项

## 预期用户流程

1. **对话框打开** → 自动获取章节内容和预选角色
2. **开始生成** → 显示加载状态，实时显示生成内容
3. **实时更新** → 用户可查看AI生成过程
4. **生成完成** → 自动切换为可编辑状态
5. **编辑调整** → 用户可修改生成的内容
6. **创建插图** → 使用最终内容进行插图创建

## 预期结果
用户打开插配图对话框时，系统能够基于当前章节内容和角色信息自动生成高质量的场景描写，通过流式响应提供即时反馈，并在生成完成后允许用户编辑，大幅提升创建插图的效率和质量。