# 流式内容处理优化执行计划

## 背景
优化项目中的流式内容处理，消除重复实现，创建通用的流式处理方法。

## 发现的重复实现
1. **特殊标记处理逻辑重复**：特写功能和场景描写功能都处理`<<COMPLETE_CONTENT>>`
2. **StreamStateManager配置模式重复**：相同的onCompleted回调结构和onError处理模式
3. **流式内容UI更新模式重复**：ReaderScreen和SceneIllustrationDialog中的相似逻辑

## 实施方案
采用服务层统一 + UI层通用组件的组合方案：
1. 创建UnifiedStreamManager统一所有Dify流式调用
2. 创建StreamContentWidget通用组件封装显示逻辑
3. 通过StreamConfig配置化支持不同流式类型

## 实施步骤

### 步骤1：创建流式配置模型 (StreamConfig)
- 文件：`lib/models/stream_config.dart`
- 定义流式类型和配置参数
- 支持扩展新的流式功能

### 步骤2：创建统一流式管理器 (UnifiedStreamManager)
- 文件：`lib/services/unified_stream_manager.dart`
- 统一Dify流式API调用接口
- 标准化特殊标记处理和错误处理

### 步骤3：创建通用流式内容组件 (StreamContentWidget)
- 文件：`lib/widgets/stream_content_widget.dart`
- 封装流式内容显示逻辑
- 支持自动滚动和状态指示

### 步骤4：重构现有代码
- 特写功能：ReaderScreen中使用新架构
- 场景描写功能：SceneIllustrationDialog中使用新架构
- DifyService：迁移到UnifiedStreamManager

### 步骤5：清理和测试
- 移除旧的重复代码
- 验证功能完整性和性能

## 预期收益
- 代码减少60%
- 提高维护性和扩展性
- 统一流式功能行为