# 实现插图滑动切换功能 - 执行计划

## 任务背景
将多张插图的展示方式从网格布局改为水平滑动切换，提升用户在阅读页面的图片浏览体验。

## 技术方案
采用PageView滑动切换方案，使用Flutter原生组件实现流畅的左右滑动体验。

## 核心目标
- 将网格布局替换为PageView滑动切换
- 保持单张图片的自适应高度功能
- 添加页面指示器显示当前位置
- 维持现有的点击查看完整图集功能

## 实施步骤

### 步骤1：分析当前实现
- 目标：了解_buildImageGrid方法的实现逻辑
- 文件：lib/widgets/scene_image_preview.dart:417-468
- 需要保留的功能：异步加载、错误处理、点击交互

### 步骤2：设计PageView滑动组件
- 新增_buildImagePageView方法
- 新增_buildPageIndicator方法
- 保持现有的图片自适应高度逻辑

### 步骤3：实现页面指示器
- 显示"当前/总数"格式
- 支持点击跳转到指定图片
- 保持与现有UI风格一致

### 步骤4：修改多图展示逻辑
- 将_buildImageGrid替换为_buildImagePageView
- 确保高度自适应功能正常
- 保持图片缓存和加载逻辑

### 步骤5：手势和交互优化
- 优化滑动动画流畅度
- 保持点击查看完整图集功能
- 测试各种边界情况

### 步骤6：功能测试验证
- 单张图片场景测试
- 多张图片滑动测试
- 页面指示器更新测试
- 错误处理测试

## 技术要点
- PageView.builder实现滑动切换
- 保持每张图片的自适应高度
- 状态管理当前页面索引
- 复用现有的图片尺寸获取逻辑

## 优化措施

### 1. 代码结构优化
- **提取公共逻辑**：创建`_buildImageWidget`通用方法
- **减少重复代码**：`_buildSingleImage`和`_buildPageImage`复用同一逻辑
- **参数化设计**：支持自定义高度范围和占位高度

### 2. 性能优化
- **图片尺寸缓存**：使用`Map<String, Size>`缓存已获取的图片尺寸
- **避免重复计算**：相同图片尺寸只获取一次
- **缓存默认值**：失败的图片也缓存默认尺寸，避免重复尝试

### 3. 用户体验优化
- **动态高度**：PageView根据当前图片尺寸动态调整高度
- **高度范围**：合理限制最小和最大高度
- **平滑过渡**：页面切换时高度变化流畅

## 额外优化：统一图片显示逻辑

### 统一处理方案
- **单张图片**：也使用PageView组件，当作长度为1的图片列表
- **页面指示器**：单张图片时显示"1 张图片"，多张图片时显示"1/N"和箭头
- **代码简化**：删除`_buildSingleImage`方法，统一使用`_buildImagePageView`

### 最终效果
- **代码一致性**：单张和多张图片使用完全相同的显示逻辑
- **用户体验**：单张图片也有页面指示器，界面更加一致
- **维护简化**：只需维护一套图片显示代码

## 预期结果
用户可以通过左右滑动流畅切换查看多张插图，每张图片保持原始比例和自适应高度。单张图片和多张图片使用统一的显示逻辑，代码更加简洁，界面更加一致。同时具备更好的性能和代码可维护性。