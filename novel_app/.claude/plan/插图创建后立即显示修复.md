# 插图创建后立即显示修复 - 执行计划

## 上下文
**问题**：创建插图后需要退出章节才能看到插图元素
**根本原因**：插图标记 `"[!插图!](taskId)"` 没有被插入到章节内容中
**解决方案**：数据库内容同步方案 - 插图创建时同步更新章节内容

## 执行步骤

### 步骤 1：修改 SceneIllustrationDialog 回调
- **文件**：`lib/widgets/scene_illustration_dialog.dart`
- **操作**：修改 onRefresh 回调签名，使其能传递任务ID
- **预期结果**：对话框能够通知阅读器哪个插图已创建

### 步骤 2：修改阅读器刷新逻辑
- **文件**：`lib/screens/reader_screen.dart`
- **操作**：修改 _showIllustrationDialog 方法中的 onRefresh 回调
- **预期结果**：插图创建后重新加载章节内容

### 步骤 3：扩展 SceneIllustrationService
- **文件**：`lib/services/scene_illustration_service.dart`
- **操作**：在 createSceneIllustration 方法中添加章节内容更新逻辑
- **预期结果**：数据库中的插图记录与章节内容保持同步

### 步骤 4：更新数据库服务方法
- **文件**：`lib/services/database_service.dart`
- **操作**：确保 updateChapterContent 方法支持插图标记插入
- **预期结果**：章节内容能正确更新并保存到数据库

### 步骤 5：错误处理与回滚
- **文件**：`lib/services/scene_illustration_service.dart`
- **操作**：添加插图标记插入失败时的回滚逻辑
- **预期结果**：系统稳定性提升

### 步骤 6：测试验证
- **操作**：测试插图创建后立即显示效果
- **预期结果**：功能正常工作

## 关键实现细节

**插图标记插入逻辑**：
- 插入位置：在目标段落之后
- 格式：`[!插图!](taskId)`
- 方法：分割段落 → 插入标记 → 重新组合

**数据库更新流程**：
1. 创建插图记录
2. 更新章节内容（插入标记）
3. 如果步骤2失败，回滚步骤1