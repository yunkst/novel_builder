# 实现插图对话框智能角色预选 - 执行计划

## 任务背景
在插入插图弹框中，智能预选当前章节段落之前出现的角色，提升用户创建插图的效率。

## 技术方案
采用章节内容文本匹配方案，解析当前段落及之前的内容，识别出现的角色名称。

## 核心目标
- 解析章节内容并分割为段落
- 匹配指定范围内的角色名称
- 在对话框初始化时自动勾选匹配的角色
- 保持用户手动修改选择的能力

## 实施步骤

### 步骤1：分析当前实现结构
- 目标：了解SceneIllustrationDialog的现有实现
- 文件：lib/widgets/scene_illustration_dialog.dart
- 需要了解：初始化流程、角色选择器接口、段落索引传递

### 步骤2：设计章节内容分割逻辑
- 新增_getMatchableContent方法
- 功能：分割章节内容，返回指定范围的内容
- 处理边界：空段落过滤、索引越界处理

### 步骤3：实现角色文本匹配算法
- 新增_findAppearingCharacters方法
- 功能：在内容中查找角色名称出现
- 优化：大小写不敏感、避免重复匹配

### 步骤4：修改对话框初始化逻辑
- 修改initState方法，添加预选调用
- 新增_preselectAppearingCharacters方法
- 更新CharacterSelector的初始选择状态

### 步骤5：优化用户体验
- 添加预选提示信息
- 显示匹配角色数量
- 保持界面美观和友好

### 步骤6：测试和验证
- 测试各种章节内容场景
- 验证边界情况处理
- 确保性能表现良好

## 技术要点
- 段落分割：按换行符分割，过滤空段落
- 文本匹配：大小写不敏感的字符串包含检查
- 异步处理：避免阻塞UI主线程
- 状态管理：使用setState更新选择状态

## 实现完成

### 已实现功能
1. **章节内容分割**：`_getMatchableContent`方法，将章节内容分割为段落并提取匹配范围
2. **角色文本匹配**：`_findAppearingCharacters`方法，在指定内容中查找角色名称
3. **智能预选逻辑**：`_preselectAppearingCharacters`方法，自动执行角色预选
4. **用户界面优化**：添加预选提示信息，清晰显示自动选择的角色数量

### 技术特点
- **异步执行**：预选逻辑在角色加载完成后异步执行，不阻塞UI
- **边界处理**：处理章节内容为空、角色列表为空等边界情况
- **错误容错**：预选失败不影响对话框正常显示和使用
- **类型安全**：正确的null检查和类型转换

### 用户体验
- **智能预选**：自动勾选章节中出现的角色，减少手动操作
- **视觉提示**：显示预选角色数量和"智能选择"图标
- **灵活可控**：用户仍可以手动修改选择
- **范围准确**：只匹配当前段落及之前的内容

## 预期结果
用户打开插图创建对话框时，系统能够自动识别并勾选当前段落及之前内容中出现的角色，减少手动选择操作。界面会显示智能预选提示，用户仍可手动调整选择。