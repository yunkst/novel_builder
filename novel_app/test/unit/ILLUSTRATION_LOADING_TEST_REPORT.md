# æ’å›¾ç»„ä»¶åŠ è½½å¤±è´¥é—®é¢˜ - æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ¦‚è¦

**æµ‹è¯•æ–‡ä»¶**: `test/unit/illustration_loading_test.dart`
**æµ‹è¯•æ—¥æœŸ**: 2026-02-03
**æµ‹è¯•ç›®çš„**: å¤çŽ°"åª’ä½“åŠ è½½å¤±è´¥"é—®é¢˜

## æµ‹è¯•ç»“æžœ

### æ€»ä½“ç»“æžœ
- âœ… é€šè¿‡: 5 ä¸ªæµ‹è¯•
- âŒ å¤±è´¥: 11 ä¸ªæµ‹è¯•
- â±ï¸ è¶…æ—¶: 3 ä¸ªæµ‹è¯•

### å…³é”®é—®é¢˜å‘çŽ°

#### ðŸ”´ é—®é¢˜1: ApiServiceWrapper æœªåˆå§‹åŒ–ï¼ˆæœ€ä¸¥é‡ï¼‰

**é”™è¯¯ä¿¡æ¯**:
```
Exception: ApiServiceWrapper æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆè°ƒç”¨ init()
```

**å½±å“èŒƒå›´**:
- `HybridMediaWidget` å›¾ç‰‡åŠ è½½
- `HybridMediaWidget` è§†é¢‘çŠ¶æ€æ£€æŸ¥
- `SceneImagePreview` API æ•°æ®èŽ·å–

**æ ¹æœ¬åŽŸå› **:
`HybridMediaWidget` åœ¨ `_checkVideoStatus()` å’Œ `_loadImageWithCache()` ä¸­ç›´æŽ¥ä½¿ç”¨ `ApiServiceWrapper()` å•ä¾‹ï¼Œä½†æ²¡æœ‰æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–ã€‚

**ä»£ç ä½ç½®**:
- `lib/widgets/hybrid_media_widget.dart:111` - è§†é¢‘çŠ¶æ€æ£€æŸ¥
- `lib/widgets/hybrid_media_widget.dart:86` - å›¾ç‰‡ç¼“å­˜åŠ è½½

**ä¿®å¤å»ºè®®**:
```dart
// åœ¨ HybridMediaWidget.initState() ä¸­æ·»åŠ 
@override
void initState() {
  super.initState();
  try {
    ApiServiceWrapper(); // è§¦å‘åˆå§‹åŒ–æ£€æŸ¥
  } catch (e) {
    debugPrint('âš ï¸ ApiServiceWrapper æœªåˆå§‹åŒ–: $e');
    setState(() {
      _mediaType = MediaType.error;
    });
    return;
  }
  // ... ç»§ç»­æ­£å¸¸æµç¨‹
}
```

#### ðŸŸ¡ é—®é¢˜2: å®šæ—¶å™¨æ³„æ¼

**é”™è¯¯ä¿¡æ¯**:
```
A Timer is still pending even after the widget tree was disposed.
```

**å½±å“**:
- å†…å­˜æ³„æ¼
- æµ‹è¯•å¤±è´¥
- å¯èƒ½å¯¼è‡´åº”ç”¨æ€§èƒ½ä¸‹é™

**ä»£ç ä½ç½®**:
`lib/widgets/hybrid_media_widget.dart`

**ä¿®å¤å»ºè®®**:
ç¡®ä¿åœ¨ `dispose()` æ–¹æ³•ä¸­å–æ¶ˆæ‰€æœ‰å®šæ—¶å™¨å’Œå¼‚æ­¥æ“ä½œã€‚

#### ðŸŸ¡ é—®é¢˜3: MissingPluginException

**é”™è¯¯ä¿¡æ¯**:
```
MissingPluginException(No implementation found for method getAll on channel plugins.flutter.io/shared_preferences)
```

**å½±å“**: ä»…æµ‹è¯•çŽ¯å¢ƒ

**ä¿®å¤å»ºè®®**:
åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ `TestWidgetsFlutterBinding.ensureInitialized()` åˆå§‹åŒ–æµ‹è¯•çŽ¯å¢ƒã€‚

#### ðŸŸ¢ é—®é¢˜4: SceneImagePreview æ–­è¨€å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
å¿…é¡»æä¾› illustration æˆ– taskId
```

**ä»£ç ä½ç½®**:
`lib/widgets/scene_image_preview.dart:80`

**ä¿®å¤å»ºè®®**:
è¿™ä¸ªæ–­è¨€æ˜¯æ­£ç¡®çš„ï¼Œä½†åº”è¯¥åœ¨ UI å±‚é¢æä¾›æ›´å¥½çš„é”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚

### æµ‹è¯•åœºæ™¯è¯¦æƒ…

| åœºæ™¯ | æè¿° | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|------|
| åœºæ™¯1 | APIæœåŠ¡è¿”å›žç©ºå›¾ç‰‡æ•°æ® | âŒ | ApiServiceWrapper æœªåˆå§‹åŒ– |
| åœºæ™¯2 | APIæœåŠ¡ç½‘ç»œè¿žæŽ¥è¶…æ—¶ | âŒ | ApiServiceWrapper æœªåˆå§‹åŒ– |
| åœºæ™¯3 | APIæœåŠ¡è¿”å›ž404é”™è¯¯ | âŒ | ApiServiceWrapper æœªåˆå§‹åŒ– |
| åœºæ™¯4 | å›¾ç‰‡æ•°æ®è¿‡å¤§ | âŒ | ApiServiceWrapper æœªåˆå§‹åŒ– |
| åœºæ™¯5 | APIæœåŠ¡æŠ›å‡ºé€šç”¨å¼‚å¸¸ | âŒ | ApiServiceWrapper æœªåˆå§‹åŒ– |
| åœºæ™¯6 | ç½‘ç»œè¿žæŽ¥è¢«æ‹’ç» | âŒ | ApiServiceWrapper æœªåˆå§‹åŒ– |
| åœºæ™¯7 | å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯UI | âŒ | å®šæ—¶å™¨æ³„æ¼ |
| åœºæ™¯8 | ç½‘ç»œè¶…æ—¶æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€ | âŒ | ApiServiceWrapper æœªåˆå§‹åŒ– |
| åœºæ™¯9 | taskIdä¸ºç©ºæ—¶æ˜¾ç¤ºé”™è¯¯ | âŒ | æ–­è¨€å¤±è´¥ |
| åœºæ™¯10 | APIè¿”å›žç©ºå›¾ç‰‡åˆ—è¡¨çš„é€»è¾‘éªŒè¯ | âœ… | é€šè¿‡ |
| åœºæ™¯11 | æ­£ç¡®è§£æžæ’å›¾æ ‡è®° | âœ… | é€šè¿‡ |
| åœºæ™¯12 | é”™è¯¯çš„æ’å›¾æ ‡è®°æ ¼å¼ | âœ… | é€šè¿‡ |
| åœºæ™¯13 | ç¼“å­˜è¾¾åˆ°ä¸Šé™æ—¶è‡ªåŠ¨æ¸…ç† | â±ï¸ | è¶…æ—¶ - APIæœªmock |
| åœºæ™¯14 | å¹¶å‘åŠ è½½ç›¸åŒå›¾ç‰‡æ—¶åŽ»é‡ | â±ï¸ | è¶…æ—¶ - APIæœªmock |
| åœºæ™¯15 | ç¼“å­˜åˆ é™¤åŽé‡æ–°åŠ è½½ | â±ï¸ | è¶…æ—¶ - APIæœªmock |
| åœºæ™¯16 | å›¾ç‰‡åŠ è½½ä¸­é€”åˆ‡æ¢ç½‘ç»œçŠ¶æ€ | âŒ | ApiServiceWrapper æœªåˆå§‹åŒ– |

## æ ¹æœ¬åŽŸå› åˆ†æž

### ä¸»è¦é—®é¢˜

**æ’å›¾ç»„ä»¶æ— æ³•æ˜¾ç¤ºå†…å®¹çš„æ ¹æœ¬åŽŸå› **ï¼š

1. **ApiServiceWrapper æœªåœ¨ç»„ä»¶ä½¿ç”¨å‰åˆå§‹åŒ–**
   - `HybridMediaWidget` ç›´æŽ¥ä½¿ç”¨ `ApiServiceWrapper()` å•ä¾‹
   - æ²¡æœ‰åˆå§‹åŒ–æ£€æŸ¥æœºåˆ¶
   - å¯¼è‡´æ‰€æœ‰å›¾ç‰‡å’Œè§†é¢‘åŠ è½½æ“ä½œå¤±è´¥

2. **é”™è¯¯å¤„ç†ä¸å®Œå–„**
   - åˆå§‹åŒ–å¤±è´¥åŽæ²¡æœ‰å‹å¥½çš„é”™è¯¯æç¤º
   - ç½‘ç»œé”™è¯¯è¢«åžæ²¡æˆ–æ˜¾ç¤ºä¸æ˜Žç¡®

3. **æµ‹è¯•è¦†ç›–ä¸è¶³**
   - çŽ°æœ‰æµ‹è¯•æ²¡æœ‰è¦†ç›–åˆå§‹åŒ–åœºæ™¯
   - ç¼ºå°‘é›†æˆæµ‹è¯•

## ä¿®å¤ä¼˜å…ˆçº§

### P0 - ç´§æ€¥ä¿®å¤

1. **ä¿®å¤ ApiServiceWrapper åˆå§‹åŒ–æ£€æŸ¥**
   - æ–‡ä»¶: `lib/widgets/hybrid_media_widget.dart`
   - æ·»åŠ åˆå§‹åŒ–æ£€æŸ¥å’Œé”™è¯¯å¤„ç†

2. **æ”¹è¿›é”™è¯¯æç¤º**
   - æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
   - æ·»åŠ é‡è¯•æœºåˆ¶

### P1 - é«˜ä¼˜å…ˆçº§

1. **ä¿®å¤å®šæ—¶å™¨æ³„æ¼**
   - æ–‡ä»¶: `lib/widgets/hybrid_media_widget.dart`
   - ç¡®ä¿ dispose æ—¶æ¸…ç†æ‰€æœ‰èµ„æº

2. **æ·»åŠ å•å…ƒæµ‹è¯•**
   - æµ‹è¯•åˆå§‹åŒ–åœºæ™¯
   - æµ‹è¯•é”™è¯¯å¤„ç†è·¯å¾„

### P2 - ä¸­ä¼˜å…ˆçº§

1. **æ”¹è¿›æµ‹è¯•çŽ¯å¢ƒé…ç½®**
   - åˆå§‹åŒ–æµ‹è¯•æ‰€éœ€çš„æ’ä»¶
   - Mock ApiServiceWrapper

2. **æ·»åŠ é›†æˆæµ‹è¯•**
   - ç«¯åˆ°ç«¯æµ‹è¯•æ’å›¾åŠ è½½æµç¨‹

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³ä¿®å¤

1. åœ¨ `HybridMediaWidget.initState()` ä¸­æ·»åŠ åˆå§‹åŒ–æ£€æŸ¥
2. åœ¨ `SceneImagePreview` ä¸­æ·»åŠ é”™è¯¯è¾¹ç•Œå¤„ç†
3. ä¿®å¤å®šæ—¶å™¨æ³„æ¼é—®é¢˜

### éªŒè¯ä¿®å¤

è¿è¡Œæµ‹è¯•ï¼š
```bash
flutter test test/unit/illustration_loading_test.dart
```

é¢„æœŸç»“æžœï¼š
- åœºæ™¯ 7, 8, 16 åº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„é”™è¯¯æ¶ˆæ¯
- åœºæ™¯ 9 åº”è¯¥æ˜¾ç¤º"ç¼ºå°‘æ’å›¾æ ‡è¯†ä¿¡æ¯"è€Œä¸æ˜¯æ–­è¨€å¤±è´¥
- æ²¡æœ‰å®šæ—¶å™¨æ³„æ¼è­¦å‘Š

## é™„å½•

### æµ‹è¯•çŽ¯å¢ƒ

- Flutter SDK: (ç‰ˆæœ¬ä»Žæ—¥å¿—ä¸­æŽ¨æ–­)
- Dart SDK: >=3.0.0 <4.0.0
- æµ‹è¯•æ¡†æž¶: flutter_test
- Mockæ¡†æž¶: mockito

### ç›¸å…³æ–‡ä»¶

- `lib/widgets/hybrid_media_widget.dart` - æ··åˆåª’ä½“ç»„ä»¶
- `lib/widgets/scene_image_preview.dart` - åœºæ™¯æ’å›¾é¢„è§ˆ
- `lib/widgets/paragraph_widget.dart` - æ®µè½ç»„ä»¶
- `lib/utils/image_cache_manager.dart` - å›¾ç‰‡ç¼“å­˜ç®¡ç†å™¨
- `lib/utils/media_markup_parser.dart` - åª’ä½“æ ‡è®°è§£æžå™¨
- `lib/services/api_service_wrapper.dart` - APIæœåŠ¡åŒ…è£…å™¨

### æµ‹è¯•è¦†ç›–çŽ‡

- å•å…ƒæµ‹è¯•: âœ… è¦†ç›–
- Widgetæµ‹è¯•: âš ï¸ éƒ¨åˆ†è¦†ç›–
- é›†æˆæµ‹è¯•: âŒ æœªè¦†ç›–

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-03
**æŠ¥å‘Šç”Ÿæˆè€…**: Claude Code
**æµ‹è¯•æ–‡ä»¶**: `test/unit/illustration_loading_test.dart`
