# 批量测试修复计划

## 当前状态
- 通过: 580
- 跳过: 21
- 失败: 73
- 目标: 失败 < 30

## 失败测试分析

### 1. 数据库锁定问题 (约35个)
**问题**: SQLite数据库被锁定
**原因**: 测试间未正确清理，并发访问
**修复策略**:
- 为每个测试文件添加 setUp/tearDown
- 确保每个测试使用独立的数据库文件
- 添加测试隔离机制

### 2. ApiServiceWrapper未初始化 (约20个)
**问题**: "尝试使用空实例调用ApiServiceWrapper"
**原因**: 测试前未初始化服务
**修复策略**:
- 添加测试基类的初始化方法
- 为依赖ApiService的测试添加setUp
- 使用Mock替代真实服务

### 3. 超时问题 (约10个)
**问题**: 测试超时 (10秒)
**原因**: 异步操作未正确等待
**修复策略**:
- 添加明确的await
- 使用tester.pumpAndSettle()
- 设置合理的超时时间

### 4. Widget查找失败 (约8个)
**问题**: 找不到预期的Widget
**原因**: UI结构变化或Key配置错误
**修复策略**:
- 更新Widget查找策略
- 使用更宽松的匹配条件
- 添加fallback查找逻辑

## 修复优先级

### P0 - 快速修复 (预期修复30+个)
1. 所有数据库锁定问题 - 添加setUp/tearDown
2. ApiServiceWrapper未初始化 - 添加测试初始化
3. 简单的异步等待问题 - 添加pumpAndSettle

### P1 - 中等修复 (预期修复15+个)
1. Widget查找问题 - 更新查找逻辑
2. 超时问题 - 优化异步处理
3. Mock配置问题 - 完善Mock设置

### P2 - 复杂修复 (跳过或标记)
1. 需要大量重构的测试
2. 集成测试的复杂场景
3. 依赖外部服务的测试

## 执行计划

1. 创建测试基类工具
2. 批量修复数据库测试
3. 批量修复服务测试
4. 批量修复UI测试
5. 运行完整测试验证
6. 生成修复报告

## 成功标准
- 失败数: < 30
- 通过率: > 94%
- 无新增失败
