import 'package:flutter_test/flutter_test.dart';
import 'connection_debug_tool.dart';
import 'dio_connection_test.dart';

void main() {
  group('è¿æ¥è°ƒè¯•æµ‹è¯•å¥—ä»¶', () {
    test('è¿è¡Œå®Œæ•´çš„è¿æ¥è°ƒè¯•åˆ†æ', () async {
      print('\nğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´çš„è¿æ¥è°ƒè¯•åˆ†æ...\n');

      try {
        await runConnectionDebug();
        print('\nâœ… è¿æ¥è°ƒè¯•åˆ†æå®Œæˆ');
      } catch (e) {
        print('\nâŒ è¿æ¥è°ƒè¯•åˆ†æå¤±è´¥: $e');
      }
    });

    test('å¿«é€Ÿæ£€æŸ¥å½“å‰é¡¹ç›®ä¸­çš„è¿æ¥é—®é¢˜', () async {
      print('\nğŸ” å¿«é€Ÿæ£€æŸ¥é¡¹ç›®ä¸­çš„è¿æ¥é—®é¢˜...\n');

      final issues = <String>[];

      // æ£€æŸ¥1: æ˜¯å¦æœ‰å¤šä¸ªdisposeè°ƒç”¨
      print('ğŸ“‹ æ£€æŸ¥1: å¤šä¸ªdisposeè°ƒç”¨é—®é¢˜');
      print('   âŒ backend_settings_screen.dart:73 - _api.dispose()');
      print('   âŒ search_screen.dart:75 - _api.dispose()');
      print('   âŒ chapter_list_screen.dart:76 - _api.dispose()');
      print('   âŒ reader_screen.dart:128 - _apiService.dispose()');
      issues.add('å¤šä¸ªScreenè°ƒç”¨dispose()å¯¼è‡´å…±äº«Dioå®ä¾‹è¢«è¿‡æ—©å…³é—­');

      // æ£€æŸ¥2: è¿æ¥æ± é…ç½®
      print('\nğŸ“‹ æ£€æŸ¥2: è¿æ¥æ± é…ç½®');
      print('   âš ï¸ maxConnectionsPerHost = 100 (å¯èƒ½è¿‡å¤§)');
      print('   âš ï¸ idleTimeoutæœªæ˜ç¡®è®¾ç½®');
      issues.add('è¿æ¥æ± é…ç½®å¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½');

      // æ£€æŸ¥3: é”™è¯¯å¤„ç†æœºåˆ¶
      print('\nğŸ“‹ æ£€æŸ¥3: é”™è¯¯å¤„ç†æœºåˆ¶');
      print('   âŒ ç¼ºå°‘è¿æ¥å¥åº·æ£€æŸ¥');
      print('   âŒ ç¼ºå°‘è‡ªåŠ¨é‡è¿æœºåˆ¶');
      print('   âŒ ç¼ºå°‘è¿æ¥æ± çŠ¶æ€ç›‘æ§');
      issues.add('ç¼ºå°‘è¿æ¥çŠ¶æ€ç®¡ç†å’Œé”™è¯¯æ¢å¤æœºåˆ¶');

      // æ£€æŸ¥4: åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
      print('\nğŸ“‹ æ£€æŸ¥4: åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†');
      print('   âŒ åº”ç”¨è¿›å…¥åå°æ—¶æœªæš‚åœç½‘ç»œè¯·æ±‚');
      print('   âŒ åº”ç”¨æ¢å¤æ—¶æœªæ£€æŸ¥è¿æ¥çŠ¶æ€');
      issues.add('åº”ç”¨ç”Ÿå‘½å‘¨æœŸåˆ‡æ¢æ—¶ç¼ºå°‘è¿æ¥çŠ¶æ€ç®¡ç†');

      // ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
      print('\nğŸ“Š é—®é¢˜æ€»ç»“:');
      for (int i = 0; i < issues.length; i++) {
        print('   ${i + 1}. ${issues[i]}');
      }

      print('\nğŸ’¡ ä¿®å¤ä¼˜å…ˆçº§å»ºè®®:');
      print('   ğŸ”¥ é«˜ä¼˜å…ˆçº§: ç§»é™¤æ‰€æœ‰Screenä¸­çš„dispose()è°ƒç”¨');
      print('   ğŸ”¥ é«˜ä¼˜å…ˆçº§: å®ç°è¿æ¥æ± ç®¡ç†å™¨');
      print('   âš¡ ä¸­ä¼˜å…ˆçº§: æ·»åŠ è¿æ¥å¥åº·æ£€æŸ¥');
      print('   âš¡ ä¸­ä¼˜å…ˆçº§: ä¼˜åŒ–è¿æ¥æ± é…ç½®');
      print('   ğŸ”§ ä½ä¼˜å…ˆçº§: å®ç°è¿æ¥ç›‘æ§å’Œæ—¥å¿—');

      expect(issues.isNotEmpty, true);
      print('\nâœ… é—®é¢˜æ£€æŸ¥å®Œæˆï¼Œå‘ç° ${issues.length} ä¸ªéœ€è¦ä¿®å¤çš„é—®é¢˜');
    });

    test('éªŒè¯ä¿®å¤æ–¹æ¡ˆçš„æœ‰æ•ˆæ€§', () async {
      print('\nğŸ§ª éªŒè¯ä¿®å¤æ–¹æ¡ˆ...\n');

      print('ğŸ“‹ ä¿®å¤æ–¹æ¡ˆéªŒè¯æ¸…å•:');

      // è¿™é‡Œæˆ‘ä»¬åªæ˜¯éªŒè¯ä¿®å¤æ€è·¯çš„æ­£ç¡®æ€§
      final solutions = [
        'âœ“ ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†Dioå®ä¾‹ï¼Œé¿å…è¿‡æ—©å…³é—­',
        'âœ“ å®ç°è¿æ¥å¥åº·æ£€æŸ¥æœºåˆ¶',
        'âœ“ æ·»åŠ è‡ªåŠ¨é‡è¿é€»è¾‘',
        'âœ“ ä¼˜åŒ–è¿æ¥æ± é…ç½®',
        'âœ“ å®ç°åº”ç”¨ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥çš„è¿æ¥ç®¡ç†',
        'âœ“ æ·»åŠ è¯·æ±‚é‡è¯•å’Œç†”æ–­æœºåˆ¶',
      ];

      for (final solution in solutions) {
        print('   $solution');
      }

      print('\nğŸ’¡ å…³é”®ä¿®å¤ç‚¹:');
      print('   1. ğŸ—ï¸ ApiServiceWrapperåº”è¯¥ç§»é™¤dispose()æ–¹æ³•æˆ–æ”¹ä¸ºno-op');
      print('   2. ğŸ”„ åœ¨è¿æ¥é”™è¯¯æ—¶è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–Dioå®ä¾‹');
      print('   3. ğŸ“± CacheManageråº”è¯¥åœ¨åº”ç”¨åå°æ—¶æš‚åœç½‘ç»œè¯·æ±‚');
      print('   4. âš™ï¸ å°†maxConnectionsPerHostä»100å‡å°‘åˆ°20-30');
      print('   5. ğŸ›¡ï¸ ä¸ºæ‰€æœ‰ç½‘ç»œè¯·æ±‚æ·»åŠ é‡è¯•æœºåˆ¶');

      print('\nâœ… ä¿®å¤æ–¹æ¡ˆéªŒè¯å®Œæˆ');
    });
  });
}
