"""add_scene_illustration_tables

Revision ID: aba3a21b25b4
Revises: 033cfcda6ad9
Create Date: 2025-12-14 14:19:30.922873

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = 'aba3a21b25b4'
down_revision = '033cfcda6ad9'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_role_card_tasks_id'), table_name='role_card_tasks')
    op.drop_index(op.f('ix_role_card_tasks_role_id'), table_name='role_card_tasks')
    op.drop_table('role_card_tasks')
    op.drop_index(op.f('ix_chapter_illustrations_chapter_id'), table_name='chapter_illustrations')
    op.drop_index(op.f('ix_chapter_illustrations_chapter_id_unique'), table_name='chapter_illustrations')
    op.drop_index(op.f('ix_chapter_illustrations_id'), table_name='chapter_illustrations')
    op.drop_table('chapter_illustrations')
    op.drop_index(op.f('ix_role_image_gallery_id'), table_name='role_image_gallery')
    op.drop_index(op.f('ix_role_image_gallery_role_id'), table_name='role_image_gallery')
    op.drop_table('role_image_gallery')
    op.drop_index(op.f('idx_novel_url'), table_name='novel_chapters_cache')
    op.drop_index(op.f('idx_task_chapter'), table_name='novel_chapters_cache')
    op.drop_index(op.f('ix_novel_chapters_cache_chapter_index'), table_name='novel_chapters_cache')
    op.drop_index(op.f('ix_novel_chapters_cache_id'), table_name='novel_chapters_cache')
    op.drop_index(op.f('ix_novel_chapters_cache_task_id'), table_name='novel_chapters_cache')
    op.drop_table('novel_chapters_cache')
    op.drop_index(op.f('idx_novel_url_status'), table_name='novel_cache_tasks')
    op.drop_index(op.f('idx_status_created'), table_name='novel_cache_tasks')
    op.drop_index(op.f('ix_novel_cache_tasks_id'), table_name='novel_cache_tasks')
    op.drop_index(op.f('ix_novel_cache_tasks_novel_url'), table_name='novel_cache_tasks')
    op.drop_index(op.f('ix_novel_cache_tasks_status'), table_name='novel_cache_tasks')
    op.drop_table('novel_cache_tasks')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('novel_cache_tasks',
    sa.Column('id', sa.INTEGER(), server_default=sa.text("nextval('novel_cache_tasks_id_seq'::regclass)"), autoincrement=True, nullable=False),
    sa.Column('novel_url', sa.VARCHAR(length=500), autoincrement=False, nullable=False),
    sa.Column('novel_title', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('novel_author', sa.VARCHAR(length=200), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(length=20), autoincrement=False, nullable=True),
    sa.Column('total_chapters', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('cached_chapters', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('failed_chapters', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('completed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name='novel_cache_tasks_pkey'),
    postgresql_ignore_search_path=False
    )
    op.create_index(op.f('ix_novel_cache_tasks_status'), 'novel_cache_tasks', ['status'], unique=False)
    op.create_index(op.f('ix_novel_cache_tasks_novel_url'), 'novel_cache_tasks', ['novel_url'], unique=False)
    op.create_index(op.f('ix_novel_cache_tasks_id'), 'novel_cache_tasks', ['id'], unique=False)
    op.create_index(op.f('idx_status_created'), 'novel_cache_tasks', ['status', 'created_at'], unique=False)
    op.create_index(op.f('idx_novel_url_status'), 'novel_cache_tasks', ['novel_url', 'status'], unique=False)
    op.create_table('novel_chapters_cache',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False),
    sa.Column('task_id', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('chapter_index', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('chapter_title', sa.VARCHAR(length=500), autoincrement=False, nullable=False),
    sa.Column('chapter_content', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('chapter_url', sa.VARCHAR(length=1000), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('novel_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('word_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('cached_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('retry_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['task_id'], ['novel_cache_tasks.id'], name=op.f('novel_chapters_cache_task_id_fkey')),
    sa.PrimaryKeyConstraint('id', name=op.f('novel_chapters_cache_pkey'))
    )
    op.create_index(op.f('ix_novel_chapters_cache_task_id'), 'novel_chapters_cache', ['task_id'], unique=False)
    op.create_index(op.f('ix_novel_chapters_cache_id'), 'novel_chapters_cache', ['id'], unique=False)
    op.create_index(op.f('ix_novel_chapters_cache_chapter_index'), 'novel_chapters_cache', ['chapter_index'], unique=False)
    op.create_index(op.f('idx_task_chapter'), 'novel_chapters_cache', ['task_id', 'chapter_index'], unique=False)
    op.create_index(op.f('idx_novel_url'), 'novel_chapters_cache', ['novel_url'], unique=False)
    op.create_table('role_image_gallery',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False, comment='主键ID'),
    sa.Column('role_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False, comment='人物卡ID'),
    sa.Column('img_url', sa.VARCHAR(length=500), autoincrement=False, nullable=False, comment='图片URL（文件名）'),
    sa.Column('prompt', sa.TEXT(), autoincrement=False, nullable=False, comment='生成图片的提示词'),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True, comment='创建时间'),
    sa.PrimaryKeyConstraint('id', name=op.f('role_image_gallery_pkey')),
    sa.UniqueConstraint('role_id', 'img_url', name=op.f('unique_role_img'), postgresql_include=[], postgresql_nulls_not_distinct=False)
    )
    op.create_index(op.f('ix_role_image_gallery_role_id'), 'role_image_gallery', ['role_id'], unique=False)
    op.create_index(op.f('ix_role_image_gallery_id'), 'role_image_gallery', ['id'], unique=False)
    op.create_table('chapter_illustrations',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False, comment='主键ID'),
    sa.Column('chapter_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False, comment='章节ID'),
    sa.Column('status', sa.VARCHAR(length=50), autoincrement=False, nullable=False, comment='任务状态'),
    sa.Column('total_images', sa.INTEGER(), autoincrement=False, nullable=True, comment='需要生成的图片总数'),
    sa.Column('completed_images', sa.INTEGER(), autoincrement=False, nullable=True, comment='已完成的图片数量'),
    sa.Column('novel_content', sa.TEXT(), autoincrement=False, nullable=True, comment='小说内容'),
    sa.Column('roles', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True, comment='角色信息'),
    sa.Column('require', sa.TEXT(), autoincrement=False, nullable=True, comment='配图要求'),
    sa.Column('image_data', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True, comment='图片生成结果数据'),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=True, comment='错误信息'),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True, comment='创建时间'),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True, comment='更新时间'),
    sa.Column('completed_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True, comment='完成时间'),
    sa.PrimaryKeyConstraint('id', name=op.f('chapter_illustrations_pkey')),
    sa.UniqueConstraint('chapter_id', name=op.f('chapter_illustrations_chapter_id_key'), postgresql_include=[], postgresql_nulls_not_distinct=False)
    )
    op.create_index(op.f('ix_chapter_illustrations_id'), 'chapter_illustrations', ['id'], unique=False)
    op.create_index(op.f('ix_chapter_illustrations_chapter_id_unique'), 'chapter_illustrations', ['chapter_id'], unique=True)
    op.create_index(op.f('ix_chapter_illustrations_chapter_id'), 'chapter_illustrations', ['chapter_id'], unique=False)
    op.create_table('role_card_tasks',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False),
    sa.Column('role_id', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('status', sa.VARCHAR(length=20), server_default=sa.text("'pending'::character varying"), autoincrement=False, nullable=False),
    sa.Column('roles', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('user_input', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('total_prompts', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('generated_images', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('result_message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('started_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('completed_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('model', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name=op.f('role_card_tasks_pkey')),
    comment='人物卡图片生成任务表'
    )
    op.create_index(op.f('ix_role_card_tasks_role_id'), 'role_card_tasks', ['role_id'], unique=False)
    op.create_index(op.f('ix_role_card_tasks_id'), 'role_card_tasks', ['id'], unique=False)
    # ### end Alembic commands ###